<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EchoCoach Management</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js" defer></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap');
        body { font-family: 'Inter', sans-serif; }
        [x-cloak] { display: none !important; }
        .ai-gradient {
            background: linear-gradient(45deg, #4f46e5, #9333ea, #ec4899);
            background-size: 200% 200%;
            animation: gradient 3s ease infinite;
        }
        @keyframes gradient { 0% { background-position: 0% 50%; } 50% { background-position: 100% 50%; } 100% { background-position: 0% 50%; } }
        
        /* Custom Scrollbar for lists */
        .custom-scroll::-webkit-scrollbar { width: 6px; }
        .custom-scroll::-webkit-scrollbar-track { background: #f1f1f1; }
        .custom-scroll::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }
        .custom-scroll::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
    </style>
</head>
<!-- 
    APP STATE:
    currentTab: 'users' | 'modules' | 'testbank' | 'abel'
    showModal: Controls which modal is open
    editItem: Temporary storage for editing
    viewUser: Temporary storage for viewing stats
    moduleQuestions: Local array to store module questions for this session
-->
<body class="bg-gray-100" x-data="{ 
    currentTab: new URLSearchParams(window.location.search).get('tab') || 'users', 
    showModal: false, 
    editItem: {}, 
    viewUser: {},
    moduleView: 'list', 
    selectedUser: null,
    selectedModuleData: null,
    activeSkill: null,
    currentModuleIndex: 0,
    currentWritingTaskIndex: 0,
    currentSpeakingPart: 1,
    currentSpeakingQuestion: 1,
    currentReadingQuestionIndex: 0,
    currentListeningQuestionIndex: 0,
    previewImage: null,
    usersList: [],
    createdAtSortOrder: null,
    modulesList: [],
    statusSortOrder: null,
    assessmentCenterOpen: true,
    moduleQuestions: [ // Dummy data for Module Test Bank
        { id: 1, description: 'Describe the image below.', image: 'https://placehold.co/300x200?text=Sample+Image' },
        { id: 2, description: 'What is happening in this scene?', image: null }
    ],
    getLevelClass(level) {
        if (!level) return 'bg-gray-100 text-gray-800';
        if (level === 'Beginner') return 'bg-green-100 text-green-800';
        if (level === 'Pre-Intermediate') return 'bg-blue-100 text-blue-800';
        if (level === 'Intermediate') return 'bg-yellow-100 text-yellow-800';
        if (level === 'Advanced') return 'bg-purple-100 text-purple-800';
        return 'bg-gray-100 text-gray-800';
    },
    handleFileUpload(event) {
        const file = event.target.files[0];
        if (file) {
            this.previewImage = URL.createObjectURL(file);
        }
    },
    addModuleQuestion() {
        const desc = document.getElementById('mq-desc').value;
        this.moduleQuestions.push({
            id: Date.now(),
            description: desc,
            image: this.previewImage
        });
        this.showModal = false;
        this.previewImage = null;
        document.getElementById('mq-desc').value = ''; 
    },
    deleteModuleQuestion(id) {
        if(confirm('Delete this question?')) {
            this.moduleQuestions = this.moduleQuestions.filter(q => q.id !== id);
        }
    },
    openEditModuleQuestion(q) {
        this.editItem = JSON.parse(JSON.stringify(q)); // Deep copy
        this.previewImage = q.image;
        this.showModal = 'editModuleQuestion';
    },
    updateModuleQuestion() {
        const index = this.moduleQuestions.findIndex(q => q.id === this.editItem.id);
        if (index !== -1) {
            this.moduleQuestions[index] = {
                ...this.moduleQuestions[index],
                description: this.editItem.description,
                image: this.previewImage
            };
        }
        this.showModal = false;
        this.previewImage = null;
        this.editItem = {};
    },
    getSpeakingQuestion(part, question) {
        const mockQuestions = {
            1: {
                1: 'Tell me about your hometown.',
                2: 'What do you like most about your job or studies?'
            },
            2: {
                1: 'Describe a place you would like to visit. You should say: where it is, what you would do there, and why you want to visit it.',
                2: 'Talk about a memorable event in your life. You should say: when it happened, what you did, and why it was memorable.'
            },
            3: {
                1: 'Do you think tourism has a positive or negative impact on local communities?',
                2: 'How do you think technology has changed the way people travel?'
            }
        };
        return mockQuestions[part]?.[question] || 'No question available.';
    },
    getCurrentSpeakingQuestion() {
        if (!this.selectedModuleData?.content?.speaking) {
            return this.getSpeakingQuestion(this.currentSpeakingPart, this.currentSpeakingQuestion);
        }
        const partKey = 'part' + this.currentSpeakingPart;
        const questionKey = 'question' + this.currentSpeakingQuestion;
        const question = this.selectedModuleData?.content?.speaking?.parts?.[partKey]?.[questionKey];
        return question || this.getSpeakingQuestion(this.currentSpeakingPart, this.currentSpeakingQuestion);
    },
    getSpeakingPartTitle() {
        const titles = {
            1: 'Part 1: Introduction and Interview',
            2: 'Part 2: Long Turn',
            3: 'Part 3: Discussion'
        };
        return titles[this.currentSpeakingPart] || 'Part 1: Introduction and Interview';
    },
    initializeMockData(skill) {
        if (!this.selectedModuleData) return;
        
        if (!this.selectedModuleData.content) {
            this.selectedModuleData.content = {};
        }
        
        // Initialize Writing mock data with multiple tasks
        if (skill === 'writing' && !this.selectedModuleData.content.writing?.tasks) {
            this.selectedModuleData.content.writing = {
                tasks: [
                    {
                        image: 'https://placehold.co/600x400?text=Writing+Task+1',
                        description: 'The chart below shows the percentage of households in owned and rented accommodation in England and Wales between 1918 and 2011. Summarize the information by selecting and reporting the main features, and make comparisons where relevant.'
                    },
                    {
                        image: 'https://placehold.co/600x400?text=Writing+Task+2',
                        description: 'Some people think that it is better to educate boys and girls in separate schools. Others, however, believe that boys and girls benefit more from attending mixed schools. Discuss both views and give your own opinion.'
                    },
                    {
                        image: 'https://placehold.co/600x400?text=Writing+Task+3',
                        description: 'You should spend about 20 minutes on this task. The graph below shows the proportion of the population aged 65 and over between 1940 and 2040 in three different countries. Summarize the information by selecting and reporting the main features, and make comparisons where relevant.'
                    }
                ]
            };
        }
        
        // Initialize Reading mock data with multiple questions
        if (skill === 'reading' && !this.selectedModuleData.content.reading?.questions) {
            this.selectedModuleData.content.reading = {
                questions: [
                    {
                        question: 'What is the main idea of the passage?',
                        options: [
                            'A. The importance of reading comprehension',
                            'B. Strategies for improving vocabulary',
                            'C. The history of literature',
                            'D. Techniques for speed reading'
                        ],
                        correctAnswer: 1
                    },
                    {
                        question: 'According to the passage, what is the primary benefit of regular reading?',
                        options: [
                            'A. Improved memory retention',
                            'B. Enhanced critical thinking skills',
                            'C. Better time management',
                            'D. Increased social connections'
                        ],
                        correctAnswer: 2
                    },
                    {
                        question: 'What does the author suggest about reading habits?',
                        options: [
                            'A. Reading should be done only in the morning',
                            'B. Consistency is more important than quantity',
                            'C. Digital books are less effective than print',
                            'D. Reading fiction is more beneficial than non-fiction'
                        ],
                        correctAnswer: 2
                    }
                ]
            };
        }
        
        // Initialize Listening mock data with multiple questions
        if (skill === 'listening' && !this.selectedModuleData.content.listening?.questions) {
            this.selectedModuleData.content.listening = {
                speakerAccent: 'British English',
                speaker1: 'Hello, I would like to book a table for two at 7 PM tonight.',
                speaker2: 'Of course! Let me check our availability. Yes, we have a table available at that time.',
                questions: [
                    {
                        question: 'What is the main topic of the conversation?',
                        options: [
                            'A. Booking a restaurant table',
                            'B. Making a hotel reservation',
                            'C. Ordering food delivery',
                            'D. Canceling a reservation'
                        ],
                        correctAnswer: 1
                    },
                    {
                        question: 'What time does the customer want to book?',
                        options: [
                            'A. 6 PM',
                            'B. 7 PM',
                            'C. 8 PM',
                            'D. 9 PM'
                        ],
                        correctAnswer: 2
                    },
                    {
                        question: 'How many people will be dining?',
                        options: [
                            'A. One',
                            'B. Two',
                            'C. Three',
                            'D. Four'
                        ],
                        correctAnswer: 2
                    }
                ]
            };
        }
        
        // Initialize Speaking mock data structure
        if (skill === 'speaking' && !this.selectedModuleData.content.speaking?.parts) {
            this.selectedModuleData.content.speaking = {
                parts: {
                    part1: {
                        question1: 'Tell me about your hometown.',
                        question2: 'What do you like most about your job or studies?'
                    },
                    part2: {
                        question1: 'Describe a place you would like to visit. You should say: where it is, what you would do there, and why you want to visit it.',
                        question2: 'Talk about a memorable event in your life. You should say: when it happened, what you did, and why it was memorable.'
                    },
                    part3: {
                        question1: 'Do you think tourism has a positive or negative impact on local communities?',
                        question2: 'How do you think technology has changed the way people travel?'
                    }
                }
            };
        }
    },
    initUsers() {
        const usersDataElement = document.getElementById('users-data');
        if (usersDataElement) {
            this.usersList = JSON.parse(usersDataElement.textContent) || [];
        }
    },
    sortByCreatedAt() {
        if (this.createdAtSortOrder === 'asc') {
            this.createdAtSortOrder = 'desc';
        } else if (this.createdAtSortOrder === 'desc') {
            this.createdAtSortOrder = null;
        } else {
            this.createdAtSortOrder = 'asc';
        }
        
        if (this.createdAtSortOrder === null) {
            this.initUsers();
            return;
        }
        
        this.usersList.sort((a, b) => {
            const dateA = a.createdAt ? new Date(a.createdAt).getTime() : 0;
            const dateB = b.createdAt ? new Date(b.createdAt).getTime() : 0;
            
            if (this.createdAtSortOrder === 'asc') {
                return dateA - dateB;
            } else {
                return dateB - dateA;
            }
        });
    },
    initModules() {
        const modulesDataElement = document.getElementById('modules-data');
        if (modulesDataElement) {
            this.modulesList = JSON.parse(modulesDataElement.textContent) || [];
        }
    },
    sortByStatus() {
        if (this.statusSortOrder === 'asc') {
            this.statusSortOrder = 'desc';
        } else if (this.statusSortOrder === 'desc') {
            this.statusSortOrder = null;
        } else {
            this.statusSortOrder = 'asc';
        }
        
        if (this.statusSortOrder === null) {
            this.initModules();
            return;
        }
        
        this.modulesList.sort((a, b) => {
            const statusA = (a.status === 'Pending' || a.status === 'Pending Validation') ? 'Pending' : 'Validated';
            const statusB = (b.status === 'Pending' || b.status === 'Pending Validation') ? 'Pending' : 'Validated';
            
            // Sort: Pending comes before Validated
            const orderA = statusA === 'Pending' ? 0 : 1;
            const orderB = statusB === 'Pending' ? 0 : 1;
            
            if (this.statusSortOrder === 'asc') {
                return orderA - orderB;
            } else {
                return orderB - orderA;
            }
        });
    }
}">

    <!-- Users Data (hidden, for Alpine.js initialization) -->
    <script id="users-data" type="application/json"><%- JSON.stringify(users) %></script>
    
    <!-- Modules Data (hidden, for Alpine.js initialization) -->
    <script id="modules-data" type="application/json"><%- JSON.stringify(pendingModules) %></script>

    <!-- Top Navigation -->
    <nav class="bg-white shadow-sm border-b border-gray-200 fixed w-full z-30">
        <div class="px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between h-16">
                <div class="flex items-center gap-3">
                    <img src="/img/logo.png" alt="Logo" class="h-8 w-auto">
                    <span class="text-xl font-bold text-gray-800 border-l border-gray-300 pl-3 ml-3">Admin Portal</span>
                </div>
                <div class="flex items-center gap-4">
                    <a href="/" class="text-sm text-gray-600 hover:text-blue-600">View Live Site</a>
                    <span class="text-gray-300">|</span>
                    <a href="/logout" class="text-sm font-medium text-red-600 hover:text-red-800">Logout</a>
                    <div class="h-8 w-8 rounded-full bg-blue-100 flex items-center justify-center text-blue-700 font-bold">A</div>
                </div>
            </div>
        </div>
    </nav>

    <div class="flex h-screen pt-16">
        <!-- Sidebar -->
        <aside class="w-64 bg-white border-r border-gray-200 hidden md:block flex-shrink-0">
            <div class="p-4 space-y-1">
                <a href="/admin/dashboard" class="w-full flex items-center space-x-3 px-4 py-3 rounded-lg text-gray-600 hover:bg-gray-50 transition">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2V6zM14 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2V6zM4 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2v-2zM14 16a2 2 0 012-2h2a2 2 0 01-2 2h-2a2 2 0 01-2-2v-2z"></path></svg>
                    <span>Dashboard</span>
                </a>
                <div class="pt-4 pb-2 px-4 text-xs font-semibold text-gray-400 uppercase tracking-wider">Manage</div>
                <button @click="currentTab = 'users'" :class="currentTab === 'users' ? 'bg-blue-50 text-blue-700' : 'text-gray-600 hover:bg-gray-50'" class="w-full flex items-center space-x-3 px-4 py-3 rounded-lg font-medium transition">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M13 7a4 4 0 11-8 0 4 4 0 018 0z"></path></svg>
                    <span>Users</span>
                </button>
                <button @click="currentTab = 'modules'; moduleView = 'list'" :class="currentTab === 'modules' ? 'bg-blue-50 text-blue-700' : 'text-gray-600 hover:bg-gray-50'" class="w-full flex items-center space-x-3 px-4 py-3 rounded-lg font-medium transition">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10"></path></svg>
                    <span>Modules</span>
                </button>
                <div class="pt-4 pb-2 px-4">
                    <button @click="assessmentCenterOpen = !assessmentCenterOpen" class="w-full flex items-center justify-between text-xs font-semibold text-gray-400 uppercase tracking-wider hover:text-gray-600 transition">
                        <span>Assessment Center</span>
                        <svg class="w-4 h-4 transition-transform" :class="assessmentCenterOpen ? 'rotate-180' : ''" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                        </svg>
                    </button>
                </div>
                <div x-show="assessmentCenterOpen" x-transition:enter="transition ease-out duration-200" x-transition:enter-start="opacity-0 transform -translate-y-2" x-transition:enter-end="opacity-100 transform translate-y-0" x-transition:leave="transition ease-in duration-150" x-transition:leave-start="opacity-100 transform translate-y-0" x-transition:leave-end="opacity-0 transform -translate-y-2">
                    <button @click="currentTab = 'testbank'" :class="currentTab === 'testbank' ? 'bg-blue-50 text-blue-700' : 'text-gray-600 hover:bg-gray-50'" class="w-full flex items-center space-x-3 px-4 py-3 rounded-lg font-medium transition">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-3 7h3m-3 4h3m-6-4h.01M9 16h.01"></path></svg>
                        <span>General Test Bank</span>
                    </button>
                    <button @click="currentTab = 'moduletestbank'" :class="currentTab === 'moduletestbank' ? 'bg-blue-50 text-blue-700' : 'text-gray-600 hover:bg-gray-50'" class="w-full flex items-center space-x-3 px-4 py-3 rounded-lg font-medium transition">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7v8a2 2 0 002 2h6M8 7V5a2 2 0 012-2h4.586a1 1 0 01.707.293l4.414 4.414a1 1 0 01.293.707V15a2 2 0 01-2 2h-2M8 7H6a2 2 0 00-2 2v10a2 2 0 002 2h8a2 2 0 002-2v-2"></path></svg>
                        <span>Module Quiz Bank</span>
                    </button>
                    <button @click="currentTab = 'abel'" :class="currentTab === 'abel' ? 'bg-purple-50 text-purple-700' : 'text-gray-600 hover:bg-gray-50'" class="w-full flex items-center space-x-3 px-4 py-3 rounded-lg font-medium transition">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                        <span>ABEL Assessment</span>
                    </button>
                </div>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="flex-1 overflow-y-auto p-8">
            
            <!-- 1. USERS TAB -->
            <div x-show="currentTab === 'users'" x-transition.opacity x-init="initUsers()">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-2xl font-bold text-gray-800">User Management</h2>
                </div>
                <div class="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Name</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Level</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Pre-assessment Result</th>
                                <th 
                                    @click="sortByCreatedAt()"
                                    class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer hover:bg-gray-100 transition flex items-center gap-1"
                                >
                                    Created at
                                    <span class="ml-1">
                                        <template x-if="createdAtSortOrder === 'asc'">
                                            <svg class="w-4 h-4 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 15l7-7 7 7"></path>
                                            </svg>
                                        </template>
                                        <template x-if="createdAtSortOrder === 'desc'">
                                            <svg class="w-4 h-4 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                                            </svg>
                                        </template>
                                        <template x-if="!createdAtSortOrder">
                                            <svg class="w-4 h-4 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16V4m0 0L3 8m4-4l4 4m6 0v12m0 0l4-4m-4 4l-4-4"></path>
                                            </svg>
                                        </template>
                                    </span>
                                </th>
                                <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                            </tr>
                        </thead>
                        <tbody class="bg-white divide-y divide-gray-200">
                            <template x-for="user in usersList" :key="user.id">
                                <tr 
                                    :data-user="JSON.stringify(user)"
                                    class="hover:bg-gray-50 transition group"
                                >
                                    <td class="px-6 py-4">
                                        <div class="flex items-center gap-3">
                                            <template x-if="user.photoURL">
                                                <img 
                                                    :src="user.photoURL" 
                                                    :alt="user.name" 
                                                    class="w-10 h-10 rounded-full object-cover cursor-pointer hover:ring-2 hover:ring-blue-500 transition"
                                                    @click="window.open(user.photoURL, '_blank')"
                                                >
                                            </template>
                                            <template x-if="!user.photoURL">
                                                <div class="w-10 h-10 rounded-full bg-gray-200 flex items-center justify-center text-gray-500 font-semibold">
                                                    <span x-text="user.name ? user.name.charAt(0).toUpperCase() : 'U'"></span>
                                                </div>
                                            </template>
                                            <div>
                                                <div class="text-sm font-medium text-gray-900" x-text="user.name"></div>
                                                <div class="text-sm text-gray-500" x-text="user.email"></div>
                                            </div>
                                        </div>
                                    </td>
                                    <td class="px-6 py-4 whitespace-nowrap">
                                        <span 
                                            :data-user="JSON.stringify(user)"
                                            @click="showModal = 'viewStats'; viewUser = JSON.parse($el.dataset.user)"
                                            class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full cursor-pointer hover:opacity-80 transition" 
                                            :class="getLevelClass(user.level)"
                                            x-text="user.level || 'Not Set'"
                                        ></span>
                                    </td>
                                    <td class="px-6 py-4 whitespace-nowrap">
                                        <div 
                                            :data-user="JSON.stringify(user)"
                                            @click="showModal = 'viewStats'; viewUser = JSON.parse($el.dataset.user)"
                                            class="inline-flex items-center gap-1 px-3 py-1.5 bg-yellow-100 rounded-full cursor-pointer hover:bg-yellow-200 transition"
                                        >
                                            <span class="text-sm font-semibold text-gray-800" x-text="(user.preAssessmentResult || 100) + '%'"></span>
                                            <svg class="w-4 h-4 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                                            </svg>
                                        </div>
                                    </td>
                                    <td class="px-6 py-4 whitespace-nowrap">
                                        <div class="text-sm text-gray-500" x-text="user.createdAt ? new Date(user.createdAt).toLocaleDateString('en-US', { year: 'numeric', month: 'short', day: 'numeric' }) : 'Not available'"></div>
                                        <div class="text-xs text-gray-400">Account Creation</div>
                                    </td>
                                    <td class="px-6 py-4 text-right text-sm font-medium">
                                        <div class="flex justify-end space-x-3">
                                            <button 
                                                :data-user="JSON.stringify(user)"
                                                @click.stop="showModal = 'editUser'; editItem = JSON.parse($el.dataset.user)" 
                                                class="text-blue-600 hover:text-blue-900 bg-gray-100 p-2 rounded-full hover:bg-blue-100 transition">
                                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z" /></svg>
                                            </button>
                                            <form action="/admin/delete-user" method="POST" onsubmit="return confirm('Are you sure?');" @click.stop>
                                                <input type="hidden" name="id" :value="user.id">
                                                <button type="submit" class="text-red-600 hover:text-red-900 bg-gray-100 p-2 rounded-full hover:bg-red-100 transition">
                                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg>
                                                </button>
                                            </form>
                                        </div>
                                    </td>
                                </tr>
                            </template>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- 2. MODULE MANAGEMENT -->
            <div x-show="currentTab === 'modules'" x-cloak x-transition.opacity>
                
                <!-- A. LIST VIEW: Select User -->
                <div x-show="moduleView === 'list'" x-init="initModules()">
                    <div class="flex justify-between items-center mb-6">
                        <h2 class="text-2xl font-bold text-gray-800">Module Management</h2>
                    </div>
                    <div class="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Name</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Role</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Rank</th>
                                    <th 
                                        @click="sortByStatus()"
                                        class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer hover:bg-gray-100 transition flex items-center gap-1"
                                    >
                                        Status
                                        <span class="ml-1">
                                            <template x-if="statusSortOrder === 'asc'">
                                                <svg class="w-4 h-4 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 15l7-7 7 7"></path>
                                                </svg>
                                            </template>
                                            <template x-if="statusSortOrder === 'desc'">
                                                <svg class="w-4 h-4 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                                                </svg>
                                            </template>
                                            <template x-if="!statusSortOrder">
                                                <svg class="w-4 h-4 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16V4m0 0L3 8m4-4l4 4m6 0v12m0 0l4-4m-4 4l-4-4"></path>
                                                </svg>
                                            </template>
                                        </span>
                                    </th>
                                    <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Action</th>
                                </tr>
                            </thead>
                            <tbody class="bg-white divide-y divide-gray-200">
                                <template x-for="item in modulesList" :key="item.id || item.userEmail">
                                    <tr 
                                        :data-item="JSON.stringify(item)"
                                        @click="moduleView = 'detail'; selectedUser = JSON.parse($el.dataset.item); currentModuleIndex = 0"
                                        class="hover:bg-gray-50 transition cursor-pointer group"
                                    >
                                        <td class="px-6 py-4">
                                            <div class="text-sm font-medium text-gray-900 group-hover:text-blue-600 transition" x-text="item.userName"></div>
                                            <div class="text-sm text-gray-500" x-text="item.userEmail"></div>
                                        </td>
                                        <td class="px-6 py-4 text-sm text-gray-500" x-text="item.userRole"></td>
                                        <td class="px-6 py-4 whitespace-nowrap">
                                            <span class="text-sm font-semibold text-gray-900" x-text="item.userRank"></span>
                                        </td>
                                        <td class="px-6 py-4">
                                            <template x-if="item.status === 'Pending' || item.status === 'Pending Validation'">
                                                <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-yellow-100 text-yellow-800">Pending</span>
                                            </template>
                                            <template x-if="item.status !== 'Pending' && item.status !== 'Pending Validation'">
                                                <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-800">Validated</span>
                                            </template>
                                        </td>
                                        <td class="px-6 py-4 text-right text-sm text-gray-400 group-hover:text-blue-600">
                                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 inline-block" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" /></svg>
                                        </td>
                                    </tr>
                                </template>
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- B. DETAIL VIEW: Selected User -> Module List -->
                <div x-show="moduleView === 'detail'" x-cloak class="h-full">
                    <div class="bg-white p-6 rounded-t-xl border-b border-gray-200 flex justify-between items-center">
                        <div class="flex items-center gap-4">
                            <button @click="moduleView = 'list'" class="text-gray-500 hover:text-gray-800 transition">
                                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"></path></svg>
                            </button>
                            <h2 class="text-xl font-bold text-gray-800 flex items-center">
                                <span x-text="selectedUser?.userName"></span> 
                                <span class="text-gray-400 mx-2">â€¢</span> 
                                <span class="px-2 py-0.5 rounded-full text-xs font-semibold" :class="getLevelClass(selectedUser?.userRank)" x-text="selectedUser?.userRank"></span>
                            </h2>
                        </div>
                        <div class="flex gap-3">
                            <button @click="showModal = 'moduleStats'" class="bg-blue-600 text-white px-5 py-2.5 rounded-lg shadow hover:bg-blue-700 transition text-sm font-semibold flex items-center gap-2">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path></svg>
                                View Stats
                            </button>
                        </div>
                    </div>

                    <div class="w-full bg-white rounded-b-xl shadow-sm border-x border-b border-gray-200 p-8" x-show="selectedUser?.modules?.length > 0">
                        <div class="flex justify-between items-center mb-8 border-b border-gray-100 pb-4">
                            <h3 class="font-bold text-gray-900 text-2xl" x-text="selectedUser?.modules[currentModuleIndex]?.title"></h3>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div @click="moduleView = 'content'; selectedModuleData = selectedUser?.modules[currentModuleIndex]; activeSkill = 'writing'; currentWritingTaskIndex = 0; initializeMockData('writing')" class="flex items-center gap-4 cursor-pointer group hover:bg-blue-50 p-4 rounded-xl transition border border-gray-100 hover:border-blue-200 bg-gray-50">
                                <div class="bg-blue-100 p-3 rounded-full text-blue-600"><svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path></svg></div>
                                <div><h4 class="font-bold text-gray-800 text-lg group-hover:text-blue-700 mb-1">Writing</h4><p class="text-sm text-gray-500">Develop coherent and well-structured responses</p></div>
                            </div>
                            <div @click="moduleView = 'content'; selectedModuleData = selectedUser?.modules[currentModuleIndex]; activeSkill = 'reading'; currentReadingQuestionIndex = 0; initializeMockData('reading')" class="flex items-center gap-4 cursor-pointer group hover:bg-blue-50 p-4 rounded-xl transition border border-gray-100 hover:border-blue-200 bg-gray-50">
                                <div class="bg-green-100 p-3 rounded-full text-green-600"><svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253"></path></svg></div>
                                <div><h4 class="font-bold text-gray-800 text-lg group-hover:text-blue-700">Reading</h4><p class="text-sm text-gray-500">Boost your comprehension and skimming skills</p></div>
                            </div>
                            <div @click="moduleView = 'content'; selectedModuleData = selectedUser?.modules[currentModuleIndex]; activeSkill = 'listening'; currentListeningQuestionIndex = 0; initializeMockData('listening')" class="flex items-center gap-4 cursor-pointer group hover:bg-blue-50 p-4 rounded-xl transition border border-gray-100 hover:border-blue-200 bg-gray-50">
                                <div class="bg-purple-100 p-3 rounded-full text-purple-600"><svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.536 8.464a5 5 0 010 7.072m2.828-9.9a9 9 0 010 12.728M5.586 15H4a1 1 0 01-1-1v-4a1 1 0 011-1h1.586l4.707-4.707C10.923 3.663 12 4.109 12 5v14c0 .891-1.077 1.337-1.707.707L5.586 15z"></path></svg></div>
                                <div><h4 class="font-bold text-gray-800 text-lg group-hover:text-blue-700">Listening</h4><p class="text-sm text-gray-500">Enhance your focus and audio understanding</p></div>
                            </div>
                            <div @click="moduleView = 'content'; selectedModuleData = selectedUser?.modules[currentModuleIndex]; activeSkill = 'speaking'; currentWritingTaskIndex = 0; currentSpeakingPart = 1; currentSpeakingQuestion = 1; initializeMockData('speaking')" class="flex items-center gap-4 cursor-pointer group hover:bg-blue-50 p-4 rounded-xl transition border border-gray-100 hover:border-blue-200 bg-gray-50">
                                <div class="bg-yellow-100 p-3 rounded-full text-yellow-600"><svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11a7 7 0 01-7 7m0 0a7 7 0 01-7-7m7 7v4m0 0H8m4 0h4m-4-8a3 3 0 01-3-3V5a3 3 0 116 0v6a3 3 0 01-3 3z"></path></svg></div>
                                <div><h4 class="font-bold text-gray-800 text-lg group-hover:text-blue-700">Speaking</h4><p class="text-sm text-gray-500">Build fluency, improve pronunciation, and speak with clarity</p></div>
                            </div>
                        </div>
                        <div class="flex justify-center items-center gap-4 mt-10 pt-6 border-t border-gray-100" x-show="selectedUser?.modules?.length > 1">
                            <button @click="if(currentModuleIndex > 0) currentModuleIndex--" :disabled="currentModuleIndex === 0" class="px-5 py-2.5 rounded-full border border-gray-300 hover:bg-gray-50 disabled:opacity-40 disabled:cursor-not-allowed flex items-center gap-2 text-gray-700 font-medium transition shadow-sm"><svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path></svg> Previous Module</button>
                            <span class="text-sm font-medium text-gray-900"><span x-text="currentModuleIndex + 1"></span> / <span x-text="selectedUser?.modules?.length"></span></span>
                            <button @click="if(currentModuleIndex < selectedUser?.modules?.length - 1) currentModuleIndex++" :disabled="currentModuleIndex === selectedUser?.modules?.length - 1" class="px-5 py-2.5 rounded-full bg-black text-white hover:bg-gray-800 disabled:bg-gray-300 disabled:cursor-not-allowed flex items-center gap-2 font-medium transition shadow-lg">Next Module <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path></svg></button>
                        </div>
                    </div>
                </div>

                <!-- C. CONTENT VIEW (Clean & Scrollable Card) -->
                <div x-show="moduleView === 'content'" x-cloak class="flex flex-col h-[calc(100vh-80px)]">
                    <div class="bg-white border-b py-4 px-6 flex justify-between items-center">
                        <div class="flex items-center gap-3">
                            <button @click="moduleView = 'detail'" class="text-gray-500 hover:text-gray-800 p-2 hover:bg-gray-100 rounded-full transition">
                                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"></path></svg>
                            </button>
                            <div><h2 class="text-2xl font-bold text-gray-900 capitalize" x-text="activeSkill"></h2><p class="text-sm text-gray-500" x-text="selectedModuleData?.title"></p></div>
                        </div>
                        <div class="flex gap-2">
                            <template x-if="selectedUser?.status !== 'Validated'">
                                <form action="/admin/validate-module" method="POST" class="inline">
                                    <input type="hidden" name="id" :value="selectedUser?.id">
                                    <button type="submit" class="bg-green-500 text-white px-5 py-2.5 rounded-lg shadow hover:bg-green-600 transition text-sm font-semibold flex items-center gap-2">
                                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg>
                                        Validate
                                    </button>
                                </form>
                            </template>
                            <template x-if="selectedUser?.status === 'Validated'">
                                <button disabled class="bg-gray-100 text-gray-400 px-5 py-2.5 rounded-lg border border-gray-200 cursor-not-allowed text-sm font-semibold flex items-center gap-2">
                                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg>
                                    Validated
                                </button>
                            </template>
                            <form action="/admin/regenerate-module" method="POST" class="inline"><button type="submit" class="bg-purple-600 text-white px-5 py-2.5 rounded-lg shadow hover:bg-purple-700 transition text-sm font-semibold flex items-center gap-2"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path></svg>Regenerate Content</button></form>
                        </div>
                    </div>
                    <!-- Clean Card Content Area -->
                    <div class="flex-1 p-8 flex justify-center bg-gray-50 overflow-y-auto">
                        <!-- Left: Editor Placeholder -->
                        <div class="flex-1 bg-white border rounded-xl p-8 shadow-sm flex flex-col border-dashed border-gray-300 mr-8 max-w-xl">
                             <template x-if="activeSkill === 'listening'">
                                 <div class="space-y-6">
                                     <div>
                                         <label class="block text-sm font-medium text-gray-700 mb-2">Speaker Accent</label>
                                         <div class="px-4 py-3 bg-gray-50 border border-gray-200 rounded-lg">
                                             <p class="text-sm text-gray-800 font-medium" x-text="selectedModuleData?.content?.listening?.speakerAccent || 'British English'"></p>
                                         </div>
                                     </div>
                                     <div>
                                         <label class="block text-sm font-medium text-gray-700 mb-2">Speaker 1</label>
                                         <div class="px-4 py-3 bg-gray-50 border border-gray-200 rounded-lg">
                                             <p class="text-sm text-gray-600 leading-relaxed" x-text="selectedModuleData?.content?.listening?.speaker1 || 'Hello, I would like to book a table for two at 7 PM tonight.'"></p>
                                         </div>
                                     </div>
                                     <div>
                                         <label class="block text-sm font-medium text-gray-700 mb-2">Speaker 2</label>
                                         <div class="px-4 py-3 bg-gray-50 border border-gray-200 rounded-lg">
                                             <p class="text-sm text-gray-600 leading-relaxed" x-text="selectedModuleData?.content?.listening?.speaker2 || 'Of course! Let me check our availability. Yes, we have a table available at that time.'"></p>
                                         </div>
                                     </div>
                                 </div>
                             </template>
                             <template x-if="activeSkill !== 'listening'">
                                 <div class="flex flex-col items-center justify-center w-full h-full">
                             <p class="text-gray-400 text-lg font-medium mb-2">Content Editor</p>
                             <p class="text-sm text-gray-500">Admin can edit the generated content here.</p>
                                 </div>
                             </template>
                        </div>

                        <!-- Right: Clean Preview Card (No Phone Style) -->
                        <div class="w-full max-w-md bg-white rounded-xl shadow-md border border-gray-200 flex flex-col h-fit overflow-hidden">
                            <div class="p-8">
                                <h4 class="text-2xl font-bold text-gray-900 mb-6 flex items-center gap-2">
                                    <span class="capitalize" x-text="activeSkill"></span>
                                    <template x-if="activeSkill === 'writing'">
                                        <span class="text-gray-500 font-normal" x-text="'Task ' + (currentWritingTaskIndex + 1)"></span>
                                    </template>
                                    <template x-if="activeSkill === 'reading'">
                                        <span class="text-gray-500 font-normal" x-text="'Question ' + (currentReadingQuestionIndex + 1)"></span>
                                    </template>
                                    <template x-if="activeSkill === 'listening'">
                                        <span class="text-gray-500 font-normal" x-text="'Question ' + (currentListeningQuestionIndex + 1)"></span>
                                    </template>
                                </h4>
                                
                                <!-- Writing Layout: Image + Description -->
                                <template x-if="activeSkill === 'writing'">
                                    <div>
                                        <div class="mb-6">
                                            <div class="w-full rounded-lg overflow-hidden bg-gray-100">
                                                <template x-if="selectedModuleData?.content?.writing?.tasks?.[currentWritingTaskIndex]?.image || selectedModuleData?.content?.writing?.image">
                                                    <img :src="selectedModuleData?.content?.writing?.tasks?.[currentWritingTaskIndex]?.image || selectedModuleData?.content?.writing?.image" alt="Writing prompt image" class="w-full h-auto object-cover">
                                                </template>
                                                <template x-if="!selectedModuleData?.content?.writing?.tasks?.[currentWritingTaskIndex]?.image && !selectedModuleData?.content?.writing?.image">
                                                    <div class="w-full h-64 flex items-center justify-center">
                                                        <p class="text-gray-400 text-sm">No image available</p>
                                                    </div>
                                                </template>
                                            </div>
                                        </div>
                                        <div>
                                            <p class="text-sm text-gray-600 leading-relaxed" x-text="selectedModuleData?.content?.writing?.tasks?.[currentWritingTaskIndex]?.description || selectedModuleData?.content?.writing?.description || 'No description available.'"></p>
                                        </div>
                                    </div>
                                </template>

                                <!-- Listening Layout: Multiple Choice (4 options) -->
                                <template x-if="activeSkill === 'listening'">
                                    <div>
                                        <!-- Question -->
                                        <div class="mb-6">
                                            <p class="text-lg text-gray-800 font-medium leading-relaxed" x-text="selectedModuleData?.content?.listening?.questions?.[currentListeningQuestionIndex]?.question || selectedModuleData?.content?.listening?.question || 'What is the main topic of the conversation?'"></p>
                                        </div>

                                        <!-- Multiple Choice Options (4 choices) -->
                                        <div class="space-y-3">
                                            <div class="p-3 border rounded-lg transition" 
                                                 :class="(selectedModuleData?.content?.listening?.questions?.[currentListeningQuestionIndex]?.correctAnswer || selectedModuleData?.content?.listening?.correctAnswer || 1) === 1 ? 'border-blue-500 bg-blue-50' : 'border-gray-200 bg-gray-50'">
                                                <p class="text-sm text-gray-700" x-text="selectedModuleData?.content?.listening?.questions?.[currentListeningQuestionIndex]?.options?.[0] || selectedModuleData?.content?.listening?.options?.[0] || 'A. Booking a restaurant table'"></p>
                                            </div>
                                            <div class="p-3 border rounded-lg transition" 
                                                 :class="(selectedModuleData?.content?.listening?.questions?.[currentListeningQuestionIndex]?.correctAnswer || selectedModuleData?.content?.listening?.correctAnswer || 1) === 2 ? 'border-blue-500 bg-blue-50' : 'border-gray-200 bg-gray-50'">
                                                <p class="text-sm text-gray-700" x-text="selectedModuleData?.content?.listening?.questions?.[currentListeningQuestionIndex]?.options?.[1] || selectedModuleData?.content?.listening?.options?.[1] || 'B. Making a hotel reservation'"></p>
                                            </div>
                                            <div class="p-3 border rounded-lg transition" 
                                                 :class="(selectedModuleData?.content?.listening?.questions?.[currentListeningQuestionIndex]?.correctAnswer || selectedModuleData?.content?.listening?.correctAnswer || 1) === 3 ? 'border-blue-500 bg-blue-50' : 'border-gray-200 bg-gray-50'">
                                                <p class="text-sm text-gray-700" x-text="selectedModuleData?.content?.listening?.questions?.[currentListeningQuestionIndex]?.options?.[2] || selectedModuleData?.content?.listening?.options?.[2] || 'C. Ordering food delivery'"></p>
                                            </div>
                                            <div class="p-3 border rounded-lg transition" 
                                                 :class="(selectedModuleData?.content?.listening?.questions?.[currentListeningQuestionIndex]?.correctAnswer || selectedModuleData?.content?.listening?.correctAnswer || 1) === 4 ? 'border-blue-500 bg-blue-50' : 'border-gray-200 bg-gray-50'">
                                                <p class="text-sm text-gray-700" x-text="selectedModuleData?.content?.listening?.questions?.[currentListeningQuestionIndex]?.options?.[3] || selectedModuleData?.content?.listening?.options?.[3] || 'D. Canceling a reservation'"></p>
                                            </div>
                                        </div>
                                    </div>
                                </template>

                                <!-- Reading Layout: Multiple Choice (4 options) -->
                                <template x-if="activeSkill === 'reading'">
                                    <div>
                                        <!-- Question -->
                                        <div class="mb-6">
                                            <p class="text-lg text-gray-800 font-medium leading-relaxed" x-text="selectedModuleData?.content?.reading?.questions?.[currentReadingQuestionIndex]?.question || selectedModuleData?.content?.reading?.question || 'What is the main idea of the passage?'"></p>
                                        </div>

                                        <!-- Multiple Choice Options (4 choices) -->
                                        <div class="space-y-3">
                                            <div class="p-3 border rounded-lg transition" 
                                                 :class="(selectedModuleData?.content?.reading?.questions?.[currentReadingQuestionIndex]?.correctAnswer || selectedModuleData?.content?.reading?.correctAnswer || 1) === 1 ? 'border-blue-500 bg-blue-50' : 'border-gray-200 bg-gray-50'">
                                                <p class="text-sm text-gray-700" x-text="selectedModuleData?.content?.reading?.questions?.[currentReadingQuestionIndex]?.options?.[0] || selectedModuleData?.content?.reading?.options?.[0] || 'A. The importance of reading comprehension'"></p>
                                            </div>
                                            <div class="p-3 border rounded-lg transition" 
                                                 :class="(selectedModuleData?.content?.reading?.questions?.[currentReadingQuestionIndex]?.correctAnswer || selectedModuleData?.content?.reading?.correctAnswer || 1) === 2 ? 'border-blue-500 bg-blue-50' : 'border-gray-200 bg-gray-50'">
                                                <p class="text-sm text-gray-700" x-text="selectedModuleData?.content?.reading?.questions?.[currentReadingQuestionIndex]?.options?.[1] || selectedModuleData?.content?.reading?.options?.[1] || 'B. Strategies for improving vocabulary'"></p>
                                            </div>
                                            <div class="p-3 border rounded-lg transition" 
                                                 :class="(selectedModuleData?.content?.reading?.questions?.[currentReadingQuestionIndex]?.correctAnswer || selectedModuleData?.content?.reading?.correctAnswer || 1) === 3 ? 'border-blue-500 bg-blue-50' : 'border-gray-200 bg-gray-50'">
                                                <p class="text-sm text-gray-700" x-text="selectedModuleData?.content?.reading?.questions?.[currentReadingQuestionIndex]?.options?.[2] || selectedModuleData?.content?.reading?.options?.[2] || 'C. The history of literature'"></p>
                                            </div>
                                            <div class="p-3 border rounded-lg transition" 
                                                 :class="(selectedModuleData?.content?.reading?.questions?.[currentReadingQuestionIndex]?.correctAnswer || selectedModuleData?.content?.reading?.correctAnswer || 1) === 4 ? 'border-blue-500 bg-blue-50' : 'border-gray-200 bg-gray-50'">
                                                <p class="text-sm text-gray-700" x-text="selectedModuleData?.content?.reading?.questions?.[currentReadingQuestionIndex]?.options?.[3] || selectedModuleData?.content?.reading?.options?.[3] || 'D. Techniques for speed reading'"></p>
                                            </div>
                                        </div>
                                    </div>
                                </template>

                                <!-- Speaking: 3 Parts with Navigation -->
                                <template x-if="activeSkill === 'speaking'">
                                    <div>
                                        <!-- Part Title -->
                                        <div class="mb-6">
                                            <h5 class="text-xl font-bold text-gray-900 mb-2" x-text="getSpeakingPartTitle()"></h5>
                                        </div>

                                        <!-- Question Navigation -->
                                        <div class="mb-6 flex gap-2">
                                            <button 
                                                @click="currentSpeakingQuestion = 1"
                                                :class="currentSpeakingQuestion === 1 ? 'bg-blue-600 text-white' : 'bg-gray-100 text-gray-700 hover:bg-gray-200'"
                                                class="flex-1 px-4 py-2 rounded-lg transition font-medium text-sm"
                                            >
                                                Question 1
                                            </button>
                                            <button 
                                                @click="currentSpeakingQuestion = 2"
                                                :class="currentSpeakingQuestion === 2 ? 'bg-blue-600 text-white' : 'bg-gray-100 text-gray-700 hover:bg-gray-200'"
                                                class="flex-1 px-4 py-2 rounded-lg transition font-medium text-sm"
                                            >
                                                Question 2
                                            </button>
                                </div>

                                        <!-- Question Display -->
                                        <div class="bg-gray-50 border border-gray-200 rounded-lg p-4">
                                            <p class="text-lg text-gray-800 font-medium leading-relaxed" x-text="getCurrentSpeakingQuestion()"></p>
                                </div>
                                    </div>
                                </template>
                            </div>
                            
                            <!-- Card Footer / Nav -->
                            <div class="bg-gray-50 px-8 py-4 border-t border-gray-100 flex justify-between items-center">
                                <template x-if="activeSkill === 'writing'">
                                    <button 
                                        @click="if(currentWritingTaskIndex > 0) currentWritingTaskIndex--" 
                                        :disabled="currentWritingTaskIndex === 0"
                                        class="w-10 h-10 rounded-full border border-gray-300 flex items-center justify-center text-gray-400 bg-white shadow-sm hover:bg-gray-50 disabled:opacity-40 disabled:cursor-not-allowed transition"
                                    >
                                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"></path></svg>
                                    </button>
                                </template>
                                <template x-if="activeSkill === 'speaking'">
                                    <button 
                                        @click="if(currentSpeakingPart > 1) { currentSpeakingPart--; currentSpeakingQuestion = 1; }" 
                                        :disabled="currentSpeakingPart === 1"
                                        class="w-10 h-10 rounded-full border border-gray-300 flex items-center justify-center text-gray-400 bg-white shadow-sm hover:bg-gray-50 disabled:opacity-40 disabled:cursor-not-allowed transition"
                                    >
                                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"></path></svg>
                                    </button>
                                </template>
                                <template x-if="activeSkill === 'reading'">
                                    <button 
                                        @click="if(currentReadingQuestionIndex > 0) currentReadingQuestionIndex--" 
                                        :disabled="currentReadingQuestionIndex === 0 || !selectedModuleData?.content?.reading?.questions || selectedModuleData.content.reading.questions.length === 0"
                                        class="w-10 h-10 rounded-full border border-gray-300 flex items-center justify-center text-gray-400 bg-white shadow-sm hover:bg-gray-50 disabled:opacity-40 disabled:cursor-not-allowed transition"
                                    >
                                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"></path></svg>
                                    </button>
                                </template>
                                <template x-if="activeSkill === 'listening'">
                                    <button 
                                        @click="if(currentListeningQuestionIndex > 0) currentListeningQuestionIndex--" 
                                        :disabled="currentListeningQuestionIndex === 0 || !selectedModuleData?.content?.listening?.questions || selectedModuleData.content.listening.questions.length === 0"
                                        class="w-10 h-10 rounded-full border border-gray-300 flex items-center justify-center text-gray-400 bg-white shadow-sm hover:bg-gray-50 disabled:opacity-40 disabled:cursor-not-allowed transition"
                                    >
                                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"></path></svg>
                                    </button>
                                </template>
                                <template x-if="activeSkill === 'writing'">
                                    <button 
                                        @click="if(selectedModuleData?.content?.writing?.tasks && currentWritingTaskIndex < selectedModuleData.content.writing.tasks.length - 1) currentWritingTaskIndex++" 
                                        :disabled="!selectedModuleData?.content?.writing?.tasks || currentWritingTaskIndex >= selectedModuleData.content.writing.tasks.length - 1"
                                        class="w-10 h-10 rounded-full bg-black text-white flex items-center justify-center shadow-lg hover:bg-gray-800 disabled:bg-gray-300 disabled:cursor-not-allowed transition"
                                    >
                                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14 5l7 7m0 0l-7 7m7-7H3"></path></svg>
                                    </button>
                                </template>
                                <template x-if="activeSkill === 'speaking'">
                                    <button 
                                        @click="if(currentSpeakingPart < 3) { currentSpeakingPart++; currentSpeakingQuestion = 1; }" 
                                        :disabled="currentSpeakingPart === 3"
                                        class="w-10 h-10 rounded-full bg-black text-white flex items-center justify-center shadow-lg hover:bg-gray-800 disabled:bg-gray-300 disabled:cursor-not-allowed transition"
                                    >
                                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14 5l7 7m0 0l-7 7m7-7H3"></path></svg>
                                    </button>
                                </template>
                                <template x-if="activeSkill === 'reading'">
                                    <button 
                                        @click="if(selectedModuleData?.content?.reading?.questions && currentReadingQuestionIndex < selectedModuleData.content.reading.questions.length - 1) currentReadingQuestionIndex++" 
                                        :disabled="!selectedModuleData?.content?.reading?.questions || currentReadingQuestionIndex >= selectedModuleData.content.reading.questions.length - 1"
                                        class="w-10 h-10 rounded-full bg-black text-white flex items-center justify-center shadow-lg hover:bg-gray-800 disabled:bg-gray-300 disabled:cursor-not-allowed transition"
                                    >
                                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14 5l7 7m0 0l-7 7m7-7H3"></path></svg>
                                    </button>
                                </template>
                                <template x-if="activeSkill === 'listening'">
                                    <button 
                                        @click="if(selectedModuleData?.content?.listening?.questions && currentListeningQuestionIndex < selectedModuleData.content.listening.questions.length - 1) currentListeningQuestionIndex++" 
                                        :disabled="!selectedModuleData?.content?.listening?.questions || currentListeningQuestionIndex >= selectedModuleData.content.listening.questions.length - 1"
                                        class="w-10 h-10 rounded-full bg-black text-white flex items-center justify-center shadow-lg hover:bg-gray-800 disabled:bg-gray-300 disabled:cursor-not-allowed transition"
                                    >
                                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14 5l7 7m0 0l-7 7m7-7H3"></path></svg>
                                    </button>
                                </template>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 3. TEST BANK TAB -->
            <div x-show="currentTab === 'testbank'" x-cloak x-transition.opacity>
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-2xl font-bold text-gray-800">General Test Bank</h2>
                    <div class="flex gap-3">
                        <button @click="showModal = 'generateAI'" class="ai-gradient text-white px-4 py-2 rounded-lg shadow-md hover:opacity-90 transition flex items-center gap-2">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                                <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-11a1 1 0 10-2 0v2H7a1 1 0 100 2h2v2a1 1 0 102 0v-2h2a1 1 0 100-2h-2V7z" clip-rule="evenodd" />
                            </svg>
                            Generate with AI
                        </button>
                        <button @click="showModal = 'addTest'" class="bg-white border border-gray-300 text-gray-700 px-4 py-2 rounded-lg hover:bg-gray-50 transition">Manual Add</button>
                    </div>
                </div>
                <div class="space-y-4">
                    <% assessments.forEach(function(test) { 
                        let borderClass = 'border-gray-300'; let badgeClass = 'bg-gray-100 text-gray-700'; let icon = '';
                        if (test.category === 'Speaking') { borderClass = 'border-green-500'; badgeClass = 'bg-green-100 text-green-700'; icon = 'ðŸŽ¤'; } 
                        else if (test.category === 'Listening') { borderClass = 'border-blue-500'; badgeClass = 'bg-blue-100 text-blue-700'; icon = 'ðŸŽ§'; } 
                        else if (test.category === 'Writing') { borderClass = 'border-purple-500'; badgeClass = 'bg-purple-100 text-purple-700'; icon = 'ðŸ“'; }
                        else if (test.category === 'Reading') { borderClass = 'border-yellow-500'; badgeClass = 'bg-yellow-100 text-yellow-700'; icon = 'ðŸ“–'; }
                    %>
                    <div class="bg-white rounded-lg shadow-sm border-l-4 <%= borderClass %> p-5 flex justify-between items-center hover:shadow-md transition duration-200 group">
                        <div class="flex-1 pr-4">
                            <div class="flex items-center gap-3 mb-2"><span class="px-2 py-1 rounded text-xs font-bold uppercase tracking-wide <%= badgeClass %>"><%= icon %> <%= test.category %></span><% if (test.generatedByAI) { %> <span class="text-xs text-gray-400 flex items-center gap-1">âœ¨ AI Generated</span> <% } %></div>
                            <h4 class="text-lg font-medium text-gray-900 leading-tight"><%= test.question %></h4>
                        </div>
                        <div class="flex items-center space-x-2 opacity-80 group-hover:opacity-100 transition">
                            <button data-test='<%- JSON.stringify(test) %>' @click.stop="showModal = 'editTest'; editItem = JSON.parse($el.dataset.test)" class="p-2 text-gray-500 hover:text-blue-600 hover:bg-blue-50 rounded-full transition" title="Edit"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" /></svg></button>
                            <form action="/admin/delete-test" method="POST" onsubmit="return confirm('Delete this question?');"><input type="hidden" name="id" value="<%= test.id %>"><button type="submit" class="p-2 text-gray-500 hover:text-red-600 hover:bg-red-50 rounded-full transition" title="Delete"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg></button></form>
                        </div>
                    </div>
                    <% }); %>
                </div>
            </div>

            <!-- 4. NEW TAB: MODULE TEST BANK -->
            <div x-show="currentTab === 'moduletestbank'" x-cloak x-transition.opacity>
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-2xl font-bold text-gray-800">Module Task 1</h2>
                    <button @click="showModal = 'addModuleQuestion'" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 shadow-sm transition flex items-center gap-2">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path></svg>
                        Add Content
                    </button>
                </div>
                <!-- Card Layout for Questions -->
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                    <template x-for="q in moduleQuestions" :key="q.id">
                         <div class="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden flex flex-col group hover:shadow-md transition">
                             <template x-if="q.image">
                                 <div class="h-40 w-full bg-gray-100 flex items-center justify-center overflow-hidden relative">
                                    <img :src="q.image" class="w-full h-full object-cover">
                                 </div>
                             </template>
                             <div class="p-5 flex-1 flex flex-col">
                                 <div class="flex-1">
                                     <p class="text-gray-800 font-medium text-sm line-clamp-3" x-text="q.description"></p>
                                 </div>
                                 <div class="mt-4 flex justify-between items-center pt-4 border-t border-gray-100">
                                     <span class="text-xs text-gray-400">ID: <span x-text="q.id"></span></span>
                                     <div class="flex gap-2 opacity-80 group-hover:opacity-100 transition">
                                         <button @click="openEditModuleQuestion(q)" class="text-blue-600 hover:bg-blue-50 p-1 rounded"><svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z"></path></svg></button>
                                         <button @click="deleteModuleQuestion(q.id)" class="text-red-600 hover:bg-red-50 p-1 rounded"><svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg></button>
                                     </div>
                                 </div>
                             </div>
                         </div>
                    </template>
                </div>
                <div x-show="moduleQuestions.length === 0" class="text-center py-12 border border-dashed border-gray-300 rounded-lg bg-gray-50">
                    <div class="inline-flex items-center justify-center w-16 h-16 rounded-full bg-blue-50 mb-4">
                        <svg class="w-8 h-8 text-blue-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10"></path></svg>
                    </div>
                    <h3 class="text-lg font-medium text-gray-900">No module content yet</h3>
                    <p class="text-gray-500 max-w-sm mx-auto mt-1">Add questions, reading passages, or listening exercises specific to modules here.</p>
                </div>
            </div>

            <!-- 5. ABEL TAB (Unchanged) -->
            <div x-show="currentTab === 'abel'" x-cloak x-transition.opacity>
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-2xl font-bold text-gray-800">ABEL Final Assessment</h2>
                    <button @click="showModal = 'addAbel'" class="bg-purple-600 text-white px-4 py-2 rounded-lg hover:bg-purple-700 transition">+ Add Final Question</button>
                </div>
                <div class="space-y-4">
                    <% finalAssessments.forEach(function(abel) { %>
                    <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-200 flex justify-between items-center group hover:shadow-md transition">
                        <div>
                            <h4 class="font-medium text-gray-900"><%= abel.prompt %></h4>
                            <div class="text-sm text-gray-500 mt-1 flex gap-4"><span>Type: <b><%= abel.type %></b></span><span>Difficulty: <b class="text-orange-500"><%= abel.difficulty %></b></span></div>
                        </div>
                        <div class="flex items-center gap-2 opacity-80 group-hover:opacity-100 transition">
                            <button data-abel='<%- JSON.stringify(abel) %>' @click="showModal = 'editAbel'; editItem = JSON.parse($el.dataset.abel)" class="text-blue-500 hover:text-blue-700 p-2 rounded-full hover:bg-blue-50 transition" title="Edit"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" /></svg></button>
                            <form action="/admin/delete-abel" method="POST" onsubmit="return confirm('Delete this item?');"><input type="hidden" name="id" value="<%= abel.id %>"><button type="submit" class="text-red-500 hover:text-red-700 p-2 rounded-full hover:bg-red-50 transition"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg></button></form>
                        </div>
                    </div>
                    <% }); %>
                </div>
            </div>

        </main>
    </div>

    <!-- MODALS -->

    <!-- Module Stats (Clean White) -->
    <div x-show="showModal === 'moduleStats'" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50" x-cloak><div class="bg-white rounded-xl p-8 w-full max-w-lg shadow-2xl transform transition-all" @click.away="showModal = false"><div class="flex justify-between items-start mb-6"><div><h3 class="text-2xl font-bold text-gray-900" x-text="selectedUser?.userName || 'User'"></h3><div class="text-gray-500 text-sm mt-1" x-text="selectedUser?.userEmail"></div><span class="inline-block mt-2 px-3 py-1 rounded-full text-xs font-semibold" :class="getLevelClass(selectedUser?.userRank)" x-text="selectedUser?.userRank"></span></div><button @click="showModal = false" class="text-gray-400 hover:text-gray-600"><svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg></button></div><h4 class="text-lg font-semibold text-gray-800 mb-4 pb-2 border-b border-gray-100">Performance Overview</h4><div class="space-y-5"><div><div class="flex justify-between text-sm mb-1"><span class="text-gray-600 font-medium">Speaking</span><span class="font-bold text-blue-600" x-text="((selectedUser?.modules?.[currentModuleIndex]?.scores?.speaking || 0) / 9 * 100).toFixed(0) + '%'"></span></div><div class="w-full bg-gray-100 rounded-full h-2.5"><div class="bg-blue-600 h-2.5 rounded-full" :style="'width: ' + ((selectedUser?.modules?.[currentModuleIndex]?.scores?.speaking || 0) / 9 * 100) + '%'"></div></div></div><div><div class="flex justify-between text-sm mb-1"><span class="text-gray-600 font-medium">Listening</span><span class="font-bold text-green-500" x-text="((selectedUser?.modules?.[currentModuleIndex]?.scores?.listening || 0) / 9 * 100).toFixed(0) + '%'"></span></div><div class="w-full bg-gray-100 rounded-full h-2.5"><div class="bg-green-500 h-2.5 rounded-full" :style="'width: ' + ((selectedUser?.modules?.[currentModuleIndex]?.scores?.listening || 0) / 9 * 100) + '%'"></div></div></div><div><div class="flex justify-between text-sm mb-1"><span class="text-gray-600 font-medium">Reading</span><span class="font-bold text-yellow-500" x-text="((selectedUser?.modules?.[currentModuleIndex]?.scores?.reading || 0) / 9 * 100).toFixed(0) + '%'"></span></div><div class="w-full bg-gray-100 rounded-full h-2.5"><div class="bg-yellow-500 h-2.5 rounded-full" :style="'width: ' + ((selectedUser?.modules?.[currentModuleIndex]?.scores?.reading || 0) / 9 * 100) + '%'"></div></div></div><div><div class="flex justify-between text-sm mb-1"><span class="text-gray-600 font-medium">Writing</span><span class="font-bold text-purple-500" x-text="((selectedUser?.modules?.[currentModuleIndex]?.scores?.writing || 0) / 9 * 100).toFixed(0) + '%'"></span></div><div class="w-full bg-gray-100 rounded-full h-2.5"><div class="bg-purple-500 h-2.5 rounded-full" :style="'width: ' + ((selectedUser?.modules?.[currentModuleIndex]?.scores?.writing || 0) / 9 * 100) + '%'"></div></div></div></div><div class="mt-8 flex justify-end"><button @click="showModal = false" class="bg-gray-100 hover:bg-gray-200 text-gray-700 px-6 py-2 rounded-lg font-medium transition">Close</button></div></div></div>
    
    <!-- User Stats -->
    <div x-show="showModal === 'viewStats'" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50" x-cloak><div class="bg-white rounded-xl p-8 w-full max-w-lg shadow-2xl transform transition-all" @click.away="showModal = false"><div class="flex justify-between items-start mb-6"><div><h3 class="text-2xl font-bold text-gray-900" x-text="viewUser.name"></h3><div class="text-gray-500 text-sm mt-1" x-text="viewUser.email"></div><span class="inline-block mt-2 px-3 py-1 rounded-full text-xs font-semibold" :class="getLevelClass(viewUser.level)" x-text="viewUser.level"></span></div><button @click="showModal = false" class="text-gray-400 hover:text-gray-600"><svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg></button></div><h4 class="text-lg font-semibold text-gray-800 mb-4 pb-2 border-b border-gray-100">Performance Overview</h4><div class="space-y-5"><div><div class="flex justify-between text-sm mb-1"><span class="text-gray-600 font-medium">Speaking</span><span class="font-bold text-blue-600" x-text="viewUser.stats?.speaking + '%'"></span></div><div class="w-full bg-gray-100 rounded-full h-2.5"><div class="bg-blue-600 h-2.5 rounded-full" :style="'width: ' + (viewUser.stats?.speaking || 0) + '%'"></div></div></div><div><div class="flex justify-between text-sm mb-1"><span class="text-gray-600 font-medium">Listening</span><span class="font-bold text-green-500" x-text="viewUser.stats?.listening + '%'"></span></div><div class="w-full bg-gray-100 rounded-full h-2.5"><div class="bg-green-500 h-2.5 rounded-full" :style="'width: ' + (viewUser.stats?.listening || 0) + '%'"></div></div></div><div><div class="flex justify-between text-sm mb-1"><span class="text-gray-600 font-medium">Reading</span><span class="font-bold text-yellow-500" x-text="viewUser.stats?.reading + '%'"></span></div><div class="w-full bg-gray-100 rounded-full h-2.5"><div class="bg-yellow-500 h-2.5 rounded-full" :style="'width: ' + (viewUser.stats?.reading || 0) + '%'"></div></div></div><div><div class="flex justify-between text-sm mb-1"><span class="text-gray-600 font-medium">Writing</span><span class="font-bold text-purple-500" x-text="viewUser.stats?.writing + '%'"></span></div><div class="w-full bg-gray-100 rounded-full h-2.5"><div class="bg-purple-500 h-2.5 rounded-full" :style="'width: ' + (viewUser.stats?.writing || 0) + '%'"></div></div></div></div><div class="mt-8 flex justify-end"><button @click="showModal = false" class="bg-gray-100 hover:bg-gray-200 text-gray-700 px-6 py-2 rounded-lg font-medium transition">Close</button></div></div></div>
    
    <!-- Edit User Modal -->
    <div x-show="showModal === 'editUser'" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50" x-cloak>
        <div class="bg-white rounded-xl p-6 w-full max-w-md shadow-2xl">
            <h3 class="text-xl font-bold mb-4">Edit User</h3>
            <form action="/admin/edit-user" method="POST" class="space-y-4">
                <input type="hidden" name="id" x-model="editItem.id">
                <div>
                    <label class="text-xs text-gray-500">Name</label>
                    <input type="text" name="name" x-model="editItem.name" required class="w-full border p-2 rounded">
                </div>
                <div>
                    <label class="text-xs text-gray-500">Email</label>
                    <input type="email" name="email" x-model="editItem.email" required class="w-full border p-2 rounded">
                    </div>
                    <div>
                        <label class="text-xs text-gray-500">Level</label>
                        <select name="level" x-model="editItem.level" disabled class="w-full border p-2 rounded bg-gray-50 text-gray-500 cursor-not-allowed">
                            <option value="Beginner">Beginner</option>
                            <option value="Pre-Intermediate">Pre-Intermediate</option>
                            <option value="Intermediate">Intermediate</option>
                            <option value="Advanced">Advanced</option>
                        </select>
                </div>
                <div class="flex justify-end gap-2 mt-4">
                    <button type="button" @click="showModal = false" class="px-4 py-2 border rounded">Cancel</button>
                    <button type="submit" class="px-4 py-2 bg-blue-600 text-white rounded">Update</button>
                </div>
            </form>
        </div>
    </div>

    <!-- 3. Manual Add Test Modal (UPDATED WITH READING OPTION) -->
    <div x-show="showModal === 'addTest'" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50" x-cloak>
        <div class="bg-white rounded-xl p-6 w-full max-w-md shadow-2xl">
            <h3 class="text-xl font-bold mb-4">Add Test Question</h3>
            <form action="/admin/add-test" method="POST" class="space-y-4">
                <input type="text" name="question" placeholder="Question" required class="w-full border p-2 rounded">
                <select name="category" class="w-full border p-2 rounded">
                    <option value="Speaking">Speaking</option>
                    <option value="Listening">Listening</option>
                    <option value="Writing">Writing</option>
                    <option value="Reading">Reading</option> <!-- Added Reading -->
                </select>
                <div class="flex justify-end gap-2"><button type="button" @click="showModal = false" class="px-4 py-2 border rounded">Cancel</button><button type="submit" class="px-4 py-2 bg-blue-600 text-white rounded">Save</button></div>
            </form>
        </div>
    </div>
    
    <!-- 3b. Edit Test Modal (UPDATED WITH READING OPTION) -->
    <div x-show="showModal === 'editTest'" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50" x-cloak>
        <div class="bg-white rounded-xl p-6 w-full max-w-md shadow-2xl">
            <h3 class="text-xl font-bold mb-4">Edit Test Question</h3>
            <form action="/admin/edit-test" method="POST" class="space-y-4">
                <input type="hidden" name="id" x-model="editItem.id">
                <div><label class="text-xs text-gray-500">Question</label><input type="text" name="question" x-model="editItem.question" required class="w-full border p-2 rounded"></div>
                <div><label class="text-xs text-gray-500">Category</label>
                    <select name="category" x-model="editItem.category" class="w-full border p-2 rounded">
                        <option value="Speaking">Speaking</option>
                        <option value="Listening">Listening</option>
                        <option value="Writing">Writing</option>
                        <option value="Reading">Reading</option> <!-- Added Reading -->
                    </select>
                </div>
                <div class="flex justify-end gap-2 mt-4"><button type="button" @click="showModal = false" class="px-4 py-2 border rounded">Cancel</button><button type="submit" class="px-4 py-2 bg-blue-600 text-white rounded">Update</button></div>
            </form>
        </div>
    </div>
    
    <!-- AI Gen -->
    <div x-show="showModal === 'generateAI'" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50" x-cloak><div class="bg-white rounded-xl p-6 w-full max-w-md shadow-2xl border-t-4 border-purple-500"><h3 class="text-xl font-bold mb-2 text-gray-800">âœ¨ AI Question Generator</h3><p class="text-sm text-gray-500 mb-4">Enter a topic, and Gemini AI will create a test question for you.</p><form action="/admin/generate-test" method="POST" class="space-y-4"><div><label class="block text-sm font-medium text-gray-700">Topic / Context</label><input type="text" name="topic" placeholder="e.g. Past Tense Verbs..." required class="w-full border p-2 rounded"></div><div class="flex justify-end gap-2 mt-6"><button type="button" @click="showModal = false" class="px-4 py-2 border rounded text-gray-600">Cancel</button><button type="submit" class="px-4 py-2 ai-gradient text-white rounded shadow-md hover:opacity-90">Generate & Save</button></div></form></div></div>
    
    <!-- Add ABEL -->
    <div x-show="showModal === 'addAbel'" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50" x-cloak><div class="bg-white rounded-xl p-6 w-full max-w-lg shadow-2xl"><h3 class="text-xl font-bold mb-4 text-purple-800">Add Final Assessment</h3><form action="/admin/add-abel" method="POST" class="space-y-4"><textarea name="prompt" placeholder="Prompt/Question" required class="w-full border p-2 rounded h-24"></textarea><div class="grid grid-cols-2 gap-4"><select name="type" class="border p-2 rounded"><option>Speaking</option><option>Reading</option><option>Listening</option><option>Writing</option></select><select name="difficulty" class="border p-2 rounded"><option>Standard</option><option>Hard</option></select></div><div class="flex justify-end gap-2"><button type="button" @click="showModal = false" class="px-4 py-2 border rounded">Cancel</button><button type="submit" class="px-4 py-2 bg-purple-600 text-white rounded">Save</button></div></form></div></div>

    <!-- Edit ABEL Modal -->
    <div x-show="showModal === 'editAbel'" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50" x-cloak>
        <div class="bg-white rounded-xl p-6 w-full max-w-lg shadow-2xl">
            <h3 class="text-xl font-bold mb-4 text-purple-800">Edit Final Assessment</h3>
            <form action="/admin/edit-abel" method="POST" class="space-y-4">
                <input type="hidden" name="id" x-model="editItem.id">
                <div>
                    <label class="text-xs text-gray-500">Prompt</label>
                    <textarea name="prompt" x-model="editItem.prompt" required class="w-full border p-2 rounded h-24"></textarea>
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="text-xs text-gray-500">Type</label>
                        <select name="type" x-model="editItem.type" class="w-full border p-2 rounded">
                            <option>Speaking</option>
                            <option>Reading</option>
                            <option>Listening</option>
                            <option>Writing</option>
                        </select>
                    </div>
                    <div>
                        <label class="text-xs text-gray-500">Difficulty</label>
                        <select name="difficulty" x-model="editItem.difficulty" class="w-full border p-2 rounded">
                            <option>Standard</option>
                            <option>Hard</option>
                        </select>
                    </div>
                </div>
                <div class="flex justify-end gap-2 mt-4">
                    <button type="button" @click="showModal = false" class="px-4 py-2 border rounded">Cancel</button>
                    <button type="submit" class="px-4 py-2 bg-purple-600 text-white rounded">Update</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Add Module Question Modal -->
    <div x-show="showModal === 'addModuleQuestion'" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50" x-cloak>
        <div class="bg-white rounded-xl p-6 w-full max-w-md shadow-2xl">
            <h3 class="text-xl font-bold mb-4 text-blue-800">Add Content to Module</h3>
            <form @submit.prevent="addModuleQuestion" class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700">Question / Description</label>
                    <textarea id="mq-desc" placeholder="Enter content description..." required class="w-full border p-2 rounded h-24"></textarea>
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700">Upload Image (Optional)</label>
                    <div class="mt-1 flex justify-center px-6 pt-5 pb-6 border-2 border-gray-300 border-dashed rounded-md">
                        <div class="space-y-1 text-center">
                            <div x-show="!previewImage">
                                <svg class="mx-auto h-12 w-12 text-gray-400" stroke="currentColor" fill="none" viewBox="0 0 48 48"><path d="M28 8H12a4 4 0 00-4 4v20m32-12v8m0 0v8a4 4 0 01-4 4H12a4 4 0 01-4-4v-4m32-4l-3.172-3.172a4 4 0 00-5.656 0L28 28M8 32l9.172-9.172a4 4 0 015.656 0L28 28m0 0l4 4m4-24h8m-4-4v8m-12 4h.02" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" /></svg>
                                <div class="flex text-sm text-gray-600">
                                    <label class="relative cursor-pointer bg-white rounded-md font-medium text-blue-600 hover:text-blue-500 focus-within:outline-none">
                                        <span>Upload a file</span>
                                        <input type="file" class="sr-only" @change="handleFileUpload">
                                    </label>
                                </div>
                            </div>
                            <div x-show="previewImage" class="relative">
                                <img :src="previewImage" class="max-h-48 mx-auto rounded-md shadow-sm">
                                <button type="button" @click="previewImage = null" class="absolute top-0 right-0 bg-red-500 text-white rounded-full p-1 -mt-2 -mr-2 shadow-sm hover:bg-red-600">
                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="flex justify-end gap-2">
                    <button type="button" @click="showModal = false" class="px-4 py-2 border rounded">Cancel</button>
                    <button type="submit" class="px-4 py-2 bg-blue-600 text-white rounded">Save Content</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Edit Module Question Modal -->
    <div x-show="showModal === 'editModuleQuestion'" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50" x-cloak>
        <div class="bg-white rounded-xl p-6 w-full max-w-md shadow-2xl">
            <h3 class="text-xl font-bold mb-4 text-blue-800">Edit Module Content</h3>
            <form @submit.prevent="updateModuleQuestion" class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700">Question / Description</label>
                    <textarea x-model="editItem.description" required class="w-full border p-2 rounded h-24"></textarea>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700">Upload Image (Optional)</label>
                    <div class="mt-1 flex justify-center px-6 pt-5 pb-6 border-2 border-gray-300 border-dashed rounded-md">
                        <div class="space-y-1 text-center">
                            <div x-show="!previewImage">
                                <svg class="mx-auto h-12 w-12 text-gray-400" stroke="currentColor" fill="none" viewBox="0 0 48 48"><path d="M28 8H12a4 4 0 00-4 4v20m32-12v8m0 0v8a4 4 0 01-4 4H12a4 4 0 01-4-4v-4m32-4l-3.172-3.172a4 4 0 00-5.656 0L28 28M8 32l9.172-9.172a4 4 0 015.656 0L28 28m0 0l4 4m4-24h8m-4-4v8m-12 4h.02" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" /></svg>
                                <div class="flex text-sm text-gray-600">
                                    <label class="relative cursor-pointer bg-white rounded-md font-medium text-blue-600 hover:text-blue-500 focus-within:outline-none">
                                        <span>Upload a file</span>
                                        <input type="file" class="sr-only" @change="handleFileUpload" required>
                                    </label>
                                </div>
                            </div>
                            <div x-show="previewImage" class="relative">
                                <img :src="previewImage" class="max-h-48 mx-auto rounded-md shadow-sm">
                                <button type="button" @click="previewImage = null" class="absolute top-0 right-0 bg-red-500 text-white rounded-full p-1 -mt-2 -mr-2 shadow-sm hover:bg-red-600">
                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="flex justify-end gap-2">
                    <button type="button" @click="showModal = false" class="px-4 py-2 border rounded">Cancel</button>
                    <button type="submit" class="px-4 py-2 bg-blue-600 text-white rounded">Update Content</button>
                </div>
            </form>
        </div>
    </div>

</body>
</html>