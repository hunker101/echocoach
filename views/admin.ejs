<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EchoCoach Management</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js" defer></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap');
        body { font-family: 'Inter', sans-serif; }
        [x-cloak] { display: none !important; }
        .ai-gradient {
            background: linear-gradient(45deg, #4f46e5, #9333ea, #ec4899);
            background-size: 200% 200%;
            animation: gradient 3s ease infinite;
        }
        @keyframes gradient { 0% { background-position: 0% 50%; } 50% { background-position: 100% 50%; } 100% { background-position: 0% 50%; } }
        
        /* Custom Scrollbar for lists */
        .custom-scroll::-webkit-scrollbar { width: 6px; }
        .custom-scroll::-webkit-scrollbar-track { background: #f1f1f1; }
        .custom-scroll::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }
        .custom-scroll::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
    </style>
</head>
<!-- 
    APP STATE:
    currentTab: 'users' | 'modules' | 'testbank' | 'abel'
    showModal: Controls which modal is open
    editItem: Temporary storage for editing
    viewUser: Temporary storage for viewing stats
-->
<body class="bg-gray-100" x-data="{ 
    currentTab: new URLSearchParams(window.location.search).get('tab') || 'users', 
    showModal: false, 
    editItem: {}, 
    viewUser: {},
    moduleView: 'list', 
    selectedUser: null,
    selectedModuleData: null,
    activeSkill: null,
    currentModuleIndex: 0,
    currentWritingTaskIndex: 0,
    currentSpeakingPart: 1,
    currentSpeakingQuestion: 1,
    currentReadingQuestionIndex: 0,
    currentListeningQuestionIndex: 0,
    previewImage: null,
    usersList: [],
    createdAtSortOrder: null,
    modulesList: [],
    statusSortOrder: null,
    assessmentCenterOpen: true,
    tagsData: {},
    finalAssessmentsList: [],
    selectedWritingExam: null, // Selected Writing exam for detail view
    writingExamView: 'list', // 'list' or 'detail'
    writingTask1: { description: '', image: null, tags: '', previewImage: null },
    writingTask2: { description: '', image: null, tags: '', previewImage: null },
    writingExamSaved: false, // Track if exam has been saved
    readingExamView: 'list', // 'list' or 'detail' for Reading exams
    selectedReadingExam: null, // Selected Reading exam for detail view
    selectedReadingExamId: null, // Store the exam ID separately to ensure it's preserved
    readingPassage: '', // Reading passage content
    readingQuestions: [], // Array of multiple choice questions
    currentReadingQuestion: { question: '', optionA: '', optionB: '', optionC: '', optionD: '', correctAnswer: 1, tags: '' },
    readingExamSaved: false, // Track if exam has been saved
    listeningExamView: 'list', // 'list' or 'detail' for Listening exams
    selectedListeningExam: null, // Selected Listening exam for detail view
    selectedListeningExamId: null, // Store the exam ID separately
    listeningNarration: '', // Context/Narration field
    listeningSpeakers: [{ role: 'Speaker 1', accent: 'British', script: '' }, { role: 'Speaker 2', accent: 'British', script: '' }], // Array of speakers (max 2)
    listeningQuestions: [], // Array of multiple choice questions
    currentListeningQuestion: { question: '', optionA: '', optionB: '', optionC: '', optionD: '', correctAnswer: 1, tags: '' },
    listeningExamSaved: false, // Track if exam has been saved
    speakingExamView: 'list', // 'list' or 'detail' for Speaking exams
    selectedSpeakingExam: null, // Selected Speaking exam for detail view
    selectedSpeakingExamId: null, // Store the exam ID separately
    speakingModuleContent: '', // Module Content / Examiner Instructions (rich text)
    speakingCurrentPart: 1, // Currently selected part (1, 2, or 3)
    speakingQuestions: { part1: [], part2: [], part3: [] }, // Questions grouped by part
    currentSpeakingQuestion: { question: '', tags: '' }, // Current question input
    speakingExamSaved: false, // Track if exam has been saved
    // Regular User Test Bank - Writing
    regularWritingView: 'cards', // 'cards', 'list', or 'detail'
    regularWritingSkill: null, // 'writing', 'reading', 'listening', 'speaking'
    regularWritingExamsList: [], // List of regular writing exams
    selectedRegularWritingExam: null, // Selected exam for detail view
    selectedRegularWritingExamId: null, // Store exam ID separately
    regularWritingTask1: { description: '', image: null, tags: '', previewImage: null },
    regularWritingTask2: { description: '', image: null, tags: '', previewImage: null },
    regularWritingExamSaved: false, // Track if exam is saved (read-only mode)
    regularWritingEditMode: false, // Track if fields are editable
    // Regular User Test Bank - Reading
    regularReadingView: 'cards', // 'cards', 'list', or 'detail'
    regularReadingSkill: null, // 'writing', 'reading', 'listening', 'speaking'
    regularReadingExamsList: [], // List of regular reading exams
    selectedRegularReadingExam: null, // Selected exam for detail view
    selectedRegularReadingExamId: null, // Store exam ID separately
    regularReadingPassageTitle: '', // Passage title
    regularReadingPassageContent: '', // Passage content (rich text)
    regularReadingQuestions: [], // Array of multiple choice questions
    currentRegularReadingQuestion: { question: '', optionA: '', optionB: '', optionC: '', optionD: '', correctAnswer: 'A', tags: '' },
    regularReadingExamSaved: false, // Track if exam is saved (read-only mode)
    regularReadingEditMode: false, // Track if fields are editable
    // Regular User Test Bank - Listening
    regularListeningView: 'cards', // 'cards', 'list', or 'detail'
    regularListeningSkill: null, // 'writing', 'reading', 'listening', 'speaking'
    regularListeningExamsList: [], // List of regular listening exams
    selectedRegularListeningExam: null, // Selected exam for detail view
    selectedRegularListeningExamId: null, // Store exam ID separately
    regularListeningNarration: '', // Narration/Context field
    regularListeningScriptBlocks: [], // Array of dialogue blocks { speaker: 'Speaker 1/2', accent: 'British', line: '' }
    regularListeningQuestions: [], // Array of multiple choice questions
    currentRegularListeningQuestion: { question: '', optionA: '', optionB: '', optionC: '', optionD: '', correctAnswer: 'A', tags: '' },
    regularListeningExamSaved: false, // Track if exam is saved (read-only mode)
    regularListeningEditMode: false, // Track if fields are editable
    // Regular User Test Bank - Speaking
    regularSpeakingView: 'cards', // 'cards', 'list', or 'detail'
    regularSpeakingSkill: null, // 'writing', 'reading', 'listening', 'speaking'
    regularSpeakingExamsList: [], // List of regular speaking exams
    selectedRegularSpeakingExam: null, // Selected exam for detail view
    selectedRegularSpeakingExamId: null, // Store exam ID separately
    regularSpeakingModuleContent: '', // Examiner Instructions / Module Content (rich text)
    regularSpeakingCurrentPart: 1, // Currently selected part (1, 2, or 3)
    regularSpeakingQuestions: { part1: [], part2: [], part3: [] }, // Questions grouped by part
    currentRegularSpeakingQuestion: { question: '', tags: '' }, // Current question input
    regularSpeakingExamSaved: false, // Track if exam is saved (read-only mode)
    regularSpeakingEditMode: false, // Track if fields are editable
    mockExamView: (() => {
        const urlParams = new URLSearchParams(window.location.search);
        const skill = urlParams.get('skill');
        return skill ? 'skill' : 'list';
    })(), // 'list' or 'skill'
    mockExamSkill: (() => {
        const urlParams = new URLSearchParams(window.location.search);
        return urlParams.get('skill') || null;
    })(), // 'writing', 'reading', 'listening', 'speaking'
    getQuestionCount(skill) {
        if (!this.finalAssessmentsList || this.finalAssessmentsList.length === 0) return 0;
        return this.finalAssessmentsList.filter(q => q && q.type && q.type.toLowerCase() === skill.toLowerCase()).length;
    },
    openWritingExamDetail(question) {
        this.selectedWritingExam = question;
        this.writingExamView = 'detail';
        // Load existing tasks if available
        if (question.task1) {
            this.writingTask1 = {
                description: question.task1.description || '',
                image: question.task1.image || null,
                tags: question.task1.tags || '',
                previewImage: question.task1.image || null
            };
        } else {
            this.writingTask1 = { description: '', image: null, tags: '', previewImage: null };
        }
        if (question.task2) {
            this.writingTask2 = {
                description: question.task2.description || '',
                image: question.task2.image || null,
                tags: question.task2.tags || '',
                previewImage: question.task2.image || null
            };
        } else {
            this.writingTask2 = { description: '', image: null, tags: '', previewImage: null };
        }
        // Check if exam has been saved before
        this.writingExamSaved = !!(question.task1 || question.task2);
    },
    closeWritingExamDetail() {
        this.writingExamView = 'list';
        this.selectedWritingExam = null;
        this.writingTask1 = { description: '', image: null, tags: '', previewImage: null };
        this.writingTask2 = { description: '', image: null, tags: '', previewImage: null };
        this.writingExamSaved = false;
    },
    openReadingExamDetail(question, questionId) {
        // Use the explicitly passed ID first, then try from question object
        let examId = null;
        
        // Priority 1: Use explicitly passed ID (from data attribute or parameter)
        if (questionId !== undefined && questionId !== null && questionId !== '') {
            examId = parseInt(questionId);
            if (!isNaN(examId)) {
                console.log('Got ID from parameter:', examId);
            } else {
                examId = null; // Reset if parse failed
            }
        }
        
        // Priority 2: Try from question object
        if ((isNaN(examId) || examId === null) && question && question.id !== undefined && question.id !== null) {
            examId = parseInt(question.id);
            if (!isNaN(examId)) {
                console.log('Got ID from question object:', examId);
            } else {
                examId = null; // Reset if parse failed
            }
        }
        
        // Priority 3: Find from list by matching properties
        if (isNaN(examId) || examId === null) {
            // Ensure list is initialized
            this.initFinalAssessments();
            const examInList = this.finalAssessmentsList.find(q => {
                if (q.type !== 'Reading') return false;
                // Try to match by title, prompt, or description
                if (question) {
                    return (q.title && question.title && q.title === question.title) ||
                           (q.prompt && question.prompt && q.prompt === question.prompt) ||
                           (q.description && question.description && q.description === question.description);
                }
                return false;
            });
            if (examInList && examInList.id !== undefined && examInList.id !== null) {
                const parsedId = parseInt(examInList.id);
                if (!isNaN(parsedId)) {
                    examId = parsedId;
                    console.log('Found ID from list lookup:', examId);
                }
            }
        }
        
        // Priority 4: Use the filtered list to find by index
        if (isNaN(examId) || examId === null) {
            const filtered = this.getFilteredMockExamQuestions();
            const currentIndex = filtered.findIndex(q => 
                (q === question) || 
                (q.title === question?.title) ||
                (q.prompt === question?.prompt)
            );
            if (currentIndex >= 0 && filtered[currentIndex]) {
                const filteredQuestion = filtered[currentIndex];
                if (filteredQuestion.id) {
                    const parsedId = parseInt(filteredQuestion.id);
                    if (!isNaN(parsedId)) {
                        examId = parsedId;
                        console.log('Found ID from filtered list by index:', examId);
                    }
                }
            }
        }
        
        // Final validation
        if (isNaN(examId) || examId === null) {
            console.error('Cannot determine exam ID.');
            console.error('Passed questionId:', questionId);
            console.error('Question object:', question);
            console.error('Question object ID:', question?.id);
            console.error('Available Reading exams:', this.finalAssessmentsList.filter(q => q.type === 'Reading').map(q => ({ id: q.id, title: q.title })));
            alert('Error: Cannot determine exam ID. Please refresh the page and try again.');
            return;
        }
        
        // Store ID separately to ensure it's always available
        this.selectedReadingExamId = examId;
        console.log('✓ Stored exam ID in selectedReadingExamId:', this.selectedReadingExamId, 'Type:', typeof this.selectedReadingExamId);
        
        // Store the full question object
        this.selectedReadingExam = question || {};
        this.selectedReadingExam.id = examId; // Ensure ID is set
        
        this.readingExamView = 'detail';
        // Load existing passage and questions if available
        this.readingPassage = question?.passage || question?.prompt || question?.description || '';
        this.readingQuestions = question?.questions || [];
        this.currentReadingQuestion = { question: '', optionA: '', optionB: '', optionC: '', optionD: '', correctAnswer: 1, tags: '' };
        // Check if exam has been saved before
        this.readingExamSaved = !!(question?.passage || question?.questions?.length > 0);
        
        // Debug log
        console.log('✓ Opened reading exam detail. Stored ID:', this.selectedReadingExamId);
        console.log('✓ Question object ID:', question?.id);
        console.log('✓ selectedReadingExam.id:', this.selectedReadingExam.id);
    },
    closeReadingExamDetail() {
        this.readingExamView = 'list';
        this.selectedReadingExam = null;
        this.selectedReadingExamId = null;
        this.readingPassage = '';
        this.readingQuestions = [];
        this.currentReadingQuestion = { question: '', optionA: '', optionB: '', optionC: '', optionD: '', correctAnswer: 1, tags: '' };
        this.readingExamSaved = false;
    },
    openListeningExamDetail(question, questionId) {
        // Use the explicitly passed ID first, then try from question object
        let examId = null;
        
        // Priority 1: Use explicitly passed ID
        if (questionId !== undefined && questionId !== null && questionId !== '') {
            examId = parseInt(questionId);
            if (!isNaN(examId)) {
                console.log('Got ID from parameter:', examId);
            } else {
                examId = null;
            }
        }
        
        // Priority 2: Try from question object
        if ((isNaN(examId) || examId === null) && question && question.id !== undefined && question.id !== null) {
            examId = parseInt(question.id);
            if (!isNaN(examId)) {
                console.log('Got ID from question object:', examId);
            } else {
                examId = null;
            }
        }
        
        // Priority 3: Find from list by matching properties
        if (isNaN(examId) || examId === null) {
            this.initFinalAssessments();
            const examInList = this.finalAssessmentsList.find(q => {
                if (q.type !== 'Listening') return false;
                if (question) {
                    return (q.title && question.title && q.title === question.title) ||
                           (q.prompt && question.prompt && q.prompt === question.prompt) ||
                           (q.description && question.description && q.description === question.description);
                }
                return false;
            });
            if (examInList && examInList.id !== undefined && examInList.id !== null) {
                const parsedId = parseInt(examInList.id);
                if (!isNaN(parsedId)) {
                    examId = parsedId;
                    console.log('Found ID from list lookup:', examId);
                }
            }
        }
        
        // Final validation
        if (isNaN(examId) || examId === null) {
            console.error('Cannot determine exam ID.');
            alert('Error: Cannot determine exam ID. Please refresh the page and try again.');
            return;
        }
        
        // Store ID separately
        this.selectedListeningExamId = examId;
        console.log('✓ Stored listening exam ID:', this.selectedListeningExamId);
        
        // Store the full question object
        this.selectedListeningExam = question || {};
        this.selectedListeningExam.id = examId;
        
        this.listeningExamView = 'detail';
        // Load existing data if available
        this.listeningNarration = question?.narration || question?.prompt || question?.description || '';
        this.listeningSpeakers = question?.speakers || [{ role: 'Speaker 1', accent: 'British', script: '' }, { role: 'Speaker 2', accent: 'British', script: '' }];
        this.listeningQuestions = question?.questions || [];
        this.currentListeningQuestion = { question: '', optionA: '', optionB: '', optionC: '', optionD: '', correctAnswer: 1, tags: '' };
        // Check if exam has been saved before
        this.listeningExamSaved = !!(question?.narration || question?.speakers?.length > 0 || question?.questions?.length > 0);
    },
    closeListeningExamDetail() {
        this.listeningExamView = 'list';
        this.selectedListeningExam = null;
        this.selectedListeningExamId = null;
        this.listeningNarration = '';
        this.listeningSpeakers = [{ role: 'Speaker 1', accent: 'British', script: '' }, { role: 'Speaker 2', accent: 'British', script: '' }];
        this.listeningQuestions = [];
        this.currentListeningQuestion = { question: '', optionA: '', optionB: '', optionC: '', optionD: '', correctAnswer: 1, tags: '' };
        this.listeningExamSaved = false;
    },
    addListeningSpeaker() {
        // Allow unlimited speakers, alternating between Speaker 1 and Speaker 2
        const lastSpeaker = this.listeningSpeakers[this.listeningSpeakers.length - 1];
        let nextRole = 'Speaker 1';
        
        if (lastSpeaker) {
            // Determine next speaker role based on last speaker
            if (lastSpeaker.role === 'Speaker 1') {
                nextRole = 'Speaker 2';
            } else {
                nextRole = 'Speaker 1';
            }
        }
        
        this.listeningSpeakers.push({ role: nextRole, accent: 'British', script: '' });
    },
    removeListeningSpeaker(index) {
        if (this.listeningSpeakers.length > 1) {
            this.listeningSpeakers.splice(index, 1);
            // No need to renumber - keep alternating pattern
        } else {
            alert('At least one speaker is required.');
        }
    },
    addListeningQuestion() {
        if (!this.currentListeningQuestion.question || !this.currentListeningQuestion.optionA) {
            alert('Please fill in at least the question and option A');
            return;
        }
        const newQuestion = {
            id: Date.now(),
            question: this.currentListeningQuestion.question,
            optionA: this.currentListeningQuestion.optionA,
            optionB: this.currentListeningQuestion.optionB,
            optionC: this.currentListeningQuestion.optionC,
            optionD: this.currentListeningQuestion.optionD,
            correctAnswer: this.currentListeningQuestion.correctAnswer,
            tags: this.currentListeningQuestion.tags
        };
        this.listeningQuestions.push(newQuestion);
        // Reset form
        this.currentListeningQuestion = { question: '', optionA: '', optionB: '', optionC: '', optionD: '', correctAnswer: 1, tags: '' };
    },
    removeListeningQuestion(questionId) {
        this.listeningQuestions = this.listeningQuestions.filter(q => q.id !== questionId);
    },
    saveListeningExam() {
        // Use the separately stored ID
        let examId = this.selectedListeningExamId;
        
        // If ID is still missing, try to get it from selectedListeningExam
        if (!examId || isNaN(examId)) {
            if (this.selectedListeningExam && this.selectedListeningExam.id) {
                examId = parseInt(this.selectedListeningExam.id);
                this.selectedListeningExamId = examId;
                console.log('Got ID from selectedListeningExam:', examId);
            }
        }
        
        // Last resort: find by matching the current title/narration
        if (!examId || isNaN(examId)) {
            this.initFinalAssessments();
            const examInList = this.finalAssessmentsList.find(q => {
                if (q.type !== 'Listening') return false;
                return (this.selectedListeningExam?.title && q.title === this.selectedListeningExam.title) ||
                       (this.listeningNarration && (q.prompt === this.listeningNarration || q.description === this.listeningNarration));
            });
            if (examInList && examInList.id) {
                examId = parseInt(examInList.id);
                this.selectedListeningExamId = examId;
                console.log('Found ID from list by content match:', examId);
            }
        }
        
        if (!examId || isNaN(examId)) {
            console.error('No valid exam ID found.');
            alert('Error: Exam ID is missing. Please close and reopen the exam.');
            return;
        }
        
        console.log('=== SAVE LISTENING EXAM ===');
        console.log('examId:', examId);
        console.log('Narration length:', this.listeningNarration.length);
        console.log('Speakers count:', this.listeningSpeakers.length);
        console.log('Questions count:', this.listeningQuestions.length);
        
        // Prepare JSON payload
        const payload = {
            id: examId,
            narration: this.listeningNarration || '',
            speakers: this.listeningSpeakers || [],
            questions: this.listeningQuestions || []
        };
        
        // Submit to server as JSON
        fetch('/admin/save-listening-exam', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(payload)
        })
        .then(response => {
            const contentType = response.headers.get('content-type');
            if (!contentType || !contentType.includes('application/json')) {
                return response.text().then(text => {
                    console.error('Server returned non-JSON response:', text.substring(0, 200));
                    throw new Error('Server error: ' + (text.substring(0, 100) || 'Unknown error'));
                });
            }
            if (!response.ok) {
                return response.json().then(data => {
                    throw new Error(data.error || 'Server error');
                });
            }
            return response.json();
        })
        .then(data => {
            if (data.success) {
                console.log('Listening exam saved successfully');
                this.listeningExamSaved = true;
                // Update the exam in the list
                this.initFinalAssessments();
            } else {
                throw new Error(data.error || 'Failed to save listening exam');
            }
        })
        .catch(error => {
            console.error('Error saving listening exam:', error);
            alert('Error saving listening exam: ' + error.message);
        });
    },
    openSpeakingExamDetail(question, questionId) {
        // Use the explicitly passed ID first, then try from question object
        let examId = null;
        
        // Priority 1: Use explicitly passed ID
        if (questionId !== undefined && questionId !== null && questionId !== '') {
            examId = parseInt(questionId);
            if (!isNaN(examId)) {
                console.log('Got ID from parameter:', examId);
            } else {
                examId = null;
            }
        }
        
        // Priority 2: Try from question object
        if ((isNaN(examId) || examId === null) && question && question.id !== undefined && question.id !== null) {
            examId = parseInt(question.id);
            if (!isNaN(examId)) {
                console.log('Got ID from question object:', examId);
            } else {
                examId = null;
            }
        }
        
        // Priority 3: Find from list by matching properties
        if (isNaN(examId) || examId === null) {
            this.initFinalAssessments();
            const examInList = this.finalAssessmentsList.find(q => {
                if (q.type !== 'Speaking') return false;
                if (question) {
                    return (q.title && question.title && q.title === question.title) ||
                           (q.prompt && question.prompt && q.prompt === question.prompt) ||
                           (q.description && question.description && q.description === question.description);
                }
                return false;
            });
            if (examInList && examInList.id !== undefined && examInList.id !== null) {
                const parsedId = parseInt(examInList.id);
                if (!isNaN(parsedId)) {
                    examId = parsedId;
                    console.log('Found ID from list lookup:', examId);
                }
            }
        }
        
        // Final validation
        if (isNaN(examId) || examId === null) {
            console.error('Cannot determine exam ID.');
            alert('Error: Cannot determine exam ID. Please refresh the page and try again.');
            return;
        }
        
        // Store ID separately
        this.selectedSpeakingExamId = examId;
        console.log('✓ Stored speaking exam ID:', this.selectedSpeakingExamId);
        
        // Store the full question object
        this.selectedSpeakingExam = question || {};
        this.selectedSpeakingExam.id = examId;
        
        this.speakingExamView = 'detail';
        // Load existing data if available
        this.speakingModuleContent = question?.moduleContent || question?.prompt || question?.description || '';
        this.speakingCurrentPart = 1; // Default to Part 1
        // Load questions grouped by part
        this.speakingQuestions = {
            part1: question?.questions?.filter(q => q.partId === 1 || q.part === 1) || [],
            part2: question?.questions?.filter(q => q.partId === 2 || q.part === 2) || [],
            part3: question?.questions?.filter(q => q.partId === 3 || q.part === 3) || []
        };
        this.currentSpeakingQuestion = { question: '', tags: '' };
        // Check if exam has been saved before
        this.speakingExamSaved = !!(question?.moduleContent || question?.questions?.length > 0);
    },
    closeSpeakingExamDetail() {
        this.speakingExamView = 'list';
        this.selectedSpeakingExam = null;
        this.selectedSpeakingExamId = null;
        this.speakingModuleContent = '';
        this.speakingCurrentPart = 1;
        this.speakingQuestions = { part1: [], part2: [], part3: [] };
        this.currentSpeakingQuestion = { question: '', tags: '' };
        this.speakingExamSaved = false;
    },
    addSpeakingQuestion() {
        if (!this.currentSpeakingQuestion.question || this.currentSpeakingQuestion.question.trim() === '') {
            alert('Please enter a question prompt');
            return;
        }
        
        const newQuestion = {
            id: Date.now(),
            partId: this.speakingCurrentPart,
            question: this.currentSpeakingQuestion.question.trim(),
            tags: this.currentSpeakingQuestion.tags || ''
        };
        
        // Add to the appropriate part array
        const partKey = `part${this.speakingCurrentPart}`;
        this.speakingQuestions[partKey].push(newQuestion);
        
        // Reset form
        this.currentSpeakingQuestion = { question: '', tags: '' };
    },
    removeSpeakingQuestion(partId, questionId) {
        const partKey = `part${partId}`;
        this.speakingQuestions[partKey] = this.speakingQuestions[partKey].filter(q => q.id !== questionId);
    },
    editSpeakingQuestion(partId, questionId) {
        const partKey = `part${partId}`;
        const question = this.speakingQuestions[partKey].find(q => q.id === questionId);
        if (question) {
            this.currentSpeakingQuestion = {
                question: question.question,
                tags: question.tags || ''
            };
            // Remove the question from the list (will be re-added when saved)
            this.removeSpeakingQuestion(partId, questionId);
            // Switch to the part being edited
            this.speakingCurrentPart = partId;
        }
    },
    saveSpeakingExam() {
        // Use the separately stored ID
        let examId = this.selectedSpeakingExamId;
        
        // If ID is still missing, try to get it from selectedSpeakingExam
        if (!examId || isNaN(examId)) {
            if (this.selectedSpeakingExam && this.selectedSpeakingExam.id) {
                examId = parseInt(this.selectedSpeakingExam.id);
                this.selectedSpeakingExamId = examId;
                console.log('Got ID from selectedSpeakingExam:', examId);
            }
        }
        
        // Last resort: find by matching the current title/moduleContent
        if (!examId || isNaN(examId)) {
            this.initFinalAssessments();
            const examInList = this.finalAssessmentsList.find(q => {
                if (q.type !== 'Speaking') return false;
                return (this.selectedSpeakingExam?.title && q.title === this.selectedSpeakingExam.title) ||
                       (this.speakingModuleContent && (q.prompt === this.speakingModuleContent || q.description === this.speakingModuleContent));
            });
            if (examInList && examInList.id) {
                examId = parseInt(examInList.id);
                this.selectedSpeakingExamId = examId;
                console.log('Found ID from list by content match:', examId);
            }
        }
        
        if (!examId || isNaN(examId)) {
            console.error('No valid exam ID found.');
            alert('Error: Exam ID is missing. Please close and reopen the exam.');
            return;
        }
        
        console.log('=== SAVE SPEAKING EXAM ===');
        console.log('examId:', examId);
        console.log('Module content length:', this.speakingModuleContent.length);
        console.log('Part 1 questions:', this.speakingQuestions.part1.length);
        console.log('Part 2 questions:', this.speakingQuestions.part2.length);
        console.log('Part 3 questions:', this.speakingQuestions.part3.length);
        
        // Combine all questions from all parts into a single array
        const allQuestions = [
            ...this.speakingQuestions.part1,
            ...this.speakingQuestions.part2,
            ...this.speakingQuestions.part3
        ];
        
        // Prepare JSON payload
        const payload = {
            id: examId,
            moduleContent: this.speakingModuleContent || '',
            questions: allQuestions
        };
        
        // Submit to server as JSON
        fetch('/admin/save-speaking-exam', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(payload)
        })
        .then(response => {
            const contentType = response.headers.get('content-type');
            if (!contentType || !contentType.includes('application/json')) {
                return response.text().then(text => {
                    console.error('Server returned non-JSON response:', text.substring(0, 200));
                    throw new Error('Server error: ' + (text.substring(0, 100) || 'Unknown error'));
                });
            }
            if (!response.ok) {
                return response.json().then(data => {
                    throw new Error(data.error || 'Server error');
                });
            }
            return response.json();
        })
        .then(data => {
            if (data.success) {
                console.log('Speaking exam saved successfully');
                this.speakingExamSaved = true;
                // Update the exam in the list
                this.initFinalAssessments();
            } else {
                throw new Error(data.error || 'Failed to save speaking exam');
            }
        })
        .catch(error => {
            console.error('Error saving speaking exam:', error);
            alert('Error saving speaking exam: ' + error.message);
        });
    },
    addReadingQuestion() {
        if (!this.currentReadingQuestion.question || !this.currentReadingQuestion.optionA) {
            alert('Please fill in at least the question and option A');
            return;
        }
        const newQuestion = {
            id: Date.now(),
            question: this.currentReadingQuestion.question,
            optionA: this.currentReadingQuestion.optionA,
            optionB: this.currentReadingQuestion.optionB,
            optionC: this.currentReadingQuestion.optionC,
            optionD: this.currentReadingQuestion.optionD,
            correctAnswer: this.currentReadingQuestion.correctAnswer,
            tags: this.currentReadingQuestion.tags
        };
        this.readingQuestions.push(newQuestion);
        // Reset form
        this.currentReadingQuestion = { question: '', optionA: '', optionB: '', optionC: '', optionD: '', correctAnswer: 1, tags: '' };
    },
    removeReadingQuestion(questionId) {
        this.readingQuestions = this.readingQuestions.filter(q => q.id !== questionId);
    },
    saveReadingExam() {
        // Use the separately stored ID - this is the most reliable method
        let examId = this.selectedReadingExamId;
        
        // If ID is still missing, try to get it from selectedReadingExam
        if (!examId || isNaN(examId)) {
            if (this.selectedReadingExam && this.selectedReadingExam.id) {
                examId = parseInt(this.selectedReadingExam.id);
                this.selectedReadingExamId = examId; // Update stored ID
                console.log('Got ID from selectedReadingExam:', examId);
            }
        }
        
        // Last resort: find by matching the current passage/title
        if (!examId || isNaN(examId)) {
            this.initFinalAssessments();
            const examInList = this.finalAssessmentsList.find(q => {
                if (q.type !== 'Reading') return false;
                // Match by title or passage content
                return (this.selectedReadingExam?.title && q.title === this.selectedReadingExam.title) ||
                       (this.readingPassage && (q.prompt === this.readingPassage || q.description === this.readingPassage));
            });
            if (examInList && examInList.id) {
                examId = parseInt(examInList.id);
                this.selectedReadingExamId = examId;
                console.log('Found ID from list by content match:', examId);
            }
        }
        
        if (!examId || isNaN(examId)) {
            console.error('No valid exam ID found. Stored ID:', this.selectedReadingExamId);
            console.error('Selected exam object:', this.selectedReadingExam);
            console.error('Available Reading exams:', this.finalAssessmentsList.filter(q => q.type === 'Reading'));
            alert('Error: Exam ID is missing. Please close and reopen the exam.');
            return;
        }
        
        console.log('Saving reading exam with ID:', examId, 'Type:', typeof examId);
        console.log('Passage length:', this.readingPassage.length);
        console.log('Questions count:', this.readingQuestions.length);
        console.log('selectedReadingExamId:', this.selectedReadingExamId);
        
        // Prepare JSON payload (not FormData, since we're not uploading files)
        const payload = {
            id: examId,
            passage: this.readingPassage || '',
            questions: this.readingQuestions || []
        };
        
        console.log('Payload to send:', {
            id: payload.id,
            passageLength: payload.passage.length,
            questionsCount: payload.questions.length
        });
        
        // Submit to server as JSON
        fetch('/admin/save-reading-exam', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(payload)
        })
        .then(response => {
            // Check content type to see if it's JSON or HTML
            const contentType = response.headers.get('content-type');
            if (!contentType || !contentType.includes('application/json')) {
                return response.text().then(text => {
                    console.error('Server returned non-JSON response:', text.substring(0, 200));
                    throw new Error('Server error: ' + (text.substring(0, 100) || 'Unknown error'));
                });
            }
            if (!response.ok) {
                return response.json().then(data => {
                    throw new Error(data.error || 'Server error');
                });
            }
            return response.json();
        })
        .then(data => {
            if (data.success) {
                this.readingExamSaved = true;
                // Update the exam in the list
                const index = this.finalAssessmentsList.findIndex(q => parseInt(q.id) === examId);
                if (index > -1) {
                    this.finalAssessmentsList[index].passage = this.readingPassage;
                    this.finalAssessmentsList[index].questions = this.readingQuestions;
                    this.selectedReadingExam = this.finalAssessmentsList[index];
                    this.selectedReadingExamId = examId; // Ensure ID is still set
                }
            } else {
                alert('Error saving reading exam: ' + (data.error || 'Unknown error'));
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Error saving reading exam: ' + error.message);
        });
    },
    saveWritingExam() {
        if (!this.selectedWritingExam) return;
        
        // Show preview modal
        this.showModal = 'writingExamPreview';
    },
    confirmWritingExamSave() {
        if (!this.selectedWritingExam) return;
        
        // Prepare form data
        const formData = new FormData();
        formData.append('id', this.selectedWritingExam.id);
        formData.append('task1Description', this.writingTask1.description);
        formData.append('task1Tags', this.writingTask1.tags);
        formData.append('task2Description', this.writingTask2.description);
        formData.append('task2Tags', this.writingTask2.tags);
        
        // Append image files if they exist
        if (this.writingTask1.image && this.writingTask1.image instanceof File) {
            formData.append('task1Image', this.writingTask1.image);
        }
        if (this.writingTask2.image && this.writingTask2.image instanceof File) {
            formData.append('task2Image', this.writingTask2.image);
        }
        
        // Submit to server
        fetch('/admin/save-writing-exam', {
            method: 'POST',
            body: formData
        })
        .then(response => {
            if (!response.ok) {
                return response.text().then(text => {
                    throw new Error(text || 'Server error');
                });
            }
            return response.json();
        })
        .then(data => {
            if (data.success) {
                this.writingExamSaved = true;
                // Update the exam in the list
                const index = this.finalAssessmentsList.findIndex(q => q.id === this.selectedWritingExam.id);
                if (index > -1) {
                    this.finalAssessmentsList[index].task1 = {
                        description: this.writingTask1.description,
                        tags: this.writingTask1.tags,
                        image: data.task1Image || this.writingTask1.image || null
                    };
                    this.finalAssessmentsList[index].task2 = {
                        description: this.writingTask2.description,
                        tags: this.writingTask2.tags,
                        image: data.task2Image || this.writingTask2.image || null
                    };
                    // Update preview images with saved image paths
                    if (data.task1Image) {
                        this.writingTask1.previewImage = data.task1Image;
                        this.writingTask1.image = data.task1Image;
                    }
                    if (data.task2Image) {
                        this.writingTask2.previewImage = data.task2Image;
                        this.writingTask2.image = data.task2Image;
                    }
                    this.selectedWritingExam = this.finalAssessmentsList[index];
                }
                // Close preview modal and hide content editor
                this.showModal = false;
            } else {
                alert('Error saving writing exam: ' + (data.error || 'Unknown error'));
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Error saving writing exam: ' + error.message);
        });
    },
    // Regular Writing Exams Functions
    initRegularWritingExams() {
        const regularWritingExamsElement = document.getElementById('regular-writing-exams-data');
        if (regularWritingExamsElement && regularWritingExamsElement.textContent) {
            try {
                const data = JSON.parse(regularWritingExamsElement.textContent) || [];
                this.regularWritingExamsList = Array.isArray(data) ? data : [];
            } catch (e) {
                console.error('Error parsing regular writing exams data:', e);
                this.regularWritingExamsList = [];
            }
        } else {
            this.regularWritingExamsList = [];
        }
    },
    openRegularWritingExamDetail(exam) {
        this.selectedRegularWritingExam = exam;
        this.selectedRegularWritingExamId = exam.id;
        this.regularWritingView = 'detail';
        
        // Load existing tasks if available
        if (exam.task1) {
            this.regularWritingTask1 = {
                description: exam.task1.description || '',
                image: exam.task1.image || null,
                tags: exam.task1.tags || '',
                previewImage: exam.task1.image || null
            };
        } else {
            this.regularWritingTask1 = { description: '', image: null, tags: '', previewImage: null };
        }
        if (exam.task2) {
            this.regularWritingTask2 = {
                description: exam.task2.description || '',
                image: exam.task2.image || null,
                tags: exam.task2.tags || '',
                previewImage: exam.task2.image || null
            };
        } else {
            this.regularWritingTask2 = { description: '', image: null, tags: '', previewImage: null };
        }
        
        // Check if exam has been saved before (has task data)
        this.regularWritingExamSaved = !!(exam.task1 || exam.task2);
        this.regularWritingEditMode = !this.regularWritingExamSaved; // New exams start in edit mode
    },
    closeRegularWritingExamDetail() {
        this.regularWritingView = 'list';
        this.selectedRegularWritingExam = null;
        this.selectedRegularWritingExamId = null;
        this.regularWritingTask1 = { description: '', image: null, tags: '', previewImage: null };
        this.regularWritingTask2 = { description: '', image: null, tags: '', previewImage: null };
        this.regularWritingExamSaved = false;
        this.regularWritingEditMode = false;
    },
    handleRegularWritingTaskImageUpload(event, taskNumber) {
        const file = event.target.files[0];
        if (file) {
            const reader = new FileReader();
            reader.onload = (e) => {
                if (taskNumber === 1) {
                    this.regularWritingTask1.previewImage = e.target.result;
                    this.regularWritingTask1.image = file;
                } else {
                    this.regularWritingTask2.previewImage = e.target.result;
                    this.regularWritingTask2.image = file;
                }
            };
            reader.readAsDataURL(file);
        }
    },
    saveRegularWritingExam() {
        if (!this.selectedRegularWritingExamId) {
            alert('Error: Exam ID is missing');
            return;
        }
        
        // Prepare form data
        const formData = new FormData();
        formData.append('examId', this.selectedRegularWritingExamId);
        formData.append('task1Description', this.regularWritingTask1.description || '');
        formData.append('task1Tags', this.regularWritingTask1.tags || '');
        formData.append('task2Description', this.regularWritingTask2.description || '');
        formData.append('task2Tags', this.regularWritingTask2.tags || '');
        
        // Append image files if they exist
        if (this.regularWritingTask1.image && this.regularWritingTask1.image instanceof File) {
            formData.append('task1Image', this.regularWritingTask1.image);
        }
        if (this.regularWritingTask2.image && this.regularWritingTask2.image instanceof File) {
            formData.append('task2Image', this.regularWritingTask2.image);
        }
        
        // Submit to server
        fetch('/admin/save-regular-writing-exam', {
            method: 'POST',
            body: formData
        })
        .then(response => {
            if (!response.ok) {
                return response.text().then(text => {
                    throw new Error(text || 'Server error');
                });
            }
            return response.json();
        })
        .then(data => {
            if (data.success) {
                this.regularWritingExamSaved = true;
                this.regularWritingEditMode = false; // Switch to read-only mode
                
                // Update the exam in the list
                const index = this.regularWritingExamsList.findIndex(q => q.id == this.selectedRegularWritingExamId);
                if (index > -1) {
                    this.regularWritingExamsList[index].task1 = {
                        description: this.regularWritingTask1.description,
                        tags: this.regularWritingTask1.tags,
                        image: data.task1Image || this.regularWritingTask1.image || null
                    };
                    this.regularWritingExamsList[index].task2 = {
                        description: this.regularWritingTask2.description,
                        tags: this.regularWritingTask2.tags,
                        image: data.task2Image || this.regularWritingTask2.image || null
                    };
                    // Update preview images with saved image paths
                    if (data.task1Image) {
                        this.regularWritingTask1.previewImage = data.task1Image;
                        this.regularWritingTask1.image = data.task1Image;
                    }
                    if (data.task2Image) {
                        this.regularWritingTask2.previewImage = data.task2Image;
                        this.regularWritingTask2.image = data.task2Image;
                    }
                    this.selectedRegularWritingExam = this.regularWritingExamsList[index];
                }
                alert('Writing exam saved successfully!');
            } else {
                alert('Error saving writing exam: ' + (data.error || 'Unknown error'));
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Error saving writing exam: ' + error.message);
        });
    },
    // Regular Reading Exams Functions
    initRegularReadingExams() {
        const regularReadingExamsElement = document.getElementById('regular-reading-exams-data');
        if (regularReadingExamsElement && regularReadingExamsElement.textContent) {
            try {
                const data = JSON.parse(regularReadingExamsElement.textContent) || [];
                this.regularReadingExamsList = Array.isArray(data) ? data : [];
            } catch (e) {
                console.error('Error parsing regular reading exams data:', e);
                this.regularReadingExamsList = [];
            }
        } else {
            this.regularReadingExamsList = [];
        }
    },
    openRegularReadingExamDetail(exam) {
        this.selectedRegularReadingExam = exam;
        this.selectedRegularReadingExamId = exam.id;
        this.regularReadingView = 'detail';
        
        // Load existing passage and questions if available
        if (exam.passageTitle) {
            this.regularReadingPassageTitle = exam.passageTitle;
        } else {
            this.regularReadingPassageTitle = '';
        }
        if (exam.passageContent) {
            this.regularReadingPassageContent = exam.passageContent;
        } else {
            this.regularReadingPassageContent = '';
        }
        if (exam.questions && Array.isArray(exam.questions)) {
            this.regularReadingQuestions = exam.questions;
        } else {
            this.regularReadingQuestions = [];
        }
        
        // Check if exam has been saved before (has passage or questions)
        this.regularReadingExamSaved = !!(exam.passageTitle || exam.passageContent || (exam.questions && exam.questions.length > 0));
        this.regularReadingEditMode = !this.regularReadingExamSaved; // New exams start in edit mode
        
        // Reset current question form
        this.currentRegularReadingQuestion = { question: '', optionA: '', optionB: '', optionC: '', optionD: '', correctAnswer: 'A', tags: '' };
    },
    closeRegularReadingExamDetail() {
        this.regularReadingView = 'list';
        this.selectedRegularReadingExam = null;
        this.selectedRegularReadingExamId = null;
        this.regularReadingPassageTitle = '';
        this.regularReadingPassageContent = '';
        this.regularReadingQuestions = [];
        this.currentRegularReadingQuestion = { question: '', optionA: '', optionB: '', optionC: '', optionD: '', correctAnswer: 'A', tags: '' };
        this.regularReadingExamSaved = false;
        this.regularReadingEditMode = false;
    },
    addRegularReadingQuestion() {
        if (!this.currentRegularReadingQuestion.question || !this.currentRegularReadingQuestion.optionA) {
            alert('Please fill in at least the question and option A');
            return;
        }
        
        const newQuestion = {
            id: Date.now(),
            question: this.currentRegularReadingQuestion.question,
            optionA: this.currentRegularReadingQuestion.optionA,
            optionB: this.currentRegularReadingQuestion.optionB || '',
            optionC: this.currentRegularReadingQuestion.optionC || '',
            optionD: this.currentRegularReadingQuestion.optionD || '',
            correctAnswer: this.currentRegularReadingQuestion.correctAnswer || 'A',
            tags: this.currentRegularReadingQuestion.tags || ''
        };
        
        this.regularReadingQuestions.push(newQuestion);
        
        // Reset form
        this.currentRegularReadingQuestion = { question: '', optionA: '', optionB: '', optionC: '', optionD: '', correctAnswer: 'A', tags: '' };
    },
    editRegularReadingQuestion(index) {
        const question = this.regularReadingQuestions[index];
        this.currentRegularReadingQuestion = {
            question: question.question || '',
            optionA: question.optionA || '',
            optionB: question.optionB || '',
            optionC: question.optionC || '',
            optionD: question.optionD || '',
            correctAnswer: question.correctAnswer || 'A',
            tags: question.tags || ''
        };
        // Remove the question from the list (will be re-added when user clicks Add Question)
        this.removeRegularReadingQuestion(index);
    },
    removeRegularReadingQuestion(index) {
        this.regularReadingQuestions.splice(index, 1);
    },
    saveRegularReadingExam() {
        if (!this.selectedRegularReadingExamId) {
            alert('Error: Exam ID is missing');
            return;
        }
        
        // Prepare data
        const examData = {
            examId: this.selectedRegularReadingExamId,
            passageTitle: this.regularReadingPassageTitle || '',
            passageContent: this.regularReadingPassageContent || '',
            questions: this.regularReadingQuestions
        };
        
        // Submit to server
        fetch('/admin/save-regular-reading-exam', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(examData)
        })
        .then(response => {
            if (!response.ok) {
                return response.text().then(text => {
                    throw new Error(text || 'Server error');
                });
            }
            return response.json();
        })
        .then(data => {
            if (data.success) {
                this.regularReadingExamSaved = true;
                this.regularReadingEditMode = false; // Switch to read-only mode
                
                // Update the exam in the list
                const index = this.regularReadingExamsList.findIndex(q => q.id == this.selectedRegularReadingExamId);
                if (index > -1) {
                    this.regularReadingExamsList[index].passageTitle = this.regularReadingPassageTitle;
                    this.regularReadingExamsList[index].passageContent = this.regularReadingPassageContent;
                    this.regularReadingExamsList[index].questions = this.regularReadingQuestions;
                    this.selectedRegularReadingExam = this.regularReadingExamsList[index];
                }
                alert('Reading exam saved successfully!');
            } else {
                alert('Error saving reading exam: ' + (data.error || 'Unknown error'));
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Error saving reading exam: ' + error.message);
        });
    },
    // Regular Listening Exams Functions
    initRegularListeningExams() {
        const regularListeningExamsElement = document.getElementById('regular-listening-exams-data');
        if (regularListeningExamsElement && regularListeningExamsElement.textContent) {
            try {
                const data = JSON.parse(regularListeningExamsElement.textContent) || [];
                this.regularListeningExamsList = Array.isArray(data) ? data : [];
            } catch (e) {
                console.error('Error parsing regular listening exams data:', e);
                this.regularListeningExamsList = [];
            }
        } else {
            this.regularListeningExamsList = [];
        }
    },
    openRegularListeningExamDetail(exam) {
        this.selectedRegularListeningExam = exam;
        this.selectedRegularListeningExamId = exam.id;
        this.regularListeningView = 'detail';
        
        // Load existing data if available
        if (exam.narration) {
            this.regularListeningNarration = exam.narration;
        } else {
            this.regularListeningNarration = '';
        }
        if (exam.scriptBlocks && Array.isArray(exam.scriptBlocks)) {
            this.regularListeningScriptBlocks = exam.scriptBlocks;
        } else {
            this.regularListeningScriptBlocks = [];
        }
        if (exam.questions && Array.isArray(exam.questions)) {
            this.regularListeningQuestions = exam.questions;
        } else {
            this.regularListeningQuestions = [];
        }
        
        // Check if exam has been saved before
        this.regularListeningExamSaved = !!(exam.narration || (exam.scriptBlocks && exam.scriptBlocks.length > 0) || (exam.questions && exam.questions.length > 0));
        this.regularListeningEditMode = !this.regularListeningExamSaved; // New exams start in edit mode
        
        // Reset current question form
        this.currentRegularListeningQuestion = { question: '', optionA: '', optionB: '', optionC: '', optionD: '', correctAnswer: 'A', tags: '' };
    },
    closeRegularListeningExamDetail() {
        this.regularListeningView = 'list';
        this.selectedRegularListeningExam = null;
        this.selectedRegularListeningExamId = null;
        this.regularListeningNarration = '';
        this.regularListeningScriptBlocks = [];
        this.regularListeningQuestions = [];
        this.currentRegularListeningQuestion = { question: '', optionA: '', optionB: '', optionC: '', optionD: '', correctAnswer: 'A', tags: '' };
        this.regularListeningExamSaved = false;
        this.regularListeningEditMode = false;
    },
    addRegularListeningScriptBlock() {
        // Determine next speaker based on last block
        let nextSpeaker = 'Speaker 1';
        if (this.regularListeningScriptBlocks.length > 0) {
            const lastBlock = this.regularListeningScriptBlocks[this.regularListeningScriptBlocks.length - 1];
            if (lastBlock.speaker === 'Speaker 1') {
                nextSpeaker = 'Speaker 2';
            } else {
                nextSpeaker = 'Speaker 1';
            }
        }
        
        const newBlock = {
            id: Date.now(),
            speaker: nextSpeaker,
            accent: 'British',
            line: ''
        };
        
        this.regularListeningScriptBlocks.push(newBlock);
    },
    removeRegularListeningScriptBlock(index) {
        this.regularListeningScriptBlocks.splice(index, 1);
    },
    addRegularListeningQuestion() {
        if (!this.currentRegularListeningQuestion.question || !this.currentRegularListeningQuestion.optionA) {
            alert('Please fill in at least the question and option A');
            return;
        }
        
        const newQuestion = {
            id: Date.now(),
            question: this.currentRegularListeningQuestion.question,
            optionA: this.currentRegularListeningQuestion.optionA,
            optionB: this.currentRegularListeningQuestion.optionB || '',
            optionC: this.currentRegularListeningQuestion.optionC || '',
            optionD: this.currentRegularListeningQuestion.optionD || '',
            correctAnswer: this.currentRegularListeningQuestion.correctAnswer || 'A',
            tags: this.currentRegularListeningQuestion.tags || ''
        };
        
        this.regularListeningQuestions.push(newQuestion);
        
        // Reset form
        this.currentRegularListeningQuestion = { question: '', optionA: '', optionB: '', optionC: '', optionD: '', correctAnswer: 'A', tags: '' };
    },
    editRegularListeningQuestion(index) {
        const question = this.regularListeningQuestions[index];
        this.currentRegularListeningQuestion = {
            question: question.question || '',
            optionA: question.optionA || '',
            optionB: question.optionB || '',
            optionC: question.optionC || '',
            optionD: question.optionD || '',
            correctAnswer: question.correctAnswer || 'A',
            tags: question.tags || ''
        };
        // Remove the question from the list (will be re-added when user clicks Add Question)
        this.removeRegularListeningQuestion(index);
    },
    removeRegularListeningQuestion(index) {
        this.regularListeningQuestions.splice(index, 1);
    },
    saveRegularListeningExam() {
        if (!this.selectedRegularListeningExamId) {
            alert('Error: Exam ID is missing');
            return;
        }
        
        // Prepare data
        const examData = {
            examId: this.selectedRegularListeningExamId,
            narration: this.regularListeningNarration || '',
            scriptBlocks: this.regularListeningScriptBlocks,
            questions: this.regularListeningQuestions
        };
        
        // Submit to server
        fetch('/admin/save-regular-listening-exam', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(examData)
        })
        .then(response => {
            if (!response.ok) {
                return response.text().then(text => {
                    throw new Error(text || 'Server error');
                });
            }
            return response.json();
        })
        .then(data => {
            if (data.success) {
                this.regularListeningExamSaved = true;
                this.regularListeningEditMode = false; // Switch to read-only mode
                
                // Update the exam in the list
                const index = this.regularListeningExamsList.findIndex(q => q.id == this.selectedRegularListeningExamId);
                if (index > -1) {
                    this.regularListeningExamsList[index].narration = this.regularListeningNarration;
                    this.regularListeningExamsList[index].scriptBlocks = this.regularListeningScriptBlocks;
                    this.regularListeningExamsList[index].questions = this.regularListeningQuestions;
                    this.selectedRegularListeningExam = this.regularListeningExamsList[index];
                }
                alert('Listening exam saved successfully!');
            } else {
                alert('Error saving listening exam: ' + (data.error || 'Unknown error'));
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Error saving listening exam: ' + error.message);
        });
    },
    // Regular Speaking Exams Functions
    initRegularSpeakingExams() {
        const regularSpeakingExamsElement = document.getElementById('regular-speaking-exams-data');
        if (regularSpeakingExamsElement && regularSpeakingExamsElement.textContent) {
            try {
                const data = JSON.parse(regularSpeakingExamsElement.textContent) || [];
                this.regularSpeakingExamsList = Array.isArray(data) ? data : [];
            } catch (e) {
                console.error('Error parsing regular speaking exams data:', e);
                this.regularSpeakingExamsList = [];
            }
        } else {
            this.regularSpeakingExamsList = [];
        }
    },
    openRegularSpeakingExamDetail(exam) {
        this.selectedRegularSpeakingExam = exam;
        this.selectedRegularSpeakingExamId = exam.id;
        this.regularSpeakingView = 'detail';
        
        // Load existing data if available
        if (exam.moduleContent) {
            this.regularSpeakingModuleContent = exam.moduleContent;
        } else {
            this.regularSpeakingModuleContent = '';
        }
        if (exam.questions && exam.questions.part1) {
            this.regularSpeakingQuestions.part1 = exam.questions.part1 || [];
        } else {
            this.regularSpeakingQuestions.part1 = [];
        }
        if (exam.questions && exam.questions.part2) {
            this.regularSpeakingQuestions.part2 = exam.questions.part2 || [];
        } else {
            this.regularSpeakingQuestions.part2 = [];
        }
        if (exam.questions && exam.questions.part3) {
            this.regularSpeakingQuestions.part3 = exam.questions.part3 || [];
        } else {
            this.regularSpeakingQuestions.part3 = [];
        }
        
        // Check if exam has been saved before
        this.regularSpeakingExamSaved = !!(exam.moduleContent || (exam.questions && (exam.questions.part1?.length > 0 || exam.questions.part2?.length > 0 || exam.questions.part3?.length > 0)));
        this.regularSpeakingEditMode = !this.regularSpeakingExamSaved; // New exams start in edit mode
        
        // Reset current question form
        this.currentRegularSpeakingQuestion = { question: '', tags: '' };
        this.regularSpeakingCurrentPart = 1; // Start with Part 1
    },
    closeRegularSpeakingExamDetail() {
        this.regularSpeakingView = 'list';
        this.selectedRegularSpeakingExam = null;
        this.selectedRegularSpeakingExamId = null;
        this.regularSpeakingModuleContent = '';
        this.regularSpeakingQuestions = { part1: [], part2: [], part3: [] };
        this.currentRegularSpeakingQuestion = { question: '', tags: '' };
        this.regularSpeakingCurrentPart = 1;
        this.regularSpeakingExamSaved = false;
        this.regularSpeakingEditMode = false;
    },
    getRegularSpeakingQuestionsForPart(part) {
        if (part === 1) return this.regularSpeakingQuestions.part1 || [];
        if (part === 2) return this.regularSpeakingQuestions.part2 || [];
        if (part === 3) return this.regularSpeakingQuestions.part3 || [];
        return [];
    },
    addRegularSpeakingQuestion() {
        if (!this.currentRegularSpeakingQuestion.question) {
            alert('Please enter a question');
            return;
        }
        
        const newQuestion = {
            id: Date.now(),
            question: this.currentRegularSpeakingQuestion.question,
            tags: this.currentRegularSpeakingQuestion.tags || '',
            partId: this.regularSpeakingCurrentPart
        };
        
        // Add to the appropriate part array
        if (this.regularSpeakingCurrentPart === 1) {
            this.regularSpeakingQuestions.part1.push(newQuestion);
        } else if (this.regularSpeakingCurrentPart === 2) {
            this.regularSpeakingQuestions.part2.push(newQuestion);
        } else if (this.regularSpeakingCurrentPart === 3) {
            this.regularSpeakingQuestions.part3.push(newQuestion);
        }
        
        // Reset form
        this.currentRegularSpeakingQuestion = { question: '', tags: '' };
    },
    editRegularSpeakingQuestion(part, index) {
        let question;
        if (part === 1) {
            question = this.regularSpeakingQuestions.part1[index];
        } else if (part === 2) {
            question = this.regularSpeakingQuestions.part2[index];
        } else if (part === 3) {
            question = this.regularSpeakingQuestions.part3[index];
        }
        
        if (question) {
            this.currentRegularSpeakingQuestion = {
                question: question.question || '',
                tags: question.tags || ''
            };
            // Switch to the correct part tab
            this.regularSpeakingCurrentPart = part;
            // Remove the question from the list (will be re-added when user clicks Add Prompt)
            this.removeRegularSpeakingQuestion(part, index);
        }
    },
    removeRegularSpeakingQuestion(part, index) {
        if (part === 1) {
            this.regularSpeakingQuestions.part1.splice(index, 1);
        } else if (part === 2) {
            this.regularSpeakingQuestions.part2.splice(index, 1);
        } else if (part === 3) {
            this.regularSpeakingQuestions.part3.splice(index, 1);
        }
    },
    saveRegularSpeakingExam() {
        if (!this.selectedRegularSpeakingExamId) {
            alert('Error: Exam ID is missing');
            return;
        }
        
        // Prepare data
        const examData = {
            examId: this.selectedRegularSpeakingExamId,
            moduleContent: this.regularSpeakingModuleContent || '',
            questions: {
                part1: this.regularSpeakingQuestions.part1 || [],
                part2: this.regularSpeakingQuestions.part2 || [],
                part3: this.regularSpeakingQuestions.part3 || []
            }
        };
        
        // Submit to server
        fetch('/admin/save-regular-speaking-exam', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(examData)
        })
        .then(response => {
            if (!response.ok) {
                return response.text().then(text => {
                    throw new Error(text || 'Server error');
                });
            }
            return response.json();
        })
        .then(data => {
            if (data.success) {
                this.regularSpeakingExamSaved = true;
                this.regularSpeakingEditMode = false; // Switch to read-only mode
                
                // Update the exam in the list
                const index = this.regularSpeakingExamsList.findIndex(q => q.id == this.selectedRegularSpeakingExamId);
                if (index > -1) {
                    this.regularSpeakingExamsList[index].moduleContent = this.regularSpeakingModuleContent;
                    this.regularSpeakingExamsList[index].questions = {
                        part1: this.regularSpeakingQuestions.part1,
                        part2: this.regularSpeakingQuestions.part2,
                        part3: this.regularSpeakingQuestions.part3
                    };
                    this.selectedRegularSpeakingExam = this.regularSpeakingExamsList[index];
                }
                alert('Speaking exam saved successfully!');
            } else {
                alert('Error saving speaking exam: ' + (data.error || 'Unknown error'));
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Error saving speaking exam: ' + error.message);
        });
    },
    initTags() {
        const tagsDataElement = document.getElementById('tags-data');
        if (tagsDataElement) {
            this.tagsData = JSON.parse(tagsDataElement.textContent) || {};
        }
    },
    initFinalAssessments() {
        const finalAssessmentsElement = document.getElementById('final-assessments-data');
        if (finalAssessmentsElement && finalAssessmentsElement.textContent) {
            try {
                const data = JSON.parse(finalAssessmentsElement.textContent) || [];
                this.finalAssessmentsList = Array.isArray(data) ? data : [];
            } catch (e) {
                console.error('Error parsing final assessments data:', e);
                this.finalAssessmentsList = [];
            }
        } else {
            this.finalAssessmentsList = [];
        }
    },
    getFilteredMockExamQuestions() {
        // Always initialize data first
            this.initFinalAssessments();
        
        if (!this.mockExamSkill) {
            return this.finalAssessmentsList || [];
        }
        
        if (!this.finalAssessmentsList || this.finalAssessmentsList.length === 0) {
            return [];
        }
        
        const skillType = (this.mockExamSkill || '').toLowerCase();
        const filtered = this.finalAssessmentsList.filter(q => {
            if (!q || !q.type) return false;
            const questionType = (q.type || '').toLowerCase();
            return questionType === skillType;
        });
        
        // Debug: Log filtered results
        if (skillType === 'writing') {
            console.log('Filtered Writing questions:', filtered);
        }
        
        return filtered;
    },
    getQuestionCount(skill) {
        if (!this.finalAssessmentsList || this.finalAssessmentsList.length === 0) {
            this.initFinalAssessments();
        }
        if (!skill || !this.finalAssessmentsList) return 0;
        return this.finalAssessmentsList.filter(q => q && q.type && q.type.toLowerCase() === skill.toLowerCase()).length;
    },
    getCurrentTags() {
        if (!this.activeSkill || !this.tagsData[this.activeSkill]) {
            return 'detail_recognition, Numbers, section_1'; // Default fallback
        }
        
        const skillTags = this.tagsData[this.activeSkill];
        let matchingTag = null;
        
        if (this.activeSkill === 'writing') {
            // Find tag matching current task index
            matchingTag = skillTags.find(tag => tag.taskIndex === this.currentWritingTaskIndex);
        } else if (this.activeSkill === 'reading') {
            // Find tag matching current question index
            matchingTag = skillTags.find(tag => tag.questionIndex === this.currentReadingQuestionIndex);
        } else if (this.activeSkill === 'listening') {
            // Find tag matching current question index
            matchingTag = skillTags.find(tag => tag.questionIndex === this.currentListeningQuestionIndex);
        } else if (this.activeSkill === 'speaking') {
            // Find tag matching current part and question (convert to 0-based index)
            matchingTag = skillTags.find(tag => 
                tag.part === this.currentSpeakingPart && 
                tag.questionIndex === (this.currentSpeakingQuestion - 1)
            );
        }
        
        if (matchingTag && matchingTag.tags) {
            return matchingTag.tags.join(', ');
        }
        
        // Fallback to first available tag for the skill
        if (skillTags.length > 0 && skillTags[0].tags) {
            return skillTags[0].tags.join(', ');
        }
        
        return 'detail_recognition, Numbers, section_1'; // Default fallback
    },
    getLevelClass(level) {
        if (!level) return 'bg-gray-100 text-gray-800';
        if (level === 'Beginner') return 'bg-green-100 text-green-800';
        if (level === 'Pre-Intermediate') return 'bg-blue-100 text-blue-800';
        if (level === 'Intermediate') return 'bg-yellow-100 text-yellow-800';
        if (level === 'Advanced') return 'bg-purple-100 text-purple-800';
        return 'bg-gray-100 text-gray-800';
    },
    handleFileUpload(event) {
        const file = event.target.files[0];
        if (file) {
            this.previewImage = URL.createObjectURL(file);
        }
    },
    handleWritingTaskImageUpload(event, taskNumber) {
        const file = event.target.files[0];
        if (file) {
            if (taskNumber === 1) {
                this.writingTask1.previewImage = URL.createObjectURL(file);
                this.writingTask1.image = file;
            } else if (taskNumber === 2) {
                this.writingTask2.previewImage = URL.createObjectURL(file);
                this.writingTask2.image = file;
            }
        }
    },
    getSpeakingQuestion(part, question) {
        const mockQuestions = {
            1: {
                1: 'Tell me about your hometown.',
                2: 'What do you like most about your job or studies?'
            },
            2: {
                1: 'Describe a place you would like to visit. You should say: where it is, what you would do there, and why you want to visit it.',
                2: 'Talk about a memorable event in your life. You should say: when it happened, what you did, and why it was memorable.'
            },
            3: {
                1: 'Do you think tourism has a positive or negative impact on local communities?',
                2: 'How do you think technology has changed the way people travel?'
            }
        };
        return mockQuestions[part]?.[question] || 'No question available.';
    },
    getCurrentSpeakingQuestion() {
        if (!this.selectedModuleData?.content?.speaking) {
            return this.getSpeakingQuestion(this.currentSpeakingPart, this.currentSpeakingQuestion);
        }
        const partKey = 'part' + this.currentSpeakingPart;
        const questionKey = 'question' + this.currentSpeakingQuestion;
        const question = this.selectedModuleData?.content?.speaking?.parts?.[partKey]?.[questionKey];
        return question || this.getSpeakingQuestion(this.currentSpeakingPart, this.currentSpeakingQuestion);
    },
    getSpeakingPartTitle() {
        const titles = {
            1: 'Part 1: Introduction and Interview',
            2: 'Part 2: Long Turn',
            3: 'Part 3: Discussion'
        };
        return titles[this.currentSpeakingPart] || 'Part 1: Introduction and Interview';
    },
    getSpeakingPartTitleForQuestion(part) {
        const titles = {
            1: 'Part 1: Introduction and Interview',
            2: 'Part 2: Long Turn',
            3: 'Part 3: Discussion'
        };
        return titles[part] || 'Part 1: Introduction and Interview';
    },
    initializeMockData(skill) {
        if (!this.selectedModuleData) return;
        
        if (!this.selectedModuleData.content) {
            this.selectedModuleData.content = {};
        }
        
        // Initialize Writing mock data with multiple tasks
        if (skill === 'writing' && !this.selectedModuleData.content.writing?.tasks) {
            this.selectedModuleData.content.writing = {
                tasks: [
                    {
                        image: 'https://placehold.co/600x400?text=Writing+Task+1',
                        description: 'The chart below shows the percentage of households in owned and rented accommodation in England and Wales between 1918 and 2011. Summarize the information by selecting and reporting the main features, and make comparisons where relevant.'
                    },
                    {
                        description: 'Some people think that it is better to educate boys and girls in separate schools. Others, however, believe that boys and girls benefit more from attending mixed schools. Discuss both views and give your own opinion.'
                    }
                ]
            };
        }
        
        // Initialize Reading mock data with multiple questions
        if (skill === 'reading' && !this.selectedModuleData.content.reading?.questions) {
            this.selectedModuleData.content.reading = {
                questions: [
                    {
                        question: 'What is the main idea of the passage?',
                        options: [
                            'A. The importance of reading comprehension',
                            'B. Strategies for improving vocabulary',
                            'C. The history of literature',
                            'D. Techniques for speed reading'
                        ],
                        correctAnswer: 1
                    },
                    {
                        question: 'According to the passage, what is the primary benefit of regular reading?',
                        options: [
                            'A. Improved memory retention',
                            'B. Enhanced critical thinking skills',
                            'C. Better time management',
                            'D. Increased social connections'
                        ],
                        correctAnswer: 2
                    },
                    {
                        question: 'What does the author suggest about reading habits?',
                        options: [
                            'A. Reading should be done only in the morning',
                            'B. Consistency is more important than quantity',
                            'C. Digital books are less effective than print',
                            'D. Reading fiction is more beneficial than non-fiction'
                        ],
                        correctAnswer: 2
                    }
                ]
            };
        }
        
        // Initialize Listening mock data with multiple questions
        if (skill === 'listening' && !this.selectedModuleData.content.listening?.questions) {
            this.selectedModuleData.content.listening = {
                speakerAccent: 'British English',
                speaker1: 'Hello, I would like to book a table for two at 7 PM tonight.',
                speaker2: 'Of course! Let me check our availability. Yes, we have a table available at that time.',
                questions: [
                    {
                        question: 'What is the main topic of the conversation?',
                        options: [
                            'A. Booking a restaurant table',
                            'B. Making a hotel reservation',
                            'C. Ordering food delivery',
                            'D. Canceling a reservation'
                        ],
                        correctAnswer: 1
                    },
                    {
                        question: 'What time does the customer want to book?',
                        options: [
                            'A. 6 PM',
                            'B. 7 PM',
                            'C. 8 PM',
                            'D. 9 PM'
                        ],
                        correctAnswer: 2
                    },
                    {
                        question: 'How many people will be dining?',
                        options: [
                            'A. One',
                            'B. Two',
                            'C. Three',
                            'D. Four'
                        ],
                        correctAnswer: 2
                    }
                ]
            };
        }
        
        // Initialize Speaking mock data structure
        if (skill === 'speaking' && !this.selectedModuleData.content.speaking?.parts) {
            this.selectedModuleData.content.speaking = {
                parts: {
                    part1: {
                        question1: 'Tell me about your hometown.',
                        question2: 'What do you like most about your job or studies?'
                    },
                    part2: {
                        question1: 'Describe a place you would like to visit. You should say: where it is, what you would do there, and why you want to visit it.',
                        question2: 'Talk about a memorable event in your life. You should say: when it happened, what you did, and why it was memorable.'
                    },
                    part3: {
                        question1: 'Do you think tourism has a positive or negative impact on local communities?',
                        question2: 'How do you think technology has changed the way people travel?'
                    }
                }
            };
        }
    },
    initUsers() {
        const usersDataElement = document.getElementById('users-data');
        if (usersDataElement) {
            this.usersList = JSON.parse(usersDataElement.textContent) || [];
        }
    },
    sortByCreatedAt() {
        if (this.createdAtSortOrder === 'asc') {
            this.createdAtSortOrder = 'desc';
        } else if (this.createdAtSortOrder === 'desc') {
            this.createdAtSortOrder = null;
        } else {
            this.createdAtSortOrder = 'asc';
        }
        
        if (this.createdAtSortOrder === null) {
            this.initUsers();
            return;
        }
        
        this.usersList.sort((a, b) => {
            const dateA = a.createdAt ? new Date(a.createdAt).getTime() : 0;
            const dateB = b.createdAt ? new Date(b.createdAt).getTime() : 0;
            
            if (this.createdAtSortOrder === 'asc') {
                return dateA - dateB;
            } else {
                return dateB - dateA;
            }
        });
    },
    initModules() {
        const modulesDataElement = document.getElementById('modules-data');
        if (modulesDataElement) {
            this.modulesList = JSON.parse(modulesDataElement.textContent) || [];
        }
    },
    sortByStatus() {
        if (this.statusSortOrder === 'asc') {
            this.statusSortOrder = 'desc';
        } else if (this.statusSortOrder === 'desc') {
            this.statusSortOrder = null;
        } else {
            this.statusSortOrder = 'asc';
        }
        
        if (this.statusSortOrder === null) {
            this.initModules();
            return;
        }
        
        this.modulesList.sort((a, b) => {
            const statusA = (a.status === 'Pending' || a.status === 'Pending Validation') ? 'Pending' : 'Validated';
            const statusB = (b.status === 'Pending' || b.status === 'Pending Validation') ? 'Pending' : 'Validated';
            
            // Sort: Pending comes before Validated
            const orderA = statusA === 'Pending' ? 0 : 1;
            const orderB = statusB === 'Pending' ? 0 : 1;
            
            if (this.statusSortOrder === 'asc') {
                return orderA - orderB;
            } else {
                return orderB - orderA;
            }
        });
    }
}">

    <!-- Users Data (hidden, for Alpine.js initialization) -->
    <script id="users-data" type="application/json"><%- JSON.stringify(users) %></script>
    
    <!-- Modules Data (hidden, for Alpine.js initialization) -->
    <script id="modules-data" type="application/json"><%- JSON.stringify(pendingModules) %></script>
    
    <!-- Tags Data (hidden, for Alpine.js initialization) -->
    <script id="tags-data" type="application/json"><%- JSON.stringify(tags) %></script>
    
    <!-- Final Assessments Data (hidden, for Alpine.js initialization) -->
    <script id="final-assessments-data" type="application/json"><%- JSON.stringify(finalAssessments || []) %></script>
    
    <!-- Regular Writing Exams Data (hidden, for Alpine.js initialization) -->
    <script id="regular-writing-exams-data" type="application/json"><%- JSON.stringify(regularWritingExams || []) %></script>
    
    <!-- Regular Reading Exams Data (hidden, for Alpine.js initialization) -->
    <script id="regular-reading-exams-data" type="application/json"><%- JSON.stringify(regularReadingExams || []) %></script>
    
    <!-- Regular Listening Exams Data (hidden, for Alpine.js initialization) -->
    <script id="regular-listening-exams-data" type="application/json"><%- JSON.stringify(regularListeningExams || []) %></script>
    
    <!-- Regular Speaking Exams Data (hidden, for Alpine.js initialization) -->
    <script id="regular-speaking-exams-data" type="application/json"><%- JSON.stringify(regularSpeakingExams || []) %></script>
    
    
    <!-- Top Navigation -->
    <nav class="bg-white shadow-sm border-b border-gray-200 fixed w-full z-30">
        <div class="px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between h-16">
                <div class="flex items-center gap-3">
                    <img src="/img/logo.png" alt="Logo" class="h-8 w-auto">
                    <span class="text-xl font-bold text-gray-800 border-l border-gray-300 pl-3 ml-3">Admin Portal</span>
                </div>
                <div class="flex items-center gap-4">
                    <a href="/" class="text-sm text-gray-600 hover:text-blue-600">View Live Site</a>
                    <span class="text-gray-300">|</span>
                    <a href="/logout" class="text-sm font-medium text-red-600 hover:text-red-800">Logout</a>
                    <div class="h-8 w-8 rounded-full bg-blue-100 flex items-center justify-center text-blue-700 font-bold">A</div>
                </div>
            </div>
        </div>
    </nav>

    <div class="flex h-screen pt-16">
        <!-- Sidebar -->
        <aside class="w-64 bg-white border-r border-gray-200 hidden md:block flex-shrink-0">
            <div class="p-4 space-y-1">
                <a href="/admin/dashboard" class="w-full flex items-center space-x-3 px-4 py-3 rounded-lg text-gray-600 hover:bg-gray-50 transition">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2V6zM14 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2V6zM4 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2v-2zM14 16a2 2 0 012-2h2a2 2 0 01-2 2h-2a2 2 0 01-2-2v-2z"></path></svg>
                    <span>Dashboard</span>
                </a>
                <div class="pt-4 pb-2 px-4 text-xs font-semibold text-gray-400 uppercase tracking-wider">Manage</div>
                <button @click="currentTab = 'users'" :class="currentTab === 'users' ? 'bg-blue-50 text-blue-700' : 'text-gray-600 hover:bg-gray-50'" class="w-full flex items-center space-x-3 px-4 py-3 rounded-lg font-medium transition">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M13 7a4 4 0 11-8 0 4 4 0 018 0z"></path></svg>
                    <span>Users</span>
                </button>
                <button @click="currentTab = 'modules'; moduleView = 'list'" :class="currentTab === 'modules' ? 'bg-blue-50 text-blue-700' : 'text-gray-600 hover:bg-gray-50'" class="w-full flex items-center space-x-3 px-4 py-3 rounded-lg font-medium transition">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10"></path></svg>
                    <span>Modules</span>
                </button>
                <div class="pt-4 pb-2 px-4">
                    <button @click="assessmentCenterOpen = !assessmentCenterOpen" class="w-full flex items-center justify-between text-xs font-semibold text-gray-400 uppercase tracking-wider hover:text-gray-600 transition">
                        <span>Assessment Center</span>
                        <svg class="w-4 h-4 transition-transform" :class="assessmentCenterOpen ? 'rotate-180' : ''" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                        </svg>
                    </button>
                </div>
                <div x-show="assessmentCenterOpen" x-transition:enter="transition ease-out duration-200" x-transition:enter-start="opacity-0 transform -translate-y-2" x-transition:enter-end="opacity-100 transform translate-y-0" x-transition:leave="transition ease-in duration-150" x-transition:leave-start="opacity-100 transform translate-y-0" x-transition:leave-end="opacity-0 transform -translate-y-2">
                    <button @click="currentTab = 'testbank'" :class="currentTab === 'testbank' ? 'bg-blue-50 text-blue-700' : 'text-gray-600 hover:bg-gray-50'" class="w-full flex items-center space-x-3 px-4 py-3 rounded-lg font-medium transition">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-3 7h3m-3 4h3m-6-4h.01M9 16h.01"></path></svg>
                        <span>Regular User Test Bank</span>
                    </button>
                    <button @click="currentTab = 'abel'" :class="currentTab === 'abel' ? 'bg-purple-50 text-purple-700' : 'text-gray-600 hover:bg-gray-50'" class="w-full flex items-center space-x-3 px-4 py-3 rounded-lg font-medium transition">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                        <span>IELTS Mock Exam</span>
                    </button>
                </div>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="flex-1 overflow-y-auto p-8">
            
            <!-- 1. USERS TAB -->
            <div x-show="currentTab === 'users'" x-transition.opacity x-init="initUsers()">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-2xl font-bold text-gray-800">User Management</h2>
                </div>
                <div class="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Name</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Level</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Pre-assessment Result</th>
                                <th 
                                    @click="sortByCreatedAt()"
                                    class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer hover:bg-gray-100 transition flex items-center gap-1"
                                >
                                    Created at
                                    <span class="ml-1">
                                        <template x-if="createdAtSortOrder === 'asc'">
                                            <svg class="w-4 h-4 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 15l7-7 7 7"></path>
                                            </svg>
                                        </template>
                                        <template x-if="createdAtSortOrder === 'desc'">
                                            <svg class="w-4 h-4 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                                            </svg>
                                        </template>
                                        <template x-if="!createdAtSortOrder">
                                            <svg class="w-4 h-4 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16V4m0 0L3 8m4-4l4 4m6 0v12m0 0l4-4m-4 4l-4-4"></path>
                                            </svg>
                                        </template>
                                    </span>
                                </th>
                                <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                            </tr>
                        </thead>
                        <tbody class="bg-white divide-y divide-gray-200">
                            <template x-for="user in usersList" :key="user.id">
                                <tr 
                                    :data-user="JSON.stringify(user)"
                                    class="hover:bg-gray-50 transition group"
                                >
                                    <td class="px-6 py-4">
                                        <div class="flex items-center gap-3">
                                            <template x-if="user.photoURL">
                                                <img 
                                                    :src="user.photoURL" 
                                                    :alt="user.name" 
                                                    class="w-10 h-10 rounded-full object-cover cursor-pointer hover:ring-2 hover:ring-blue-500 transition"
                                                    @click="window.open(user.photoURL, '_blank')"
                                                >
                                            </template>
                                            <template x-if="!user.photoURL">
                                                <div class="w-10 h-10 rounded-full bg-gray-200 flex items-center justify-center text-gray-500 font-semibold">
                                                    <span x-text="user.name ? user.name.charAt(0).toUpperCase() : 'U'"></span>
                                                </div>
                                            </template>
                                            <div>
                                                <div class="text-sm font-medium text-gray-900" x-text="user.name"></div>
                                                <div class="text-sm text-gray-500" x-text="user.email"></div>
                                            </div>
                                        </div>
                                    </td>
                                    <td class="px-6 py-4 whitespace-nowrap">
                                        <span 
                                            :data-user="JSON.stringify(user)"
                                            @click="showModal = 'viewStats'; viewUser = JSON.parse($el.dataset.user)"
                                            class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full cursor-pointer hover:opacity-80 transition" 
                                            :class="getLevelClass(user.level)"
                                            x-text="user.level || 'Not Set'"
                                        ></span>
                                    </td>
                                    <td class="px-6 py-4 whitespace-nowrap">
                                        <div 
                                            :data-user="JSON.stringify(user)"
                                            @click="showModal = 'viewStats'; viewUser = JSON.parse($el.dataset.user)"
                                            class="inline-flex items-center gap-1 px-3 py-1.5 bg-yellow-100 rounded-full cursor-pointer hover:bg-yellow-200 transition"
                                        >
                                            <span class="text-sm font-semibold text-gray-800" x-text="(user.preAssessmentResult || 100) + '%'"></span>
                                            <svg class="w-4 h-4 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                                            </svg>
                                        </div>
                                    </td>
                                    <td class="px-6 py-4 whitespace-nowrap">
                                        <div class="text-sm text-gray-500" x-text="user.createdAt ? new Date(user.createdAt).toLocaleDateString('en-US', { year: 'numeric', month: 'short', day: 'numeric' }) : 'Not available'"></div>
                                        <div class="text-xs text-gray-400">Account Creation</div>
                                    </td>
                                    <td class="px-6 py-4 text-right text-sm font-medium">
                                        <div class="flex justify-end space-x-3">
                                            <button 
                                                :data-user="JSON.stringify(user)"
                                                @click.stop="showModal = 'editUser'; editItem = JSON.parse($el.dataset.user)" 
                                                class="text-blue-600 hover:text-blue-900 bg-gray-100 p-2 rounded-full hover:bg-blue-100 transition">
                                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z" /></svg>
                                            </button>
                                            <form action="/admin/delete-user" method="POST" onsubmit="return confirm('Are you sure?');" @click.stop>
                                                <input type="hidden" name="id" :value="user.id">
                                                <button type="submit" class="text-red-600 hover:text-red-900 bg-gray-100 p-2 rounded-full hover:bg-red-100 transition">
                                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg>
                                                </button>
                                            </form>
                                        </div>
                                    </td>
                                </tr>
                            </template>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- 2. MODULE MANAGEMENT -->
            <div x-show="currentTab === 'modules'" x-cloak x-transition.opacity>
                
                <!-- A. LIST VIEW: Select User -->
                <div x-show="moduleView === 'list'" x-init="initModules(); initTags()">
                    <div class="flex justify-between items-center mb-6">
                        <h2 class="text-2xl font-bold text-gray-800">Module Management</h2>
                    </div>
                    <div class="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Name</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Role</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Rank</th>
                                    <th 
                                        @click="sortByStatus()"
                                        class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer hover:bg-gray-100 transition flex items-center gap-1"
                                    >
                                        Status
                                        <span class="ml-1">
                                            <template x-if="statusSortOrder === 'asc'">
                                                <svg class="w-4 h-4 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 15l7-7 7 7"></path>
                                                </svg>
                                            </template>
                                            <template x-if="statusSortOrder === 'desc'">
                                                <svg class="w-4 h-4 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                                                </svg>
                                            </template>
                                            <template x-if="!statusSortOrder">
                                                <svg class="w-4 h-4 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16V4m0 0L3 8m4-4l4 4m6 0v12m0 0l4-4m-4 4l-4-4"></path>
                                                </svg>
                                            </template>
                                        </span>
                                    </th>
                                    <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Action</th>
                                </tr>
                            </thead>
                            <tbody class="bg-white divide-y divide-gray-200">
                                <template x-for="item in modulesList" :key="item.id || item.userEmail">
                                    <tr 
                                        :data-item="JSON.stringify(item)"
                                        @click="moduleView = 'detail'; selectedUser = JSON.parse($el.dataset.item); currentModuleIndex = 0"
                                        class="hover:bg-gray-50 transition cursor-pointer group"
                                    >
                                        <td class="px-6 py-4">
                                            <div class="text-sm font-medium text-gray-900 group-hover:text-blue-600 transition" x-text="item.userName"></div>
                                            <div class="text-sm text-gray-500" x-text="item.userEmail"></div>
                                        </td>
                                        <td class="px-6 py-4 text-sm text-gray-500" x-text="item.userRole"></td>
                                        <td class="px-6 py-4 whitespace-nowrap">
                                            <span class="text-sm font-semibold text-gray-900" x-text="item.userRank"></span>
                                        </td>
                                        <td class="px-6 py-4">
                                            <template x-if="item.status === 'Pending' || item.status === 'Pending Validation'">
                                                <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-yellow-100 text-yellow-800">Pending</span>
                                            </template>
                                            <template x-if="item.status !== 'Pending' && item.status !== 'Pending Validation'">
                                                <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-800">Validated</span>
                                            </template>
                                        </td>
                                        <td class="px-6 py-4 text-right text-sm text-gray-400 group-hover:text-blue-600">
                                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 inline-block" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" /></svg>
                                        </td>
                                    </tr>
                                </template>
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- B. DETAIL VIEW: Selected User -> Module List -->
                <div x-show="moduleView === 'detail'" x-cloak class="h-full">
                    <div class="bg-white p-6 rounded-t-xl border-b border-gray-200 flex justify-between items-center">
                        <div class="flex items-center gap-4">
                            <button @click="moduleView = 'list'" class="text-gray-500 hover:text-gray-800 transition">
                                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"></path></svg>
                            </button>
                            <h2 class="text-xl font-bold text-gray-800 flex items-center">
                                <span x-text="selectedUser?.userName"></span> 
                                <span class="text-gray-400 mx-2">•</span> 
                                <span class="px-2 py-0.5 rounded-full text-xs font-semibold" :class="getLevelClass(selectedUser?.userRank)" x-text="selectedUser?.userRank"></span>
                            </h2>
                        </div>
                        <div class="flex gap-3">
                            <button @click="showModal = 'moduleStats'" class="bg-blue-600 text-white px-5 py-2.5 rounded-lg shadow hover:bg-blue-700 transition text-sm font-semibold flex items-center gap-2">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path></svg>
                                View Stats
                            </button>
                        </div>
                    </div>

                    <div class="w-full bg-white rounded-b-xl shadow-sm border-x border-b border-gray-200 p-8" x-show="selectedUser?.modules?.length > 0">
                        <div class="flex justify-between items-center mb-8 border-b border-gray-100 pb-4">
                            <h3 class="font-bold text-gray-900 text-2xl" x-text="selectedUser?.modules[currentModuleIndex]?.title"></h3>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div @click="moduleView = 'content'; selectedModuleData = selectedUser?.modules[currentModuleIndex]; activeSkill = 'writing'; currentWritingTaskIndex = 0; initializeMockData('writing')" class="flex items-center gap-4 cursor-pointer group hover:bg-blue-50 p-4 rounded-xl transition border border-gray-100 hover:border-blue-200 bg-gray-50">
                                <div class="bg-blue-100 p-3 rounded-full text-blue-600"><svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path></svg></div>
                                <div><h4 class="font-bold text-gray-800 text-lg group-hover:text-blue-700 mb-1">Writing</h4><p class="text-sm text-gray-500">Develop coherent and well-structured responses</p></div>
                            </div>
                            <div @click="moduleView = 'content'; selectedModuleData = selectedUser?.modules[currentModuleIndex]; activeSkill = 'reading'; currentReadingQuestionIndex = 0; initializeMockData('reading')" class="flex items-center gap-4 cursor-pointer group hover:bg-blue-50 p-4 rounded-xl transition border border-gray-100 hover:border-blue-200 bg-gray-50">
                                <div class="bg-green-100 p-3 rounded-full text-green-600"><svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253"></path></svg></div>
                                <div><h4 class="font-bold text-gray-800 text-lg group-hover:text-blue-700">Reading</h4><p class="text-sm text-gray-500">Boost your comprehension and skimming skills</p></div>
                            </div>
                            <div @click="moduleView = 'content'; selectedModuleData = selectedUser?.modules[currentModuleIndex]; activeSkill = 'listening'; currentListeningQuestionIndex = 0; initializeMockData('listening')" class="flex items-center gap-4 cursor-pointer group hover:bg-blue-50 p-4 rounded-xl transition border border-gray-100 hover:border-blue-200 bg-gray-50">
                                <div class="bg-purple-100 p-3 rounded-full text-purple-600"><svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.536 8.464a5 5 0 010 7.072m2.828-9.9a9 9 0 010 12.728M5.586 15H4a1 1 0 01-1-1v-4a1 1 0 011-1h1.586l4.707-4.707C10.923 3.663 12 4.109 12 5v14c0 .891-1.077 1.337-1.707.707L5.586 15z"></path></svg></div>
                                <div><h4 class="font-bold text-gray-800 text-lg group-hover:text-blue-700">Listening</h4><p class="text-sm text-gray-500">Enhance your focus and audio understanding</p></div>
                            </div>
                            <div @click="moduleView = 'content'; selectedModuleData = selectedUser?.modules[currentModuleIndex]; activeSkill = 'speaking'; currentWritingTaskIndex = 0; currentSpeakingPart = 1; currentSpeakingQuestion = 1; initializeMockData('speaking')" class="flex items-center gap-4 cursor-pointer group hover:bg-blue-50 p-4 rounded-xl transition border border-gray-100 hover:border-blue-200 bg-gray-50">
                                <div class="bg-yellow-100 p-3 rounded-full text-yellow-600"><svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11a7 7 0 01-7 7m0 0a7 7 0 01-7-7m7 7v4m0 0H8m4 0h4m-4-8a3 3 0 01-3-3V5a3 3 0 116 0v6a3 3 0 01-3 3z"></path></svg></div>
                                <div><h4 class="font-bold text-gray-800 text-lg group-hover:text-blue-700">Speaking</h4><p class="text-sm text-gray-500">Build fluency, improve pronunciation, and speak with clarity</p></div>
                            </div>
                        </div>
                        <div class="flex justify-center items-center gap-4 mt-10 pt-6 border-t border-gray-100" x-show="selectedUser?.modules?.length > 1">
                            <button @click="if(currentModuleIndex > 0) currentModuleIndex--" :disabled="currentModuleIndex === 0" class="px-5 py-2.5 rounded-full border border-gray-300 hover:bg-gray-50 disabled:opacity-40 disabled:cursor-not-allowed flex items-center gap-2 text-gray-700 font-medium transition shadow-sm"><svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path></svg> Previous Module</button>
                            <span class="text-sm font-medium text-gray-900"><span x-text="currentModuleIndex + 1"></span> / <span x-text="selectedUser?.modules?.length"></span></span>
                            <button @click="if(currentModuleIndex < selectedUser?.modules?.length - 1) currentModuleIndex++" :disabled="currentModuleIndex === selectedUser?.modules?.length - 1" class="px-5 py-2.5 rounded-full bg-black text-white hover:bg-gray-800 disabled:bg-gray-300 disabled:cursor-not-allowed flex items-center gap-2 font-medium transition shadow-lg">Next Module <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path></svg></button>
                        </div>
                    </div>
                </div>

                <!-- C. CONTENT VIEW (Clean & Scrollable Card) -->
                <div x-show="moduleView === 'content'" x-cloak x-init="initTags()" class="flex flex-col h-[calc(100vh-80px)]">
                    <div class="bg-white border-b py-4 px-6 flex justify-between items-center">
                        <div class="flex items-center gap-3">
                            <button @click="moduleView = 'detail'" class="text-gray-500 hover:text-gray-800 p-2 hover:bg-gray-100 rounded-full transition">
                                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"></path></svg>
                            </button>
                            <div><h2 class="text-2xl font-bold text-gray-900 capitalize" x-text="activeSkill"></h2><p class="text-sm text-gray-500" x-text="selectedModuleData?.title"></p></div>
                        </div>
                        <div class="flex gap-2">
                            <template x-if="selectedUser?.status !== 'Validated'">
                                <form action="/admin/validate-module" method="POST" class="inline">
                                    <input type="hidden" name="id" :value="selectedUser?.id">
                                    <button type="submit" class="bg-green-500 text-white px-5 py-2.5 rounded-lg shadow hover:bg-green-600 transition text-sm font-semibold flex items-center gap-2">
                                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg>
                                        Validate
                                    </button>
                                </form>
                            </template>
                            <template x-if="selectedUser?.status === 'Validated'">
                                <button disabled class="bg-gray-100 text-gray-400 px-5 py-2.5 rounded-lg border border-gray-200 cursor-not-allowed text-sm font-semibold flex items-center gap-2">
                                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg>
                                    Validated
                                </button>
                            </template>
                            <form action="/admin/regenerate-module" method="POST" class="inline"><button type="submit" class="bg-purple-600 text-white px-5 py-2.5 rounded-lg shadow hover:bg-purple-700 transition text-sm font-semibold flex items-center gap-2"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path></svg>Regenerate Content</button></form>
                        </div>
                    </div>
                    <!-- Clean Card Content Area -->
                    <div class="flex-1 p-8 flex justify-center bg-gray-50 overflow-y-auto">
                        <!-- Left: Editor Placeholder -->
                        <div class="flex-1 bg-white border rounded-xl p-8 shadow-sm flex flex-col border-dashed border-gray-300 mr-8 max-w-xl">
                             <template x-if="activeSkill === 'listening'">
                                 <div class="space-y-6">
                                     <div>
                                         <label class="block text-sm font-medium text-gray-700 mb-2">Speaker Accent</label>
                                         <div class="px-4 py-3 bg-gray-50 border border-gray-200 rounded-lg">
                                             <p class="text-sm text-gray-800 font-medium" x-text="selectedModuleData?.content?.listening?.speakerAccent || 'British English'"></p>
                                         </div>
                                     </div>
                                     <div>
                                         <label class="block text-sm font-medium text-gray-700 mb-2">Speaker 1</label>
                                         <div class="px-4 py-3 bg-gray-50 border border-gray-200 rounded-lg">
                                             <p class="text-sm text-gray-600 leading-relaxed" x-text="selectedModuleData?.content?.listening?.speaker1 || 'Hello, I would like to book a table for two at 7 PM tonight.'"></p>
                                         </div>
                                     </div>
                                     <div>
                                         <label class="block text-sm font-medium text-gray-700 mb-2">Speaker 2</label>
                                         <div class="px-4 py-3 bg-gray-50 border border-gray-200 rounded-lg">
                                             <p class="text-sm text-gray-600 leading-relaxed" x-text="selectedModuleData?.content?.listening?.speaker2 || 'Of course! Let me check our availability. Yes, we have a table available at that time.'"></p>
                                         </div>
                                     </div>
                                 </div>
                             </template>
                             <template x-if="activeSkill !== 'listening'">
                                 <div class="flex flex-col items-center justify-center w-full h-full">
                             <p class="text-gray-400 text-lg font-medium mb-2">Content Editor</p>
                             <p class="text-sm text-gray-500">Admin can edit the generated content here.</p>
                                 </div>
                             </template>
                        </div>

                        <!-- Right: Clean Preview Card (No Phone Style) -->
                        <div class="w-full max-w-md bg-white rounded-xl shadow-md border border-gray-200 flex flex-col h-fit overflow-hidden">
                            <div class="p-8">
                                <h4 class="text-2xl font-bold text-gray-900 mb-6 flex items-center gap-2">
                                    <span class="capitalize" x-text="activeSkill"></span>
                                    <template x-if="activeSkill === 'writing'">
                                        <span class="text-gray-500 font-normal" x-text="'Task ' + (currentWritingTaskIndex + 1)"></span>
                                    </template>
                                    <template x-if="activeSkill === 'reading'">
                                        <span class="text-gray-500 font-normal" x-text="'Question ' + (currentReadingQuestionIndex + 1)"></span>
                                    </template>
                                    <template x-if="activeSkill === 'listening'">
                                        <span class="text-gray-500 font-normal" x-text="'Question ' + (currentListeningQuestionIndex + 1)"></span>
                                    </template>
                                </h4>
                                
                                <!-- Writing Layout: Image + Description -->
                                <template x-if="activeSkill === 'writing'">
                                    <div>
                                        <template x-if="selectedModuleData?.content?.writing?.tasks?.[currentWritingTaskIndex]?.image || selectedModuleData?.content?.writing?.image">
                                            <div class="mb-6">
                                                <div class="w-full rounded-lg overflow-hidden bg-gray-100">
                                                    <img :src="selectedModuleData?.content?.writing?.tasks?.[currentWritingTaskIndex]?.image || selectedModuleData?.content?.writing?.image" alt="Writing prompt image" class="w-full h-auto object-cover">
                                                </div>
                                            </div>
                                        </template>
                                        <div>
                                            <p class="text-sm text-gray-600 leading-relaxed" x-text="selectedModuleData?.content?.writing?.tasks?.[currentWritingTaskIndex]?.description || selectedModuleData?.content?.writing?.description || 'No description available.'"></p>
                                        </div>
                                    </div>
                                </template>

                                <!-- Listening Layout: Multiple Choice (4 options) -->
                                <template x-if="activeSkill === 'listening'">
                                    <div>
                                        <!-- Question -->
                                        <div class="mb-6">
                                            <p class="text-lg text-gray-800 font-medium leading-relaxed" x-text="selectedModuleData?.content?.listening?.questions?.[currentListeningQuestionIndex]?.question || selectedModuleData?.content?.listening?.question || 'What is the main topic of the conversation?'"></p>
                                        </div>

                                        <!-- Multiple Choice Options (4 choices) -->
                                        <div class="space-y-3">
                                            <div class="p-3 border rounded-lg transition" 
                                                 :class="(selectedModuleData?.content?.listening?.questions?.[currentListeningQuestionIndex]?.correctAnswer || selectedModuleData?.content?.listening?.correctAnswer || 1) === 1 ? 'border-blue-500 bg-blue-50' : 'border-gray-200 bg-gray-50'">
                                                <p class="text-sm text-gray-700" x-text="selectedModuleData?.content?.listening?.questions?.[currentListeningQuestionIndex]?.options?.[0] || selectedModuleData?.content?.listening?.options?.[0] || 'A. Booking a restaurant table'"></p>
                                            </div>
                                            <div class="p-3 border rounded-lg transition" 
                                                 :class="(selectedModuleData?.content?.listening?.questions?.[currentListeningQuestionIndex]?.correctAnswer || selectedModuleData?.content?.listening?.correctAnswer || 1) === 2 ? 'border-blue-500 bg-blue-50' : 'border-gray-200 bg-gray-50'">
                                                <p class="text-sm text-gray-700" x-text="selectedModuleData?.content?.listening?.questions?.[currentListeningQuestionIndex]?.options?.[1] || selectedModuleData?.content?.listening?.options?.[1] || 'B. Making a hotel reservation'"></p>
                                            </div>
                                            <div class="p-3 border rounded-lg transition" 
                                                 :class="(selectedModuleData?.content?.listening?.questions?.[currentListeningQuestionIndex]?.correctAnswer || selectedModuleData?.content?.listening?.correctAnswer || 1) === 3 ? 'border-blue-500 bg-blue-50' : 'border-gray-200 bg-gray-50'">
                                                <p class="text-sm text-gray-700" x-text="selectedModuleData?.content?.listening?.questions?.[currentListeningQuestionIndex]?.options?.[2] || selectedModuleData?.content?.listening?.options?.[2] || 'C. Ordering food delivery'"></p>
                                            </div>
                                            <div class="p-3 border rounded-lg transition" 
                                                 :class="(selectedModuleData?.content?.listening?.questions?.[currentListeningQuestionIndex]?.correctAnswer || selectedModuleData?.content?.listening?.correctAnswer || 1) === 4 ? 'border-blue-500 bg-blue-50' : 'border-gray-200 bg-gray-50'">
                                                <p class="text-sm text-gray-700" x-text="selectedModuleData?.content?.listening?.questions?.[currentListeningQuestionIndex]?.options?.[3] || selectedModuleData?.content?.listening?.options?.[3] || 'D. Canceling a reservation'"></p>
                                            </div>
                                        </div>
                                    </div>
                                </template>

                                <!-- Reading Layout: Multiple Choice (4 options) -->
                                <template x-if="activeSkill === 'reading'">
                                    <div>
                                        <!-- Question -->
                                        <div class="mb-6">
                                            <p class="text-lg text-gray-800 font-medium leading-relaxed" x-text="selectedModuleData?.content?.reading?.questions?.[currentReadingQuestionIndex]?.question || selectedModuleData?.content?.reading?.question || 'What is the main idea of the passage?'"></p>
                                        </div>

                                        <!-- Multiple Choice Options (4 choices) -->
                                        <div class="space-y-3">
                                            <div class="p-3 border rounded-lg transition" 
                                                 :class="(selectedModuleData?.content?.reading?.questions?.[currentReadingQuestionIndex]?.correctAnswer || selectedModuleData?.content?.reading?.correctAnswer || 1) === 1 ? 'border-blue-500 bg-blue-50' : 'border-gray-200 bg-gray-50'">
                                                <p class="text-sm text-gray-700" x-text="selectedModuleData?.content?.reading?.questions?.[currentReadingQuestionIndex]?.options?.[0] || selectedModuleData?.content?.reading?.options?.[0] || 'A. The importance of reading comprehension'"></p>
                                            </div>
                                            <div class="p-3 border rounded-lg transition" 
                                                 :class="(selectedModuleData?.content?.reading?.questions?.[currentReadingQuestionIndex]?.correctAnswer || selectedModuleData?.content?.reading?.correctAnswer || 1) === 2 ? 'border-blue-500 bg-blue-50' : 'border-gray-200 bg-gray-50'">
                                                <p class="text-sm text-gray-700" x-text="selectedModuleData?.content?.reading?.questions?.[currentReadingQuestionIndex]?.options?.[1] || selectedModuleData?.content?.reading?.options?.[1] || 'B. Strategies for improving vocabulary'"></p>
                                            </div>
                                            <div class="p-3 border rounded-lg transition" 
                                                 :class="(selectedModuleData?.content?.reading?.questions?.[currentReadingQuestionIndex]?.correctAnswer || selectedModuleData?.content?.reading?.correctAnswer || 1) === 3 ? 'border-blue-500 bg-blue-50' : 'border-gray-200 bg-gray-50'">
                                                <p class="text-sm text-gray-700" x-text="selectedModuleData?.content?.reading?.questions?.[currentReadingQuestionIndex]?.options?.[2] || selectedModuleData?.content?.reading?.options?.[2] || 'C. The history of literature'"></p>
                                            </div>
                                            <div class="p-3 border rounded-lg transition" 
                                                 :class="(selectedModuleData?.content?.reading?.questions?.[currentReadingQuestionIndex]?.correctAnswer || selectedModuleData?.content?.reading?.correctAnswer || 1) === 4 ? 'border-blue-500 bg-blue-50' : 'border-gray-200 bg-gray-50'">
                                                <p class="text-sm text-gray-700" x-text="selectedModuleData?.content?.reading?.questions?.[currentReadingQuestionIndex]?.options?.[3] || selectedModuleData?.content?.reading?.options?.[3] || 'D. Techniques for speed reading'"></p>
                                            </div>
                                        </div>
                                    </div>
                                </template>

                                <!-- Speaking: 3 Parts with Navigation -->
                                <template x-if="activeSkill === 'speaking'">
                                    <div>
                                        <!-- Part Title -->
                                        <div class="mb-6">
                                            <h5 class="text-xl font-bold text-gray-900 mb-2" x-text="getSpeakingPartTitle()"></h5>
                                        </div>

                                        <!-- Question Navigation -->
                                        <div class="mb-6 flex gap-2">
                                            <button 
                                                @click="currentSpeakingQuestion = 1"
                                                :class="currentSpeakingQuestion === 1 ? 'bg-blue-600 text-white' : 'bg-gray-100 text-gray-700 hover:bg-gray-200'"
                                                class="flex-1 px-4 py-2 rounded-lg transition font-medium text-sm"
                                            >
                                                Question 1
                                            </button>
                                            <button 
                                                @click="currentSpeakingQuestion = 2"
                                                :class="currentSpeakingQuestion === 2 ? 'bg-blue-600 text-white' : 'bg-gray-100 text-gray-700 hover:bg-gray-200'"
                                                class="flex-1 px-4 py-2 rounded-lg transition font-medium text-sm"
                                            >
                                                Question 2
                                            </button>
                                </div>

                                        <!-- Question Display -->
                                        <div class="bg-gray-50 border border-gray-200 rounded-lg p-4">
                                            <p class="text-lg text-gray-800 font-medium leading-relaxed" x-text="getCurrentSpeakingQuestion()"></p>
                                </div>
                                    </div>
                                </template>
                            </div>
                            
                            <!-- Card Footer / Nav -->
                            <div class="bg-gray-50 px-8 py-4 border-t border-gray-100 flex justify-between items-center">
                                <!-- Tags Section -->
                                <div class="flex-1">
                                    <p class="text-sm text-gray-600 font-medium">TAGS: <span class="text-gray-500 font-normal" x-text="getCurrentTags()">detail_recognition, Numbers, section_1</span></p>
                                </div>
                                
                                <div class="flex items-center gap-4">
                                <template x-if="activeSkill === 'writing'">
                                    <button 
                                        @click="if(currentWritingTaskIndex > 0) currentWritingTaskIndex--" 
                                        :disabled="currentWritingTaskIndex === 0"
                                        class="w-10 h-10 rounded-full border border-gray-300 flex items-center justify-center text-gray-400 bg-white shadow-sm hover:bg-gray-50 disabled:opacity-40 disabled:cursor-not-allowed transition"
                                    >
                                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"></path></svg>
                                    </button>
                                </template>
                                <template x-if="activeSkill === 'speaking'">
                                    <button 
                                        @click="if(currentSpeakingPart > 1) { currentSpeakingPart--; currentSpeakingQuestion = 1; }" 
                                        :disabled="currentSpeakingPart === 1"
                                        class="w-10 h-10 rounded-full border border-gray-300 flex items-center justify-center text-gray-400 bg-white shadow-sm hover:bg-gray-50 disabled:opacity-40 disabled:cursor-not-allowed transition"
                                    >
                                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"></path></svg>
                                    </button>
                                </template>
                                <template x-if="activeSkill === 'reading'">
                                    <button 
                                        @click="if(currentReadingQuestionIndex > 0) currentReadingQuestionIndex--" 
                                        :disabled="currentReadingQuestionIndex === 0 || !selectedModuleData?.content?.reading?.questions || selectedModuleData.content.reading.questions.length === 0"
                                        class="w-10 h-10 rounded-full border border-gray-300 flex items-center justify-center text-gray-400 bg-white shadow-sm hover:bg-gray-50 disabled:opacity-40 disabled:cursor-not-allowed transition"
                                    >
                                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"></path></svg>
                                    </button>
                                </template>
                                <template x-if="activeSkill === 'listening'">
                                    <button 
                                        @click="if(currentListeningQuestionIndex > 0) currentListeningQuestionIndex--" 
                                        :disabled="currentListeningQuestionIndex === 0 || !selectedModuleData?.content?.listening?.questions || selectedModuleData.content.listening.questions.length === 0"
                                        class="w-10 h-10 rounded-full border border-gray-300 flex items-center justify-center text-gray-400 bg-white shadow-sm hover:bg-gray-50 disabled:opacity-40 disabled:cursor-not-allowed transition"
                                    >
                                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"></path></svg>
                                    </button>
                                </template>
                                <template x-if="activeSkill === 'writing'">
                                    <button 
                                        @click="if(selectedModuleData?.content?.writing?.tasks && currentWritingTaskIndex < selectedModuleData.content.writing.tasks.length - 1) currentWritingTaskIndex++" 
                                        :disabled="!selectedModuleData?.content?.writing?.tasks || currentWritingTaskIndex >= selectedModuleData.content.writing.tasks.length - 1"
                                        class="w-10 h-10 rounded-full bg-black text-white flex items-center justify-center shadow-lg hover:bg-gray-800 disabled:bg-gray-300 disabled:cursor-not-allowed transition"
                                    >
                                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14 5l7 7m0 0l-7 7m7-7H3"></path></svg>
                                    </button>
                                </template>
                                <template x-if="activeSkill === 'speaking'">
                                    <button 
                                        @click="if(currentSpeakingPart < 3) { currentSpeakingPart++; currentSpeakingQuestion = 1; }" 
                                        :disabled="currentSpeakingPart === 3"
                                        class="w-10 h-10 rounded-full bg-black text-white flex items-center justify-center shadow-lg hover:bg-gray-800 disabled:bg-gray-300 disabled:cursor-not-allowed transition"
                                    >
                                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14 5l7 7m0 0l-7 7m7-7H3"></path></svg>
                                    </button>
                                </template>
                                <template x-if="activeSkill === 'reading'">
                                    <button 
                                        @click="if(selectedModuleData?.content?.reading?.questions && currentReadingQuestionIndex < selectedModuleData.content.reading.questions.length - 1) currentReadingQuestionIndex++" 
                                        :disabled="!selectedModuleData?.content?.reading?.questions || currentReadingQuestionIndex >= selectedModuleData.content.reading.questions.length - 1"
                                        class="w-10 h-10 rounded-full bg-black text-white flex items-center justify-center shadow-lg hover:bg-gray-800 disabled:bg-gray-300 disabled:cursor-not-allowed transition"
                                    >
                                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14 5l7 7m0 0l-7 7m7-7H3"></path></svg>
                                    </button>
                                </template>
                                <template x-if="activeSkill === 'listening'">
                                    <button 
                                        @click="if(selectedModuleData?.content?.listening?.questions && currentListeningQuestionIndex < selectedModuleData.content.listening.questions.length - 1) currentListeningQuestionIndex++" 
                                        :disabled="!selectedModuleData?.content?.listening?.questions || currentListeningQuestionIndex >= selectedModuleData.content.listening.questions.length - 1"
                                        class="w-10 h-10 rounded-full bg-black text-white flex items-center justify-center shadow-lg hover:bg-gray-800 disabled:bg-gray-300 disabled:cursor-not-allowed transition"
                                    >
                                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14 5l7 7m0 0l-7 7m7-7H3"></path></svg>
                                    </button>
                                </template>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 3. TEST BANK TAB -->
            <div x-show="currentTab === 'testbank'" x-cloak x-transition.opacity x-init="initRegularWritingExams(); initRegularReadingExams(); initRegularListeningExams(); initRegularSpeakingExams()">
                <!-- Cards View (Default) -->
                <template x-if="regularWritingView === 'cards' && regularReadingView === 'cards' && regularListeningView === 'cards' && regularSpeakingView === 'cards'">
                    <div>
                        <div class="flex justify-between items-center mb-6">
                            <h2 class="text-2xl font-bold text-gray-800">Regular User Test Bank</h2>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div @click="regularWritingView = 'list'; regularWritingSkill = 'writing'; initRegularWritingExams()" class="flex items-center gap-4 cursor-pointer group hover:bg-blue-50 p-4 rounded-xl transition border border-gray-100 hover:border-blue-200 bg-gray-50">
                                <div class="bg-blue-100 p-3 rounded-full text-blue-600">
                                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path>
                                    </svg>
                                </div>
                                <div>
                                    <h4 class="font-bold text-gray-800 text-lg group-hover:text-blue-700 mb-1">Writing</h4>
                                    <p class="text-sm text-gray-500">Develop coherent and well-structured responses</p>
                                </div>
                            </div>
                            <div @click="regularReadingView = 'list'; regularReadingSkill = 'reading'; initRegularReadingExams()" class="flex items-center gap-4 cursor-pointer group hover:bg-blue-50 p-4 rounded-xl transition border border-gray-100 hover:border-blue-200 bg-gray-50">
                                <div class="bg-green-100 p-3 rounded-full text-green-600">
                                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253"></path>
                                    </svg>
                                </div>
                                <div>
                                    <h4 class="font-bold text-gray-800 text-lg group-hover:text-blue-700">Reading</h4>
                                    <p class="text-sm text-gray-500">Boost your comprehension and skimming skills</p>
                                </div>
                            </div>
                            <div @click="regularListeningView = 'list'; regularListeningSkill = 'listening'; initRegularListeningExams()" class="flex items-center gap-4 cursor-pointer group hover:bg-blue-50 p-4 rounded-xl transition border border-gray-100 hover:border-blue-200 bg-gray-50">
                                <div class="bg-purple-100 p-3 rounded-full text-purple-600">
                                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.536 8.464a5 5 0 010 7.072m2.828-9.9a9 9 0 010 12.728M5.586 15H4a1 1 0 01-1-1v-4a1 1 0 011-1h1.586l4.707-4.707C10.923 3.663 12 4.109 12 5v14c0 .891-1.077 1.337-1.707.707L5.586 15z"></path>
                                    </svg>
                                </div>
                                <div>
                                    <h4 class="font-bold text-gray-800 text-lg group-hover:text-blue-700">Listening</h4>
                                    <p class="text-sm text-gray-500">Enhance your focus and audio understanding</p>
                                </div>
                            </div>
                            <div @click="regularSpeakingView = 'list'; regularSpeakingSkill = 'speaking'; initRegularSpeakingExams()" class="flex items-center gap-4 cursor-pointer group hover:bg-blue-50 p-4 rounded-xl transition border border-gray-100 hover:border-blue-200 bg-gray-50">
                                <div class="bg-yellow-100 p-3 rounded-full text-yellow-600">
                                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11a7 7 0 01-7 7m0 0a7 7 0 01-7-7m7 7v4m0 0H8m4 0h4m-4-8a3 3 0 01-3-3V5a3 3 0 116 0v6a3 3 0 01-3 3z"></path>
                                    </svg>
                                </div>
                                <div>
                                    <h4 class="font-bold text-gray-800 text-lg group-hover:text-blue-700">Speaking</h4>
                                    <p class="text-sm text-gray-500">Build fluency, improve pronunciation, and speak with clarity</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </template>

                <!-- Regular Reading List View -->
                <template x-if="regularReadingView === 'list' && regularReadingSkill === 'reading'">
                    <div>
                        <div class="flex justify-between items-center mb-6">
                            <div class="flex items-center gap-3">
                                <button @click="regularReadingView = 'cards'; regularReadingSkill = null" class="text-gray-500 hover:text-gray-800 p-2 hover:bg-gray-100 rounded-full transition">
                                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"></path>
                                    </svg>
                                </button>
                                <h2 class="text-2xl font-bold text-gray-800">Reading Exams</h2>
                            </div>
                            <button @click="showModal = 'addRegularReading'; editItem = {}" class="bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700 transition flex items-center gap-2">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
                                </svg>
                                <span>Add Reading Exam</span>
                            </button>
                        </div>
                        <div class="space-y-4">
                            <template x-for="exam in regularReadingExamsList" :key="exam.id">
                                <div @click="openRegularReadingExamDetail(exam)" class="bg-white rounded-lg shadow-sm border border-gray-200 p-5 cursor-pointer hover:shadow-md transition">
                                    <h3 class="text-lg font-semibold text-gray-900 mb-1" x-text="exam.title || 'Untitled Exam'"></h3>
                                    <p class="text-sm text-gray-500" x-text="exam.description || 'No description'"></p>
                                </div>
                            </template>
                            <div x-show="regularReadingExamsList.length === 0" class="text-center py-12 text-gray-500">
                                <p>No reading exams yet. Click "Add Reading Exam" to create one.</p>
                            </div>
                        </div>
                    </div>
                </template>

                <!-- Regular Writing List View -->
                <template x-if="regularWritingView === 'list' && regularWritingSkill === 'writing'">
                    <div>
                        <div class="flex justify-between items-center mb-6">
                            <div class="flex items-center gap-3">
                                <button @click="regularWritingView = 'cards'; regularWritingSkill = null" class="text-gray-500 hover:text-gray-800 p-2 hover:bg-gray-100 rounded-full transition">
                                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"></path>
                                    </svg>
                                </button>
                                <h2 class="text-2xl font-bold text-gray-800">Writing Exams</h2>
                            </div>
                            <button @click="showModal = 'addRegularWriting'; editItem = {}" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition flex items-center gap-2">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
                                </svg>
                                <span>Add Writing Exam</span>
                            </button>
                        </div>
                        <div class="space-y-4">
                            <template x-for="exam in regularWritingExamsList" :key="exam.id">
                                <div @click="openRegularWritingExamDetail(exam)" class="bg-white rounded-lg shadow-sm border border-gray-200 p-5 cursor-pointer hover:shadow-md transition">
                                    <h3 class="text-lg font-semibold text-gray-900 mb-1" x-text="exam.title || 'Untitled Exam'"></h3>
                                    <p class="text-sm text-gray-500" x-text="exam.description || 'No description'"></p>
                                </div>
                            </template>
                            <div x-show="regularWritingExamsList.length === 0" class="text-center py-12 text-gray-500">
                                <p>No writing exams yet. Click "Add Writing Exam" to create one.</p>
                            </div>
                        </div>
                    </div>
                </template>

                <!-- Regular Writing Detail View -->
                <template x-if="regularWritingView === 'detail' && regularWritingSkill === 'writing'">
                    <div class="mt-6 bg-white rounded-lg shadow-sm">
                        <!-- Header -->
                        <div class="flex items-center justify-between p-6 border-b border-gray-200">
                            <div class="flex items-center gap-4">
                                <button @click="closeRegularWritingExamDetail()" class="text-gray-500 hover:text-gray-800 p-2 hover:bg-gray-100 rounded-full transition">
                                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"></path>
                                    </svg>
                                </button>
                                <div>
                                    <h2 class="text-2xl font-bold text-gray-900" x-text="selectedRegularWritingExam?.title || 'Writing Exam'"></h2>
                                    <p class="text-sm text-gray-500" x-text="selectedRegularWritingExam?.description || ''"></p>
                                </div>
                            </div>
                            <div class="flex items-center gap-3">
                                <button x-show="regularWritingExamSaved && !regularWritingEditMode" @click="regularWritingEditMode = true" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition flex items-center gap-2">
                                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path>
                                    </svg>
                                    Edit
                                </button>
                                <button x-show="!regularWritingExamSaved || regularWritingEditMode" @click="saveRegularWritingExam()" class="bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700 transition flex items-center gap-2">
                                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                                    </svg>
                                    Save
                                </button>
                            </div>
                        </div>
                        
                        <!-- Content Editor -->
                        <div class="p-6">
                            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                                <!-- Writing Task 1 Card -->
                                <div class="border-2 border-dashed border-gray-300 rounded-lg p-6 bg-gray-50">
                                    <h3 class="text-lg font-semibold text-gray-700 mb-4">Writing Task 1</h3>
                                    
                                    <!-- Image Upload -->
                                    <div class="mb-4">
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Visual Prompt (Optional)</label>
                                        <div class="border-2 border-dashed border-gray-300 rounded-lg p-4 bg-white">
                                            <div class="text-center">
                                                <div x-show="!regularWritingTask1.previewImage && !regularWritingTask1.image">
                                                    <svg class="mx-auto h-10 w-10 text-gray-400" stroke="currentColor" fill="none" viewBox="0 0 48 48">
                                                        <path d="M28 8H12a4 4 0 00-4 4v20m32-12v8m0 0v8a4 4 0 01-4 4H12a4 4 0 01-4-4v-4m32-4l-3.172-3.172a4 4 0 00-5.656 0L28 28M8 32l9.172-9.172a4 4 0 015.656 0L28 28m0 0l4 4m4-24h8m-4-4v8m-12 4h.02" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
                                                    </svg>
                                                    <div class="mt-2">
                                                        <label class="cursor-pointer" :class="regularWritingEditMode || !regularWritingExamSaved ? '' : 'pointer-events-none opacity-50'">
                                                            <span class="text-sm text-blue-600 hover:text-blue-500 font-medium">Click to upload</span>
                                                            <input type="file" accept="image/*" class="hidden" :disabled="!regularWritingEditMode && regularWritingExamSaved" @change="handleRegularWritingTaskImageUpload($event, 1)">
                                                        </label>
                                                    </div>
                                                </div>
                                                <div x-show="regularWritingTask1.previewImage || regularWritingTask1.image" class="relative">
                                                    <img :src="regularWritingTask1.previewImage || regularWritingTask1.image" class="max-h-32 mx-auto rounded-md shadow-sm">
                                                    <button type="button" x-show="regularWritingEditMode || !regularWritingExamSaved" @click="regularWritingTask1.previewImage = null; regularWritingTask1.image = null" class="absolute top-0 right-0 bg-red-500 text-white rounded-full p-1 -mt-2 -mr-2 shadow-sm hover:bg-red-600">
                                                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                                                        </svg>
                                                    </button>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <!-- Task Instructions -->
                                    <div class="mb-4">
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Task Instructions</label>
                                        <textarea x-model="regularWritingTask1.description" :disabled="!regularWritingEditMode && regularWritingExamSaved" placeholder="Enter Writing Task 1 instructions..." class="w-full border border-gray-300 rounded-lg p-3 h-32 resize-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500" :class="(!regularWritingEditMode && regularWritingExamSaved) ? 'bg-gray-100 cursor-not-allowed' : ''"></textarea>
                                    </div>
                                    
                                    <!-- Tags -->
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Tags</label>
                                        <input type="text" x-model="regularWritingTask1.tags" :disabled="!regularWritingEditMode && regularWritingExamSaved" placeholder="e.g., #graph, #data_interpretation" class="w-full border border-gray-300 rounded-lg p-2 text-sm" :class="(!regularWritingEditMode && regularWritingExamSaved) ? 'bg-gray-100 cursor-not-allowed' : ''">
                                    </div>
                                </div>
                                
                                <!-- Writing Task 2 Card -->
                                <div class="border-2 border-dashed border-gray-300 rounded-lg p-6 bg-gray-50">
                                    <h3 class="text-lg font-semibold text-gray-700 mb-4">Writing Task 2</h3>
                                    
                                    <!-- Image Upload -->
                                    <div class="mb-4">
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Visual Prompt (Optional)</label>
                                        <div class="border-2 border-dashed border-gray-300 rounded-lg p-4 bg-white">
                                            <div class="text-center">
                                                <div x-show="!regularWritingTask2.previewImage && !regularWritingTask2.image">
                                                    <svg class="mx-auto h-10 w-10 text-gray-400" stroke="currentColor" fill="none" viewBox="0 0 48 48">
                                                        <path d="M28 8H12a4 4 0 00-4 4v20m32-12v8m0 0v8a4 4 0 01-4 4H12a4 4 0 01-4-4v-4m32-4l-3.172-3.172a4 4 0 00-5.656 0L28 28M8 32l9.172-9.172a4 4 0 015.656 0L28 28m0 0l4 4m4-24h8m-4-4v8m-12 4h.02" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
                                                    </svg>
                                                    <div class="mt-2">
                                                        <label class="cursor-pointer" :class="regularWritingEditMode || !regularWritingExamSaved ? '' : 'pointer-events-none opacity-50'">
                                                            <span class="text-sm text-blue-600 hover:text-blue-500 font-medium">Click to upload</span>
                                                            <input type="file" accept="image/*" class="hidden" :disabled="!regularWritingEditMode && regularWritingExamSaved" @change="handleRegularWritingTaskImageUpload($event, 2)">
                                                        </label>
                                                    </div>
                                                </div>
                                                <div x-show="regularWritingTask2.previewImage || regularWritingTask2.image" class="relative">
                                                    <img :src="regularWritingTask2.previewImage || regularWritingTask2.image" class="max-h-32 mx-auto rounded-md shadow-sm">
                                                    <button type="button" x-show="regularWritingEditMode || !regularWritingExamSaved" @click="regularWritingTask2.previewImage = null; regularWritingTask2.image = null" class="absolute top-0 right-0 bg-red-500 text-white rounded-full p-1 -mt-2 -mr-2 shadow-sm hover:bg-red-600">
                                                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                                                        </svg>
                                                    </button>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <!-- Task Instructions -->
                                    <div class="mb-4">
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Task Instructions</label>
                                        <textarea x-model="regularWritingTask2.description" :disabled="!regularWritingEditMode && regularWritingExamSaved" placeholder="Enter Writing Task 2 instructions..." class="w-full border border-gray-300 rounded-lg p-3 h-32 resize-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500" :class="(!regularWritingEditMode && regularWritingExamSaved) ? 'bg-gray-100 cursor-not-allowed' : ''"></textarea>
                                    </div>
                                    
                                    <!-- Tags -->
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Tags</label>
                                        <input type="text" x-model="regularWritingTask2.tags" :disabled="!regularWritingEditMode && regularWritingExamSaved" placeholder="e.g., #essay, #opinion, #education" class="w-full border border-gray-300 rounded-lg p-2 text-sm" :class="(!regularWritingEditMode && regularWritingExamSaved) ? 'bg-gray-100 cursor-not-allowed' : ''">
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </template>

                <!-- Regular Reading Detail View -->
                <template x-if="regularReadingView === 'detail' && regularReadingSkill === 'reading'">
                    <div class="bg-white rounded-lg shadow-sm">
                        <!-- Header -->
                        <div class="flex items-center justify-between p-6 border-b border-gray-200">
                            <div class="flex items-center gap-4">
                                <button @click="closeRegularReadingExamDetail()" class="text-gray-500 hover:text-gray-800 p-2 hover:bg-gray-100 rounded-full transition">
                                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"></path>
                                    </svg>
                                </button>
                                <div>
                                    <h2 class="text-2xl font-bold text-gray-900" x-text="selectedRegularReadingExam?.title || 'Reading Exam'"></h2>
                                    <p class="text-sm text-gray-500" x-text="selectedRegularReadingExam?.description || ''"></p>
                                </div>
                            </div>
                            <div class="flex items-center gap-3">
                                <button x-show="regularReadingExamSaved && !regularReadingEditMode" @click="regularReadingEditMode = true" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition flex items-center gap-2">
                                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path>
                                    </svg>
                                    Edit
                                </button>
                                <button x-show="!regularReadingExamSaved || regularReadingEditMode" @click="saveRegularReadingExam()" class="bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700 transition flex items-center gap-2">
                                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                                    </svg>
                                    Save
                                </button>
                            </div>
                        </div>
                        
                        <!-- Split-Screen Editor -->
                        <div class="p-6">
                            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                                <!-- Left Card: Passage Editor -->
                                <div class="border-2 border-dashed border-gray-300 rounded-lg p-6 bg-gray-50">
                                    <h3 class="text-lg font-semibold text-gray-700 mb-4">Reading Passage Content</h3>
                                    
                                    <!-- Passage Title -->
                                    <div class="mb-4">
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Passage Title</label>
                                        <input type="text" x-model="regularReadingPassageTitle" :disabled="!regularReadingEditMode && regularReadingExamSaved" placeholder="Enter passage title..." class="w-full border border-gray-300 rounded-lg p-3 focus:ring-2 focus:ring-green-500 focus:border-green-500" :class="(!regularReadingEditMode && regularReadingExamSaved) ? 'bg-gray-100 cursor-not-allowed' : ''">
                                    </div>
                                    
                                    <!-- Passage Content (Rich Text Editor) -->
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Passage Content</label>
                                        <textarea x-model="regularReadingPassageContent" :disabled="!regularReadingEditMode && regularReadingExamSaved" placeholder="Enter the reading passage content here. You can use paragraph breaks, and format text as needed..." class="w-full border border-gray-300 rounded-lg p-3 h-96 resize-none focus:ring-2 focus:ring-green-500 focus:border-green-500" :class="(!regularReadingEditMode && regularReadingExamSaved) ? 'bg-gray-100 cursor-not-allowed' : ''"></textarea>
                                        <p class="text-xs text-gray-500 mt-1">Tip: Use line breaks to create paragraphs. Formatting support coming soon.</p>
                                    </div>
                                </div>
                                
                                <!-- Right Card: Question Designer (MCQ) -->
                                <div class="border-2 border-dashed border-gray-300 rounded-lg p-6 bg-gray-50">
                                    <h3 class="text-lg font-semibold text-gray-700 mb-4">Multiple Choice Questions</h3>
                                    
                                    <!-- Question Input Form -->
                                    <div class="space-y-4 mb-6">
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700 mb-2">Question Prompt</label>
                                            <textarea x-model="currentRegularReadingQuestion.question" :disabled="!regularReadingEditMode && regularReadingExamSaved" placeholder="Enter the question..." class="w-full border border-gray-300 rounded-lg p-3 h-20 resize-none focus:ring-2 focus:ring-green-500 focus:border-green-500" :class="(!regularReadingEditMode && regularReadingExamSaved) ? 'bg-gray-100 cursor-not-allowed' : ''"></textarea>
                                        </div>
                                        
                                        <div class="grid grid-cols-2 gap-3">
                                            <div>
                                                <label class="block text-xs font-medium text-gray-700 mb-1">Option A</label>
                                                <input type="text" x-model="currentRegularReadingQuestion.optionA" :disabled="!regularReadingEditMode && regularReadingExamSaved" placeholder="Option A" class="w-full border border-gray-300 rounded-lg p-2 text-sm" :class="(!regularReadingEditMode && regularReadingExamSaved) ? 'bg-gray-100 cursor-not-allowed' : ''">
                                            </div>
                                            <div>
                                                <label class="block text-xs font-medium text-gray-700 mb-1">Option B</label>
                                                <input type="text" x-model="currentRegularReadingQuestion.optionB" :disabled="!regularReadingEditMode && regularReadingExamSaved" placeholder="Option B" class="w-full border border-gray-300 rounded-lg p-2 text-sm" :class="(!regularReadingEditMode && regularReadingExamSaved) ? 'bg-gray-100 cursor-not-allowed' : ''">
                                            </div>
                                            <div>
                                                <label class="block text-xs font-medium text-gray-700 mb-1">Option C</label>
                                                <input type="text" x-model="currentRegularReadingQuestion.optionC" :disabled="!regularReadingEditMode && regularReadingExamSaved" placeholder="Option C" class="w-full border border-gray-300 rounded-lg p-2 text-sm" :class="(!regularReadingEditMode && regularReadingExamSaved) ? 'bg-gray-100 cursor-not-allowed' : ''">
                                            </div>
                                            <div>
                                                <label class="block text-xs font-medium text-gray-700 mb-1">Option D</label>
                                                <input type="text" x-model="currentRegularReadingQuestion.optionD" :disabled="!regularReadingEditMode && regularReadingExamSaved" placeholder="Option D" class="w-full border border-gray-300 rounded-lg p-2 text-sm" :class="(!regularReadingEditMode && regularReadingExamSaved) ? 'bg-gray-100 cursor-not-allowed' : ''">
                                            </div>
                                        </div>
                                        
                                        <div class="grid grid-cols-2 gap-3">
                                            <div>
                                                <label class="block text-xs font-medium text-gray-700 mb-1">Correct Answer</label>
                                                <select x-model="currentRegularReadingQuestion.correctAnswer" :disabled="!regularReadingEditMode && regularReadingExamSaved" class="w-full border border-gray-300 rounded-lg p-2 text-sm" :class="(!regularReadingEditMode && regularReadingExamSaved) ? 'bg-gray-100 cursor-not-allowed' : ''">
                                                    <option value="A">A</option>
                                                    <option value="B">B</option>
                                                    <option value="C">C</option>
                                                    <option value="D">D</option>
                                                </select>
                                            </div>
                                            <div>
                                                <label class="block text-xs font-medium text-gray-700 mb-1">Tags</label>
                                                <input type="text" x-model="currentRegularReadingQuestion.tags" :disabled="!regularReadingEditMode && regularReadingExamSaved" placeholder="e.g., #vocabulary, #inference" class="w-full border border-gray-300 rounded-lg p-2 text-sm" :class="(!regularReadingEditMode && regularReadingExamSaved) ? 'bg-gray-100 cursor-not-allowed' : ''">
                                            </div>
                                        </div>
                                        
                                        <button x-show="regularReadingEditMode || !regularReadingExamSaved" @click="addRegularReadingQuestion()" class="w-full bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700 transition">
                                            Add Question
                                        </button>
                                    </div>
                                    
                                    <!-- Added Questions List -->
                                    <div>
                                        <h4 class="text-sm font-semibold text-gray-700 mb-3">Added Questions (<span x-text="regularReadingQuestions.length"></span>)</h4>
                                        <div class="space-y-2 max-h-96 overflow-y-auto">
                                            <template x-for="(q, index) in regularReadingQuestions" :key="q.id || index">
                                                <div class="bg-white border border-gray-200 rounded-lg p-3 flex items-start justify-between group">
                                                    <div class="flex-1 min-w-0">
                                                        <p class="text-sm font-medium text-gray-900 mb-1">Q<span x-text="index + 1"></span>: <span x-text="q.question"></span></p>
                                                        <p class="text-xs text-gray-600">A: <span x-text="q.optionA"></span> | B: <span x-text="q.optionB"></span> | C: <span x-text="q.optionC"></span> | D: <span x-text="q.optionD"></span></p>
                                                        <p class="text-xs text-green-600 mt-1">Correct: <span x-text="q.correctAnswer"></span></p>
                                                        <p x-show="q.tags" class="text-xs text-gray-500 mt-1">Tags: <span x-text="q.tags"></span></p>
                                                    </div>
                                                    <div class="flex items-center gap-2 ml-2" x-show="regularReadingEditMode || !regularReadingExamSaved">
                                                        <button @click="editRegularReadingQuestion(index)" class="text-blue-600 hover:text-blue-700 opacity-0 group-hover:opacity-100 transition text-xs">
                                                            Edit
                                                        </button>
                                                        <button @click="removeRegularReadingQuestion(index)" class="text-red-600 hover:text-red-700 opacity-0 group-hover:opacity-100 transition text-xs">
                                                            Delete
                                                        </button>
                                                    </div>
                                                </div>
                                            </template>
                                            <div x-show="regularReadingQuestions.length === 0" class="text-center py-8 text-gray-400 text-sm">
                                                No questions added yet. Fill in the form above and click "Add Question".
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </template>

                <!-- Regular Listening List View -->
                <template x-if="regularListeningView === 'list' && regularListeningSkill === 'listening'">
                    <div>
                        <div class="flex justify-between items-center mb-6">
                            <div class="flex items-center gap-3">
                                <button @click="regularListeningView = 'cards'; regularListeningSkill = null" class="text-gray-500 hover:text-gray-800 p-2 hover:bg-gray-100 rounded-full transition">
                                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"></path>
                                    </svg>
                                </button>
                                <h2 class="text-2xl font-bold text-gray-800">Regular Listening Exams</h2>
                            </div>
                            <button @click="showModal = 'addRegularListening'; editItem = {}" class="bg-purple-600 text-white px-4 py-2 rounded-lg hover:bg-purple-700 transition flex items-center gap-2">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
                                </svg>
                                <span>Add New Exam</span>
                            </button>
                        </div>
                        <div class="space-y-4">
                            <template x-for="exam in regularListeningExamsList" :key="exam.id">
                                <div @click="openRegularListeningExamDetail(exam)" class="bg-white rounded-lg shadow-sm border border-gray-200 p-5 cursor-pointer hover:shadow-md transition">
                                    <h3 class="text-lg font-semibold text-gray-900 mb-1" x-text="exam.title || 'Untitled Exam'"></h3>
                                    <p class="text-sm text-gray-500" x-text="exam.description || 'No description'"></p>
                                </div>
                            </template>
                            <div x-show="regularListeningExamsList.length === 0" class="text-center py-12 text-gray-500">
                                <p>No listening exams yet. Click "Add New Exam" to create one.</p>
                            </div>
                        </div>
                    </div>
                </template>

                <!-- Regular Listening Detail View -->
                <template x-if="regularListeningView === 'detail' && regularListeningSkill === 'listening'">
                    <div class="bg-white rounded-lg shadow-sm">
                        <!-- Top Bar -->
                        <div class="flex items-center justify-between p-6 border-b border-gray-200">
                            <div class="flex items-center gap-4">
                                <button @click="closeRegularListeningExamDetail()" class="text-gray-500 hover:text-gray-800 p-2 hover:bg-gray-100 rounded-full transition">
                                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"></path>
                                    </svg>
                                </button>
                                <div>
                                    <h2 class="text-2xl font-bold text-gray-900" x-text="selectedRegularListeningExam?.title || 'Listening Exam'"></h2>
                                    <p class="text-sm text-gray-500" x-text="selectedRegularListeningExam?.description || ''"></p>
                                </div>
                            </div>
                            <div class="flex items-center gap-3">
                                <button x-show="regularListeningExamSaved && !regularListeningEditMode" @click="regularListeningEditMode = true" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition flex items-center gap-2">
                                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path>
                                    </svg>
                                    Edit
                                </button>
                                <button x-show="!regularListeningExamSaved || regularListeningEditMode" @click="saveRegularListeningExam()" class="bg-purple-600 text-white px-4 py-2 rounded-lg hover:bg-purple-700 transition flex items-center gap-2">
                                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                                    </svg>
                                    Save
                                </button>
                            </div>
                        </div>
                        
                        <!-- Split-Screen Editor (50/50) -->
                        <div class="p-6">
                            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                                <!-- Left Panel: Audio Script Configuration -->
                                <div class="border-2 border-dashed border-gray-300 rounded-lg p-6 bg-gray-50">
                                    <h3 class="text-lg font-semibold text-gray-700 mb-4">Audio Script Configuration</h3>
                                    
                                    <!-- Narration/Context Field -->
                                    <div class="mb-6">
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Narration / Context</label>
                                        <textarea x-model="regularListeningNarration" :disabled="!regularListeningEditMode && regularListeningExamSaved" placeholder="This conversation is between a Customer and a Receptionist..." class="w-full border border-gray-300 rounded-lg p-3 h-24 resize-none focus:ring-2 focus:ring-purple-500 focus:border-purple-500" :class="(!regularListeningEditMode && regularListeningExamSaved) ? 'bg-gray-100 cursor-not-allowed' : ''"></textarea>
                                    </div>
                                    
                                    <!-- Script Builder -->
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Script Builder</label>
                                        <div class="space-y-3 max-h-96 overflow-y-auto mb-4">
                                            <template x-for="(block, index) in regularListeningScriptBlocks" :key="block.id || index">
                                                <div class="bg-white border border-gray-200 rounded-lg p-4">
                                                    <div class="flex items-start justify-between mb-3">
                                                        <label class="text-sm font-semibold text-gray-700" x-text="block.speaker || 'Speaker 1'"></label>
                                                        <button x-show="regularListeningEditMode || !regularListeningExamSaved" @click="removeRegularListeningScriptBlock(index)" class="text-red-600 hover:text-red-700 text-xs">
                                                            Remove
                                                        </button>
                                                    </div>
                                                    <div class="mb-3">
                                                        <label class="block text-xs font-medium text-gray-600 mb-1">Accent</label>
                                                        <select x-model="block.accent" :disabled="!regularListeningEditMode && regularListeningExamSaved" class="w-full border border-gray-300 rounded-lg p-2 text-sm" :class="(!regularListeningEditMode && regularListeningExamSaved) ? 'bg-gray-100 cursor-not-allowed' : ''">
                                                            <option value="British">British</option>
                                                            <option value="American">American</option>
                                                            <option value="Australian">Australian</option>
                                                            <option value="Indian">Indian</option>
                                                            <option value="Scottish">Scottish</option>
                                                            <option value="Irish">Irish</option>
                                                        </select>
                                                    </div>
                                                    <div>
                                                        <label class="block text-xs font-medium text-gray-600 mb-1">Line</label>
                                                        <textarea x-model="block.line" :disabled="!regularListeningEditMode && regularListeningExamSaved" placeholder="Enter dialogue..." class="w-full border border-gray-300 rounded-lg p-2 text-sm h-20 resize-none" :class="(!regularListeningEditMode && regularListeningExamSaved) ? 'bg-gray-100 cursor-not-allowed' : ''"></textarea>
                                                    </div>
                                                </div>
                                            </template>
                                            <div x-show="regularListeningScriptBlocks.length === 0" class="text-center py-8 text-gray-400 text-sm">
                                                No dialogue blocks yet. Click "Add Line" to start.
                                            </div>
                                        </div>
                                        <button x-show="regularListeningEditMode || !regularListeningExamSaved" @click="addRegularListeningScriptBlock()" class="w-full bg-purple-600 text-white px-4 py-2 rounded-lg hover:bg-purple-700 transition">
                                            Add Line
                                        </button>
                                    </div>
                                </div>
                                
                                <!-- Right Panel: Question Designer -->
                                <div class="border-2 border-dashed border-gray-300 rounded-lg p-6 bg-gray-50">
                                    <h3 class="text-lg font-semibold text-gray-700 mb-4">Multiple Choice Questions</h3>
                                    
                                    <!-- Question Form -->
                                    <div class="space-y-4 mb-6">
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700 mb-2">Question Text</label>
                                            <textarea x-model="currentRegularListeningQuestion.question" :disabled="!regularListeningEditMode && regularListeningExamSaved" placeholder="Enter the question..." class="w-full border border-gray-300 rounded-lg p-3 h-20 resize-none focus:ring-2 focus:ring-purple-500 focus:border-purple-500" :class="(!regularListeningEditMode && regularListeningExamSaved) ? 'bg-gray-100 cursor-not-allowed' : ''"></textarea>
                                        </div>
                                        
                                        <div class="grid grid-cols-2 gap-3">
                                            <div>
                                                <label class="block text-xs font-medium text-gray-700 mb-1">Option A</label>
                                                <input type="text" x-model="currentRegularListeningQuestion.optionA" :disabled="!regularListeningEditMode && regularListeningExamSaved" placeholder="Option A" class="w-full border border-gray-300 rounded-lg p-2 text-sm" :class="(!regularListeningEditMode && regularListeningExamSaved) ? 'bg-gray-100 cursor-not-allowed' : ''">
                                            </div>
                                            <div>
                                                <label class="block text-xs font-medium text-gray-700 mb-1">Option B</label>
                                                <input type="text" x-model="currentRegularListeningQuestion.optionB" :disabled="!regularListeningEditMode && regularListeningExamSaved" placeholder="Option B" class="w-full border border-gray-300 rounded-lg p-2 text-sm" :class="(!regularListeningEditMode && regularListeningExamSaved) ? 'bg-gray-100 cursor-not-allowed' : ''">
                                            </div>
                                            <div>
                                                <label class="block text-xs font-medium text-gray-700 mb-1">Option C</label>
                                                <input type="text" x-model="currentRegularListeningQuestion.optionC" :disabled="!regularListeningEditMode && regularListeningExamSaved" placeholder="Option C" class="w-full border border-gray-300 rounded-lg p-2 text-sm" :class="(!regularListeningEditMode && regularListeningExamSaved) ? 'bg-gray-100 cursor-not-allowed' : ''">
                                            </div>
                                            <div>
                                                <label class="block text-xs font-medium text-gray-700 mb-1">Option D</label>
                                                <input type="text" x-model="currentRegularListeningQuestion.optionD" :disabled="!regularListeningEditMode && regularListeningExamSaved" placeholder="Option D" class="w-full border border-gray-300 rounded-lg p-2 text-sm" :class="(!regularListeningEditMode && regularListeningExamSaved) ? 'bg-gray-100 cursor-not-allowed' : ''">
                                            </div>
                                        </div>
                                        
                                        <div class="grid grid-cols-2 gap-3">
                                            <div>
                                                <label class="block text-xs font-medium text-gray-700 mb-1">Correct Answer</label>
                                                <select x-model="currentRegularListeningQuestion.correctAnswer" :disabled="!regularListeningEditMode && regularListeningExamSaved" class="w-full border border-gray-300 rounded-lg p-2 text-sm" :class="(!regularListeningEditMode && regularListeningExamSaved) ? 'bg-gray-100 cursor-not-allowed' : ''">
                                                    <option value="A">A</option>
                                                    <option value="B">B</option>
                                                    <option value="C">C</option>
                                                    <option value="D">D</option>
                                                </select>
                                            </div>
                                            <div>
                                                <label class="block text-xs font-medium text-gray-700 mb-1">Tags</label>
                                                <input type="text" x-model="currentRegularListeningQuestion.tags" :disabled="!regularListeningEditMode && regularListeningExamSaved" placeholder="e.g., #vocabulary, #numbers" class="w-full border border-gray-300 rounded-lg p-2 text-sm" :class="(!regularListeningEditMode && regularListeningExamSaved) ? 'bg-gray-100 cursor-not-allowed' : ''">
                                            </div>
                                        </div>
                                        
                                        <button x-show="regularListeningEditMode || !regularListeningExamSaved" @click="addRegularListeningQuestion()" class="w-full bg-purple-600 text-white px-4 py-2 rounded-lg hover:bg-purple-700 transition">
                                            Add Question
                                        </button>
                                    </div>
                                    
                                    <!-- Existing Questions Display -->
                                    <div>
                                        <h4 class="text-sm font-semibold text-gray-700 mb-3">Existing Questions (<span x-text="regularListeningQuestions.length"></span>)</h4>
                                        <div class="space-y-2 max-h-96 overflow-y-auto">
                                            <template x-for="(q, index) in regularListeningQuestions" :key="q.id || index">
                                                <div class="bg-white border border-gray-200 rounded-lg p-3">
                                                    <div class="flex items-start justify-between mb-2">
                                                        <p class="text-sm font-medium text-gray-900 flex-1">Q<span x-text="index + 1"></span>: <span x-text="q.question"></span></p>
                                                        <div class="flex items-center gap-2 ml-2" x-show="regularListeningEditMode || !regularListeningExamSaved">
                                                            <button @click="editRegularListeningQuestion(index)" class="text-blue-600 hover:text-blue-700 text-xs">
                                                                Edit
                                                            </button>
                                                            <button @click="removeRegularListeningQuestion(index)" class="text-red-600 hover:text-red-700 text-xs">
                                                                Delete
                                                            </button>
                                                        </div>
                                                    </div>
                                                    <div class="grid grid-cols-2 gap-2 text-xs">
                                                        <div :class="q.correctAnswer === 'A' ? 'bg-green-100 text-green-800 font-semibold' : 'text-gray-600'">
                                                            A: <span x-text="q.optionA"></span>
                                                        </div>
                                                        <div :class="q.correctAnswer === 'B' ? 'bg-green-100 text-green-800 font-semibold' : 'text-gray-600'">
                                                            B: <span x-text="q.optionB"></span>
                                                        </div>
                                                        <div :class="q.correctAnswer === 'C' ? 'bg-green-100 text-green-800 font-semibold' : 'text-gray-600'">
                                                            C: <span x-text="q.optionC"></span>
                                                        </div>
                                                        <div :class="q.correctAnswer === 'D' ? 'bg-green-100 text-green-800 font-semibold' : 'text-gray-600'">
                                                            D: <span x-text="q.optionD"></span>
                                                        </div>
                                                    </div>
                                                    <p x-show="q.tags" class="text-xs text-gray-500 mt-2">Tags: <span x-text="q.tags"></span></p>
                                                </div>
                                            </template>
                                            <div x-show="regularListeningQuestions.length === 0" class="text-center py-8 text-gray-400 text-sm">
                                                No questions added yet. Fill in the form above and click "Add Question".
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </template>

                <!-- Regular Speaking List View -->
                <template x-if="regularSpeakingView === 'list' && regularSpeakingSkill === 'speaking'">
                    <div>
                        <div class="flex justify-between items-center mb-6">
                            <div class="flex items-center gap-3">
                                <button @click="regularSpeakingView = 'cards'; regularSpeakingSkill = null" class="text-gray-500 hover:text-gray-800 p-2 hover:bg-gray-100 rounded-full transition">
                                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"></path>
                                    </svg>
                                </button>
                                <h2 class="text-2xl font-bold text-gray-800">Regular Speaking Exams</h2>
                            </div>
                            <button @click="showModal = 'addRegularSpeaking'; editItem = {}" class="bg-yellow-600 text-white px-4 py-2 rounded-lg hover:bg-yellow-700 transition flex items-center gap-2">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
                                </svg>
                                <span>Add Speaking Exam</span>
                            </button>
                        </div>
                        <div class="space-y-4">
                            <template x-for="exam in regularSpeakingExamsList" :key="exam.id">
                                <div @click="openRegularSpeakingExamDetail(exam)" class="bg-white rounded-lg shadow-sm border border-gray-200 p-5 cursor-pointer hover:shadow-md transition">
                                    <h3 class="text-lg font-semibold text-gray-900 mb-1" x-text="exam.title || 'Untitled Exam'"></h3>
                                    <p class="text-sm text-gray-500" x-text="exam.description || 'No description'"></p>
                                </div>
                            </template>
                            <div x-show="regularSpeakingExamsList.length === 0" class="text-center py-12 text-gray-500">
                                <p>No speaking exams yet. Click "Add Speaking Exam" to create one.</p>
                            </div>
                        </div>
                    </div>
                </template>

                <!-- Regular Speaking Detail View -->
                <template x-if="regularSpeakingView === 'detail' && regularSpeakingSkill === 'speaking'">
                    <div class="bg-white rounded-lg shadow-sm">
                        <!-- Top Bar -->
                        <div class="flex items-center justify-between p-6 border-b border-gray-200">
                            <div class="flex items-center gap-4">
                                <button @click="closeRegularSpeakingExamDetail()" class="text-gray-500 hover:text-gray-800 p-2 hover:bg-gray-100 rounded-full transition">
                                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"></path>
                                    </svg>
                                </button>
                                <div>
                                    <h2 class="text-2xl font-bold text-gray-900" x-text="selectedRegularSpeakingExam?.title || 'Speaking Exam'"></h2>
                                    <p class="text-sm text-gray-500" x-text="selectedRegularSpeakingExam?.description || ''"></p>
                                </div>
                            </div>
                            <div class="flex items-center gap-3">
                                <button x-show="regularSpeakingExamSaved && !regularSpeakingEditMode" @click="regularSpeakingEditMode = true" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition flex items-center gap-2">
                                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path>
                                    </svg>
                                    Edit
                                </button>
                                <button x-show="!regularSpeakingExamSaved || regularSpeakingEditMode" @click="saveRegularSpeakingExam()" class="bg-yellow-600 text-white px-4 py-2 rounded-lg hover:bg-yellow-700 transition flex items-center gap-2">
                                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                                    </svg>
                                    Save
                                </button>
                            </div>
                        </div>
                        
                        <!-- Split-Screen Editor (50/50) -->
                        <div class="p-6">
                            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                                <!-- Left Panel: Examiner Instructions & Script -->
                                <div class="border-2 border-dashed border-gray-300 rounded-lg p-6 bg-gray-50">
                                    <h3 class="text-lg font-semibold text-gray-700 mb-4">Module Content / Examiner Script</h3>
                                    
                                    <!-- Content Editor (WYSIWYG - using textarea for now) -->
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Examiner Instructions</label>
                                        <textarea x-model="regularSpeakingModuleContent" :disabled="!regularSpeakingEditMode && regularSpeakingExamSaved" placeholder="In this part of the exam, I am going to ask you some questions about yourself..." class="w-full border border-gray-300 rounded-lg p-3 h-96 resize-none focus:ring-2 focus:ring-yellow-500 focus:border-yellow-500" :class="(!regularSpeakingEditMode && regularSpeakingExamSaved) ? 'bg-gray-100 cursor-not-allowed' : ''"></textarea>
                                        <p class="text-xs text-gray-500 mt-1">Tip: Use line breaks to create paragraphs. Formatting support coming soon.</p>
                                    </div>
                                </div>
                                
                                <!-- Right Panel: Question Bank (Parts 1-3) -->
                                <div class="border-2 border-dashed border-gray-300 rounded-lg p-6 bg-gray-50">
                                    <h3 class="text-lg font-semibold text-gray-700 mb-4">Question Bank</h3>
                                    
                                    <!-- Part Selector (Tabs) -->
                                    <div class="mb-4">
                                        <div class="flex border-b border-gray-300">
                                            <button @click="regularSpeakingCurrentPart = 1" :class="regularSpeakingCurrentPart === 1 ? 'border-b-2 border-yellow-500 text-yellow-600 font-semibold' : 'text-gray-600 hover:text-gray-800'" class="px-4 py-2 text-sm transition">
                                                Part 1: Introduction
                                            </button>
                                            <button @click="regularSpeakingCurrentPart = 2" :class="regularSpeakingCurrentPart === 2 ? 'border-b-2 border-yellow-500 text-yellow-600 font-semibold' : 'text-gray-600 hover:text-gray-800'" class="px-4 py-2 text-sm transition">
                                                Part 2: Cue Card
                                            </button>
                                            <button @click="regularSpeakingCurrentPart = 3" :class="regularSpeakingCurrentPart === 3 ? 'border-b-2 border-yellow-500 text-yellow-600 font-semibold' : 'text-gray-600 hover:text-gray-800'" class="px-4 py-2 text-sm transition">
                                                Part 3: Discussion
                                            </button>
                                        </div>
                                    </div>
                                    
                                    <!-- Question Input Area -->
                                    <div class="space-y-4 mb-6">
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700 mb-2">Prompt/Question</label>
                                            <textarea x-model="currentRegularSpeakingQuestion.question" :disabled="!regularSpeakingEditMode && regularSpeakingExamSaved" placeholder="Tell me about your hometown." class="w-full border border-gray-300 rounded-lg p-3 h-20 resize-none focus:ring-2 focus:ring-yellow-500 focus:border-yellow-500" :class="(!regularSpeakingEditMode && regularSpeakingExamSaved) ? 'bg-gray-100 cursor-not-allowed' : ''"></textarea>
                                        </div>
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700 mb-2">Tags</label>
                                            <input type="text" x-model="currentRegularSpeakingQuestion.tags" :disabled="!regularSpeakingEditMode && regularSpeakingExamSaved" placeholder="e.g., #hometown, #intro, #vocabulary" class="w-full border border-gray-300 rounded-lg p-2 text-sm" :class="(!regularSpeakingEditMode && regularSpeakingExamSaved) ? 'bg-gray-100 cursor-not-allowed' : ''">
                                        </div>
                                        <button x-show="regularSpeakingEditMode || !regularSpeakingExamSaved" @click="addRegularSpeakingQuestion()" class="w-full bg-yellow-600 text-white px-4 py-2 rounded-lg hover:bg-yellow-700 transition">
                                            Add Prompt
                                        </button>
                                    </div>
                                    
                                    <!-- Active Question List (Display) -->
                                    <div>
                                        <h4 class="text-sm font-semibold text-gray-700 mb-3">Active Questions - Part <span x-text="regularSpeakingCurrentPart"></span> (<span x-text="getRegularSpeakingQuestionsForPart(regularSpeakingCurrentPart).length"></span>)</h4>
                                        <div class="space-y-2 max-h-96 overflow-y-auto">
                                            <!-- Part 1 Questions -->
                                            <template x-if="regularSpeakingCurrentPart === 1">
                                                <div>
                                                    <template x-for="(q, index) in regularSpeakingQuestions.part1" :key="q.id || index">
                                                        <div class="bg-white border border-gray-200 rounded-lg p-3 flex items-start justify-between group">
                                                            <div class="flex-1 min-w-0">
                                                                <p class="text-sm font-medium text-gray-900 mb-1"><span x-text="index + 1"></span>. <span x-text="q.question"></span></p>
                                                                <p x-show="q.tags" class="text-xs text-gray-500">Tags: <span x-text="q.tags"></span></p>
                                                            </div>
                                                            <div class="flex items-center gap-2 ml-2" x-show="regularSpeakingEditMode || !regularSpeakingExamSaved">
                                                                <button @click="editRegularSpeakingQuestion(1, index)" class="text-blue-600 hover:text-blue-700 opacity-0 group-hover:opacity-100 transition text-xs">
                                                                    Edit
                                                                </button>
                                                                <button @click="removeRegularSpeakingQuestion(1, index)" class="text-red-600 hover:text-red-700 opacity-0 group-hover:opacity-100 transition text-xs">
                                                                    Delete
                                                                </button>
                                                            </div>
                                                        </div>
                                                    </template>
                                                    <div x-show="regularSpeakingQuestions.part1.length === 0" class="text-center py-8 text-gray-400 text-sm">
                                                        No questions added yet for Part 1. Fill in the form above and click "Add Prompt".
                                                    </div>
                                                </div>
                                            </template>
                                            
                                            <!-- Part 2 Questions -->
                                            <template x-if="regularSpeakingCurrentPart === 2">
                                                <div>
                                                    <template x-for="(q, index) in regularSpeakingQuestions.part2" :key="q.id || index">
                                                        <div class="bg-white border border-gray-200 rounded-lg p-3 flex items-start justify-between group">
                                                            <div class="flex-1 min-w-0">
                                                                <p class="text-sm font-medium text-gray-900 mb-1"><span x-text="index + 1"></span>. <span x-text="q.question"></span></p>
                                                                <p x-show="q.tags" class="text-xs text-gray-500">Tags: <span x-text="q.tags"></span></p>
                                                            </div>
                                                            <div class="flex items-center gap-2 ml-2" x-show="regularSpeakingEditMode || !regularSpeakingExamSaved">
                                                                <button @click="editRegularSpeakingQuestion(2, index)" class="text-blue-600 hover:text-blue-700 opacity-0 group-hover:opacity-100 transition text-xs">
                                                                    Edit
                                                                </button>
                                                                <button @click="removeRegularSpeakingQuestion(2, index)" class="text-red-600 hover:text-red-700 opacity-0 group-hover:opacity-100 transition text-xs">
                                                                    Delete
                                                                </button>
                                                            </div>
                                                        </div>
                                                    </template>
                                                    <div x-show="regularSpeakingQuestions.part2.length === 0" class="text-center py-8 text-gray-400 text-sm">
                                                        No questions added yet for Part 2. Fill in the form above and click "Add Prompt".
                                                    </div>
                                                </div>
                                            </template>
                                            
                                            <!-- Part 3 Questions -->
                                            <template x-if="regularSpeakingCurrentPart === 3">
                                                <div>
                                                    <template x-for="(q, index) in regularSpeakingQuestions.part3" :key="q.id || index">
                                                        <div class="bg-white border border-gray-200 rounded-lg p-3 flex items-start justify-between group">
                                                            <div class="flex-1 min-w-0">
                                                                <p class="text-sm font-medium text-gray-900 mb-1"><span x-text="index + 1"></span>. <span x-text="q.question"></span></p>
                                                                <p x-show="q.tags" class="text-xs text-gray-500">Tags: <span x-text="q.tags"></span></p>
                                                            </div>
                                                            <div class="flex items-center gap-2 ml-2" x-show="regularSpeakingEditMode || !regularSpeakingExamSaved">
                                                                <button @click="editRegularSpeakingQuestion(3, index)" class="text-blue-600 hover:text-blue-700 opacity-0 group-hover:opacity-100 transition text-xs">
                                                                    Edit
                                                                </button>
                                                                <button @click="removeRegularSpeakingQuestion(3, index)" class="text-red-600 hover:text-red-700 opacity-0 group-hover:opacity-100 transition text-xs">
                                                                    Delete
                                                                </button>
                                                            </div>
                                                        </div>
                                                    </template>
                                                    <div x-show="regularSpeakingQuestions.part3.length === 0" class="text-center py-8 text-gray-400 text-sm">
                                                        No questions added yet for Part 3. Fill in the form above and click "Add Prompt".
                                                    </div>
                                                </div>
                                            </template>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </template>
            </div>

            <!-- 5. EILTS MOCK EXAM TAB -->
            <div x-show="currentTab === 'abel'" 
                 x-cloak 
                 x-transition.opacity 
                 x-init="
                     initFinalAssessments();
                     if (mockExamSkill) { 
                         mockExamView = 'skill';
                     }
                 "
                 x-effect="
                     if (currentTab === 'abel') { 
                         initFinalAssessments();
                         if (mockExamSkill && mockExamView !== 'skill') {
                             mockExamView = 'skill';
                         }
                     }
                 ">
                <!-- Skill Cards View -->
                <template x-if="mockExamView === 'list'">
                    <div>
                        <div class="flex justify-between items-center mb-6">
                            <h2 class="text-2xl font-bold text-gray-800">EILTS mock exam</h2>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div @click="initFinalAssessments(); mockExamView = 'skill'; mockExamSkill = 'writing';" class="flex items-center gap-4 cursor-pointer group hover:bg-blue-50 p-4 rounded-xl transition border border-gray-100 hover:border-blue-200 bg-gray-50">
                                <div class="bg-blue-100 p-3 rounded-full text-blue-600"><svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path></svg></div>
                                <div><h4 class="font-bold text-gray-800 text-lg group-hover:text-blue-700 mb-1">Writing</h4><p class="text-sm text-gray-500">Develop coherent and well-structured responses</p></div>
                            </div>
                            <div @click="initFinalAssessments(); mockExamView = 'skill'; mockExamSkill = 'reading';" class="flex items-center gap-4 cursor-pointer group hover:bg-blue-50 p-4 rounded-xl transition border border-gray-100 hover:border-blue-200 bg-gray-50">
                                <div class="bg-green-100 p-3 rounded-full text-green-600"><svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253"></path></svg></div>
                                <div><h4 class="font-bold text-gray-800 text-lg group-hover:text-blue-700">Reading</h4><p class="text-sm text-gray-500">Boost your comprehension and skimming skills</p></div>
                            </div>
                            <div @click="initFinalAssessments(); mockExamView = 'skill'; mockExamSkill = 'listening';" class="flex items-center gap-4 cursor-pointer group hover:bg-blue-50 p-4 rounded-xl transition border border-gray-100 hover:border-blue-200 bg-gray-50">
                                <div class="bg-purple-100 p-3 rounded-full text-purple-600"><svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.536 8.464a5 5 0 010 7.072m2.828-9.9a9 9 0 010 12.728M5.586 15H4a1 1 0 01-1-1v-4a1 1 0 011-1h1.586l4.707-4.707C10.923 3.663 12 4.109 12 5v14c0 .891-1.077 1.337-1.707.707L5.586 15z"></path></svg></div>
                                <div><h4 class="font-bold text-gray-800 text-lg group-hover:text-blue-700">Listening</h4><p class="text-sm text-gray-500">Enhance your focus and audio understanding</p></div>
                            </div>
                            <div @click="initFinalAssessments(); mockExamView = 'skill'; mockExamSkill = 'speaking';" class="flex items-center gap-4 cursor-pointer group hover:bg-blue-50 p-4 rounded-xl transition border border-gray-100 hover:border-blue-200 bg-gray-50">
                                <div class="bg-yellow-100 p-3 rounded-full text-yellow-600"><svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11a7 7 0 01-7 7m0 0a7 7 0 01-7-7m7 7v4m0 0H8m4 0h4m-4-8a3 3 0 01-3-3V5a3 3 0 116 0v6a3 3 0 01-3 3z"></path></svg></div>
                                <div><h4 class="font-bold text-gray-800 text-lg group-hover:text-blue-700">Speaking</h4><p class="text-sm text-gray-500">Build fluency, improve pronunciation, and speak with clarity</p></div>
                            </div>
                        </div>
                    </div>
                </template>

                <!-- Skill Questions View -->
                <template x-if="mockExamView === 'skill'">
                    <div x-effect="initFinalAssessments()">
                        <div class="flex justify-between items-center mb-6">
                            <div class="flex items-center gap-3">
                                <button @click="mockExamView = 'list'; mockExamSkill = null" class="text-gray-500 hover:text-gray-800 p-2 hover:bg-gray-100 rounded-full transition">
                                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"></path></svg>
                                </button>
                                <h2 class="text-2xl font-bold text-gray-800" x-text="mockExamSkill === 'writing' ? 'Writing exam questions' : mockExamSkill === 'reading' ? 'Reading exam questions' : mockExamSkill === 'listening' ? 'Listening exam questions' : mockExamSkill === 'speaking' ? 'Speaking exam questions' : mockExamSkill.charAt(0).toUpperCase() + mockExamSkill.slice(1)"></h2>
                            </div>
                            <button x-show="!((mockExamSkill === 'writing' && writingExamView === 'detail') || (mockExamSkill === 'reading' && readingExamView === 'detail') || (mockExamSkill === 'listening' && listeningExamView === 'detail'))" @click="showModal = 'addAbel'; editItem = { type: mockExamSkill.charAt(0).toUpperCase() + mockExamSkill.slice(1) }; previewImage = null" class="bg-purple-600 text-white px-4 py-2 rounded-lg hover:bg-purple-700 transition flex items-center gap-2">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path></svg>
                                <span x-text="(mockExamSkill === 'writing' || mockExamSkill === 'reading' || mockExamSkill === 'listening') ? 'Add Exam' : '+ Add Question'"></span>
                            </button>
                        </div>
                        <div class="space-y-4">
                            <!-- Writing Detail View -->
                            <template x-if="mockExamSkill === 'writing' && writingExamView === 'detail'">
                                <div class="bg-white rounded-lg shadow-sm">
                                    <!-- Header -->
                                    <div class="flex items-center justify-between p-6 border-b border-gray-200">
                                        <div class="flex items-center gap-4">
                                            <button @click="closeWritingExamDetail()" class="text-gray-500 hover:text-gray-800 p-2 hover:bg-gray-100 rounded-full transition">
                                                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"></path></svg>
                                            </button>
                                            <div>
                                                <h2 class="text-2xl font-bold text-gray-900">Writing</h2>
                                                <p class="text-sm text-gray-500" x-text="selectedWritingExam?.title || 'Writing Exam'"></p>
                                            </div>
                                        </div>
                                        <div class="flex items-center gap-3">
                                            <button x-show="writingExamSaved" @click="writingExamSaved = false" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition flex items-center gap-2">
                                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path></svg>
                                                Edit
                                            </button>
                                            <button x-show="!writingExamSaved" @click="saveWritingExam()" class="bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700 transition flex items-center gap-2">
                                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg>
                                                Save
                                            </button>
                                        </div>
                                    </div>
                                    
                                    <!-- Content Editor (shown only when not saved) -->
                                    <div x-show="!writingExamSaved" class="p-6">
                                        <div class="border-2 border-dashed border-gray-300 rounded-lg p-8 min-h-[400px] bg-gray-50">
                                            <h3 class="text-lg font-semibold text-gray-700 mb-2">Content Editor</h3>
                                            <p class="text-sm text-gray-500 mb-4">Admin can edit the generated content here.</p>
                                            
                                            <!-- Writing Task 1 Input -->
                                            <div class="mb-6">
                                                <label class="block text-sm font-medium text-gray-700 mb-2">Writing Task 1</label>
                                                
                                                <!-- Image Upload -->
                                                <div class="mb-3">
                                                    <label class="block text-xs text-gray-600 mb-1">Upload Image (Optional)</label>
                                                    <div class="border-2 border-dashed border-gray-300 rounded-lg p-4 bg-white">
                                                        <div class="text-center">
                                                            <div x-show="!writingTask1.previewImage && !writingTask1.image">
                                                                <svg class="mx-auto h-10 w-10 text-gray-400" stroke="currentColor" fill="none" viewBox="0 0 48 48">
                                                                    <path d="M28 8H12a4 4 0 00-4 4v20m32-12v8m0 0v8a4 4 0 01-4 4H12a4 4 0 01-4-4v-4m32-4l-3.172-3.172a4 4 0 00-5.656 0L28 28M8 32l9.172-9.172a4 4 0 015.656 0L28 28m0 0l4 4m4-24h8m-4-4v8m-12 4h.02" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
                                                                </svg>
                                                                <div class="mt-2">
                                                                    <label class="cursor-pointer">
                                                                        <span class="text-sm text-blue-600 hover:text-blue-500 font-medium">Click to upload</span>
                                                                        <input type="file" accept="image/*" class="hidden" @change="handleWritingTaskImageUpload($event, 1)">
                                                                    </label>
                                                                </div>
                                                            </div>
                                                            <div x-show="writingTask1.previewImage || writingTask1.image" class="relative">
                                                                <img :src="writingTask1.previewImage || writingTask1.image" class="max-h-32 mx-auto rounded-md shadow-sm">
                                                                <button type="button" @click="writingTask1.previewImage = null; writingTask1.image = null" class="absolute top-0 right-0 bg-red-500 text-white rounded-full p-1 -mt-2 -mr-2 shadow-sm hover:bg-red-600">
                                                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                                                                </button>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                                
                                                <textarea x-model="writingTask1.description" placeholder="Enter Writing Task 1 description..." class="w-full border border-gray-300 rounded-lg p-3 h-32 resize-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500"></textarea>
                                                <div class="mt-2">
                                                    <label class="block text-xs text-gray-600 mb-1">Tags (comma-separated)</label>
                                                    <input type="text" x-model="writingTask1.tags" placeholder="e.g., detail_recognition, Numbers, section_1" class="w-full border border-gray-300 rounded-lg p-2 text-sm">
                                                </div>
                                            </div>
                                            
                                            <!-- Writing Task 2 Input -->
                                            <div>
                                                <label class="block text-sm font-medium text-gray-700 mb-2">Writing Task 2</label>
                                                
                                                <!-- Image Upload -->
                                                <div class="mb-3">
                                                    <label class="block text-xs text-gray-600 mb-1">Upload Image (Optional)</label>
                                                    <div class="border-2 border-dashed border-gray-300 rounded-lg p-4 bg-white">
                                                        <div class="text-center">
                                                            <div x-show="!writingTask2.previewImage && !writingTask2.image">
                                                                <svg class="mx-auto h-10 w-10 text-gray-400" stroke="currentColor" fill="none" viewBox="0 0 48 48">
                                                                    <path d="M28 8H12a4 4 0 00-4 4v20m32-12v8m0 0v8a4 4 0 01-4 4H12a4 4 0 01-4-4v-4m32-4l-3.172-3.172a4 4 0 00-5.656 0L28 28M8 32l9.172-9.172a4 4 0 015.656 0L28 28m0 0l4 4m4-24h8m-4-4v8m-12 4h.02" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
                                                                </svg>
                                                                <div class="mt-2">
                                                                    <label class="cursor-pointer">
                                                                        <span class="text-sm text-blue-600 hover:text-blue-500 font-medium">Click to upload</span>
                                                                        <input type="file" accept="image/*" class="hidden" @change="handleWritingTaskImageUpload($event, 2)">
                                                                    </label>
                                                                </div>
                                                            </div>
                                                            <div x-show="writingTask2.previewImage || writingTask2.image" class="relative">
                                                                <img :src="writingTask2.previewImage || writingTask2.image" class="max-h-32 mx-auto rounded-md shadow-sm">
                                                                <button type="button" @click="writingTask2.previewImage = null; writingTask2.image = null" class="absolute top-0 right-0 bg-red-500 text-white rounded-full p-1 -mt-2 -mr-2 shadow-sm hover:bg-red-600">
                                                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                                                                </button>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                                
                                                <textarea x-model="writingTask2.description" placeholder="Enter Writing Task 2 description..." class="w-full border border-gray-300 rounded-lg p-3 h-32 resize-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500"></textarea>
                                                <div class="mt-2">
                                                    <label class="block text-xs text-gray-600 mb-1">Tags (comma-separated)</label>
                                                    <input type="text" x-model="writingTask2.tags" placeholder="e.g., discussion, opinion, task_2" class="w-full border border-gray-300 rounded-lg p-2 text-sm">
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <!-- Writing Tasks Display (shown after save) -->
                                    <div x-show="writingExamSaved" class="grid grid-cols-1 lg:grid-cols-2 gap-6 p-6">
                                        <!-- Writing Task 1 Card -->
                                        <div class="bg-white border border-gray-200 rounded-lg p-6 shadow-sm">
                                            <h3 class="text-lg font-bold text-gray-900 mb-4">Writing Task 1</h3>
                                            <div class="bg-gray-200 rounded-lg h-48 flex items-center justify-center mb-4 overflow-hidden">
                                                <template x-if="writingTask1.previewImage || writingTask1.image">
                                                    <img :src="writingTask1.previewImage || writingTask1.image" alt="Writing Task 1" class="w-full h-full object-cover">
                                                </template>
                                                <template x-if="!writingTask1.previewImage && !writingTask1.image">
                                                    <span class="text-gray-500 text-lg font-medium">Writing Task 1</span>
                                                </template>
                                            </div>
                                            <p class="text-sm text-gray-700 leading-relaxed mb-3" x-text="writingTask1.description || 'No description entered yet.'"></p>
                                            <div class="text-xs text-gray-500" x-show="writingTask1.tags">
                                                <span class="font-semibold">TAGS:</span> <span x-text="writingTask1.tags"></span>
                                            </div>
                                        </div>
                                        
                                        <!-- Writing Task 2 Card -->
                                        <div class="bg-white border border-gray-200 rounded-lg p-6 shadow-sm">
                                            <h3 class="text-lg font-bold text-gray-900 mb-4">Writing Task 2</h3>
                                            <div class="bg-gray-200 rounded-lg h-48 flex items-center justify-center mb-4 overflow-hidden">
                                                <template x-if="writingTask2.previewImage || writingTask2.image">
                                                    <img :src="writingTask2.previewImage || writingTask2.image" alt="Writing Task 2" class="w-full h-full object-cover">
                                                </template>
                                                <template x-if="!writingTask2.previewImage && !writingTask2.image">
                                                    <span class="text-gray-500 text-lg font-medium">Writing Task 2</span>
                                                </template>
                                            </div>
                                            <p class="text-sm text-gray-700 leading-relaxed mb-3" x-text="writingTask2.description || 'No description entered yet.'"></p>
                                            <div class="text-xs text-gray-500" x-show="writingTask2.tags">
                                                <span class="font-semibold">TAGS:</span> <span x-text="writingTask2.tags"></span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </template>
                            
                            <!-- Writing Questions List -->
                            <template x-if="mockExamSkill === 'writing' && writingExamView === 'list'">
                                <div>
                                    <template x-for="(question, index) in getFilteredMockExamQuestions()" :key="'writing-' + question.id">
                                        <div @click="openWritingExamDetail(question)" class="bg-white rounded-lg border border-gray-200 overflow-hidden group hover:shadow-md transition mb-4 cursor-pointer">
                                            <div class="flex gap-4 p-4">
                                        <!-- Image Placeholder -->
                                        <div class="flex-shrink-0">
                                            <div class="w-24 h-24 bg-blue-500 rounded-lg flex items-center justify-center overflow-hidden">
                                                <template x-if="question.image">
                                                    <img :src="question.image" alt="Writing exam image" class="w-full h-full object-cover">
                                                </template>
                                                <template x-if="!question.image">
                                                    <svg class="w-12 h-12 text-white opacity-50" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
                                                    </svg>
                                                </template>
                                            </div>
                                        </div>
                                        
                                        <!-- Content -->
                                        <div class="flex-1 flex flex-col justify-between min-w-0">
                                            <div>
                                                <h3 class="text-lg font-bold text-gray-900 mb-2" x-text="question.title || 'Writing exam ' + (index + 1)"></h3>
                                                <p class="text-sm text-gray-600 leading-relaxed line-clamp-3" x-text="question.prompt || question.description || 'No description available.'"></p>
                                            </div>
                                            
                                            <!-- Actions -->
                                            <div class="flex items-center gap-2 mt-3 opacity-0 group-hover:opacity-100 transition">
                                                <button :data-abel="JSON.stringify(question)" @click="showModal = 'editAbel'; editItem = JSON.parse($el.dataset.abel); previewImage = question.image || null" class="text-blue-600 hover:text-blue-700 p-1.5 rounded hover:bg-blue-50 transition" title="Edit">
                                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" /></svg>
                                                </button>
                                                <form action="/admin/delete-abel" method="POST" onsubmit="return confirm('Delete this exam?');" class="inline">
                                                    <input type="hidden" name="id" :value="question.id">
                                                    <button type="submit" class="text-red-600 hover:text-red-700 p-1.5 rounded hover:bg-red-50 transition" title="Delete">
                                                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg>
                                                    </button>
                                                </form>
                                            </div>
                                        </div>
                                    </div>
                                    </template>
                                </div>
                            </template>
                            
                            <!-- Reading Questions List -->
                            <template x-if="mockExamSkill === 'reading' && readingExamView === 'list'">
                                <div>
                                    <template x-for="(question, index) in getFilteredMockExamQuestions()" :key="'reading-' + index + '-' + (question.id || index)">
                                        <div :data-exam-id="question.id" @click.stop="const examId = parseInt($el.getAttribute('data-exam-id')) || parseInt(question.id) || null; console.log('Click - data-exam-id:', $el.getAttribute('data-exam-id'), 'question.id:', question.id, 'parsed examId:', examId); if (examId) { openReadingExamDetail(question, examId); } else { console.error('No ID found for question:', question); alert('Error: Exam ID not found'); }" class="bg-white rounded-lg border border-gray-200 overflow-hidden group hover:shadow-md transition mb-4 cursor-pointer">
                                            <div class="flex gap-4 p-4">
                                                <!-- Image Placeholder -->
                                                <div class="flex-shrink-0">
                                                    <div class="w-24 h-24 bg-green-500 rounded-lg flex items-center justify-center overflow-hidden">
                                                        <template x-if="question.image">
                                                            <img :src="question.image" alt="Reading exam image" class="w-full h-full object-cover">
                                                        </template>
                                                        <template x-if="!question.image">
                                                            <svg class="w-12 h-12 text-white opacity-50" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253"></path>
                                                            </svg>
                                                        </template>
                                                    </div>
                                                </div>
                                                
                                                <!-- Content -->
                                                <div class="flex-1 flex flex-col justify-between min-w-0">
                                                    <div>
                                                        <h3 class="text-lg font-bold text-gray-900 mb-2" x-text="question.title || 'Reading exam ' + (index + 1)"></h3>
                                                        <p class="text-sm text-gray-600 leading-relaxed line-clamp-3" x-text="question.prompt || question.description || 'No description available.'"></p>
                                                    </div>
                                                    
                                                    <!-- Actions -->
                                                    <div class="flex items-center gap-2 mt-3 opacity-0 group-hover:opacity-100 transition">
                                                        <button :data-abel="JSON.stringify(question)" @click.stop="showModal = 'editAbel'; editItem = JSON.parse($el.dataset.abel); previewImage = question.image || null" class="text-blue-600 hover:text-blue-700 p-1.5 rounded hover:bg-blue-50 transition" title="Edit">
                                                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" /></svg>
                                                        </button>
                                                        <form action="/admin/delete-abel" method="POST" onsubmit="return confirm('Delete this exam?');" class="inline">
                                                            <input type="hidden" name="id" :value="question.id">
                                                            <button type="submit" class="text-red-600 hover:text-red-700 p-1.5 rounded hover:bg-red-50 transition" title="Delete">
                                                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg>
                                                            </button>
                                                        </form>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </template>
                                </div>
                            </template>
                            
                            <!-- Reading Detail View -->
                            <template x-if="mockExamSkill === 'reading' && readingExamView === 'detail'">
                                <div class="bg-white rounded-lg shadow-sm">
                                    <!-- Header -->
                                    <div class="flex items-center justify-between p-6 border-b border-gray-200">
                                        <div class="flex items-center gap-4">
                                            <button @click="closeReadingExamDetail()" class="text-gray-500 hover:text-gray-800 p-2 hover:bg-gray-100 rounded-full transition">
                                                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"></path></svg>
                                            </button>
                                            <div>
                                                <h2 class="text-2xl font-bold text-gray-900">Reading</h2>
                                                <p class="text-sm text-gray-500" x-text="selectedReadingExam?.title || 'Reading Exam'"></p>
                                            </div>
                                        </div>
                                        <div class="flex items-center gap-3">
                                            <button x-show="readingExamSaved" @click="readingExamSaved = false" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition flex items-center gap-2">
                                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path></svg>
                                                Edit
                                            </button>
                                            <button x-show="!readingExamSaved" @click="saveReadingExam()" class="bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700 transition flex items-center gap-2">
                                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg>
                                                Save
                                            </button>
                                        </div>
                                    </div>
                                    
                                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 p-6">
                                        <!-- Reading Passage Content Editor (Left - 2 columns) -->
                                        <div x-show="!readingExamSaved" class="lg:col-span-2">
                                            <div class="border-2 border-dashed border-gray-300 rounded-lg p-8 min-h-[400px] bg-gray-50">
                                                <h3 class="text-lg font-semibold text-gray-700 mb-2">Content Editor</h3>
                                                <p class="text-sm text-gray-500 mb-4">Admin can edit the generated content here.</p>
                                                
                                                <!-- Reading Passage Input -->
                                                <div>
                                                    <label class="block text-sm font-medium text-gray-700 mb-2">Reading Passage</label>
                                                    <textarea x-model="readingPassage" placeholder="Enter or paste the reading passage content here..." class="w-full border border-gray-300 rounded-lg p-3 h-96 resize-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500"></textarea>
                                                </div>
                                            </div>
                                        </div>
                                        
                                        <!-- Multiple Choice Questions Editor (Right - 1 column) -->
                                        <div x-show="!readingExamSaved" class="lg:col-span-1">
                                            <div class="border-2 border-dashed border-gray-300 rounded-lg p-6 min-h-[400px] bg-gray-50">
                                                <h3 class="text-lg font-semibold text-gray-700 mb-4">Multiple Choice Questions</h3>
                                                
                                                <!-- Question Form -->
                                                <div class="space-y-4 mb-4">
                                                    <div>
                                                        <label class="block text-xs font-medium text-gray-700 mb-1">Question</label>
                                                        <textarea x-model="currentReadingQuestion.question" placeholder="Enter the question..." class="w-full border border-gray-300 rounded-lg p-2 h-20 resize-none text-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500"></textarea>
                                                    </div>
                                                    
                                                    <div>
                                                        <label class="block text-xs font-medium text-gray-700 mb-1">Option A</label>
                                                        <input type="text" x-model="currentReadingQuestion.optionA" placeholder="Option A" class="w-full border border-gray-300 rounded-lg p-2 text-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                                                    </div>
                                                    
                                                    <div>
                                                        <label class="block text-xs font-medium text-gray-700 mb-1">Option B</label>
                                                        <input type="text" x-model="currentReadingQuestion.optionB" placeholder="Option B" class="w-full border border-gray-300 rounded-lg p-2 text-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                                                    </div>
                                                    
                                                    <div>
                                                        <label class="block text-xs font-medium text-gray-700 mb-1">Option C</label>
                                                        <input type="text" x-model="currentReadingQuestion.optionC" placeholder="Option C" class="w-full border border-gray-300 rounded-lg p-2 text-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                                                    </div>
                                                    
                                                    <div>
                                                        <label class="block text-xs font-medium text-gray-700 mb-1">Option D</label>
                                                        <input type="text" x-model="currentReadingQuestion.optionD" placeholder="Option D" class="w-full border border-gray-300 rounded-lg p-2 text-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                                                    </div>
                                                    
                                                    <div>
                                                        <label class="block text-xs font-medium text-gray-700 mb-1">Correct Answer</label>
                                                        <select x-model="currentReadingQuestion.correctAnswer" class="w-full border border-gray-300 rounded-lg p-2 text-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                                                            <option :value="1">A</option>
                                                            <option :value="2">B</option>
                                                            <option :value="3">C</option>
                                                            <option :value="4">D</option>
                                                        </select>
                                                    </div>
                                                    
                                                    <div>
                                                        <label class="block text-xs font-medium text-gray-700 mb-1">Tags</label>
                                                        <input type="text" x-model="currentReadingQuestion.tags" placeholder="e.g., detail_recognition, Numbers" class="w-full border border-gray-300 rounded-lg p-2 text-sm">
                                                    </div>
                                                    
                                                    <button @click="addReadingQuestion()" class="w-full bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition text-sm font-medium">
                                                        Add Question
                                                    </button>
                                                </div>
                                                
                                                <!-- List of Added Questions -->
                                                <div class="mt-6 border-t border-gray-300 pt-4">
                                                    <h4 class="text-sm font-semibold text-gray-700 mb-3">Added Questions (<span x-text="readingQuestions.length"></span>)</h4>
                                                    <div class="space-y-2 max-h-64 overflow-y-auto">
                                                        <template x-for="(q, index) in readingQuestions" :key="q.id">
                                                            <div class="bg-white border border-gray-200 rounded-lg p-3 text-xs">
                                                                <div class="flex justify-between items-start mb-2">
                                                                    <span class="font-medium text-gray-900" x-text="'Q' + (index + 1) + ': ' + (q.question.substring(0, 40) + (q.question.length > 40 ? '...' : ''))"></span>
                                                                    <button @click="removeReadingQuestion(q.id)" class="text-red-600 hover:text-red-700" title="Remove">
                                                                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                                                                    </button>
                                                                </div>
                                                                <div class="text-gray-600" x-text="'Correct: ' + ['A', 'B', 'C', 'D'][q.correctAnswer - 1]"></div>
                                                            </div>
                                                        </template>
                                                        <p x-show="readingQuestions.length === 0" class="text-xs text-gray-400 text-center py-4">No questions added yet</p>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        
                                        <!-- Saved View (Full width after save) -->
                                        <div x-show="readingExamSaved" class="lg:col-span-3">
                                            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                                                <!-- Reading Passage Display -->
                                                <div class="lg:col-span-2">
                                                    <div class="bg-white border border-gray-200 rounded-lg p-6 shadow-sm">
                                                        <h3 class="text-lg font-bold text-gray-900 mb-4">Reading Passage</h3>
                                                        <div class="prose max-w-none text-sm text-gray-700 whitespace-pre-wrap" x-text="readingPassage || 'No passage entered yet.'"></div>
                                                    </div>
                                                </div>
                                                
                                                <!-- Questions Display -->
                                                <div class="lg:col-span-1">
                                                    <div class="bg-white border border-gray-200 rounded-lg p-6 shadow-sm">
                                                        <h3 class="text-lg font-bold text-gray-900 mb-4">Questions (<span x-text="readingQuestions.length"></span>)</h3>
                                                        <div class="space-y-4">
                                                            <template x-for="(q, index) in readingQuestions" :key="q.id">
                                                                <div class="border border-gray-200 rounded-lg p-4">
                                                                    <h4 class="text-sm font-semibold text-gray-900 mb-2" x-text="'Question ' + (index + 1)"></h4>
                                                                    <p class="text-xs text-gray-700 mb-3" x-text="q.question"></p>
                                                                    <div class="space-y-1 text-xs">
                                                                        <div :class="q.correctAnswer == 1 ? 'text-blue-600 font-medium' : 'text-gray-600'" x-text="'A. ' + q.optionA"></div>
                                                                        <div :class="q.correctAnswer == 2 ? 'text-blue-600 font-medium' : 'text-gray-600'" x-text="'B. ' + q.optionB"></div>
                                                                        <div :class="q.correctAnswer == 3 ? 'text-blue-600 font-medium' : 'text-gray-600'" x-text="'C. ' + q.optionC"></div>
                                                                        <div :class="q.correctAnswer == 4 ? 'text-blue-600 font-medium' : 'text-gray-600'" x-text="'D. ' + q.optionD"></div>
                                                                    </div>
                                                                    <div class="text-xs text-gray-500 mt-2" x-show="q.tags">
                                                                        <span class="font-semibold">TAGS:</span> <span x-text="q.tags"></span>
                                                                    </div>
                                                                </div>
                                                            </template>
                                                            <p x-show="readingQuestions.length === 0" class="text-xs text-gray-400 text-center py-4">No questions added yet</p>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </template>
                            
                            <!-- Reading/Listening/Speaking Questions -->
                            <!-- Listening Questions List -->
                            <template x-if="mockExamSkill === 'listening' && listeningExamView === 'list'">
                                <div>
                                    <template x-for="(question, index) in getFilteredMockExamQuestions()" :key="'listening-' + index + '-' + (question.id || index)">
                                        <div :data-exam-id="question.id" @click.stop="const examId = parseInt($el.getAttribute('data-exam-id')) || parseInt(question.id) || null; if (examId) { openListeningExamDetail(question, examId); } else { console.error('No ID found for question:', question); alert('Error: Exam ID not found'); }" class="bg-white rounded-lg border border-gray-200 overflow-hidden group hover:shadow-md transition mb-4 cursor-pointer">
                                            <div class="flex gap-4 p-4">
                                                <!-- Image Placeholder -->
                                                <div class="flex-shrink-0">
                                                    <div class="w-24 h-24 bg-purple-500 rounded-lg flex items-center justify-center overflow-hidden">
                                                        <template x-if="question.image">
                                                            <img :src="question.image" alt="Listening exam image" class="w-full h-full object-cover">
                                                        </template>
                                                        <template x-if="!question.image">
                                                            <svg class="w-12 h-12 text-white opacity-50" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11a7 7 0 01-7 7m0 0a7 7 0 01-7-7m7 7v4m0 0H8m4 0h4m-4-8a3 3 0 01-3-3V5a3 3 0 116 0v6a3 3 0 01-3 3z"></path>
                                                            </svg>
                                                        </template>
                                                    </div>
                                                </div>
                                                
                                                <!-- Content -->
                                                <div class="flex-1 flex flex-col justify-between min-w-0">
                                                    <div>
                                                        <h3 class="text-lg font-bold text-gray-900 mb-2" x-text="question.title || 'Listening exam ' + (index + 1)"></h3>
                                                        <p class="text-sm text-gray-600 leading-relaxed line-clamp-3" x-text="question.prompt || question.description || 'No description available.'"></p>
                                                    </div>
                                                    
                                                    <!-- Actions -->
                                                    <div class="flex items-center gap-2 mt-3 opacity-0 group-hover:opacity-100 transition">
                                                        <button :data-abel="JSON.stringify(question)" @click.stop="showModal = 'editAbel'; editItem = JSON.parse($el.dataset.abel); previewImage = question.image || null" class="text-blue-600 hover:text-blue-700 p-1.5 rounded hover:bg-blue-50 transition" title="Edit">
                                                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" /></svg>
                                                        </button>
                                                        <form action="/admin/delete-abel" method="POST" onsubmit="return confirm('Delete this exam?');" class="inline">
                                                            <input type="hidden" name="id" :value="question.id">
                                                            <button type="submit" class="text-red-600 hover:text-red-700 p-1.5 rounded hover:bg-red-50 transition" title="Delete">
                                                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg>
                                                            </button>
                                                        </form>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </template>
                                </div>
                            </template>
                            
                            <!-- Listening Detail View -->
                            <template x-if="mockExamSkill === 'listening' && listeningExamView === 'detail'">
                                <div class="bg-white rounded-lg shadow-sm">
                                    <!-- Header -->
                                    <div class="flex items-center justify-between p-6 border-b border-gray-200">
                                        <div class="flex items-center gap-4">
                                            <button @click="closeListeningExamDetail()" class="text-gray-500 hover:text-gray-800 p-2 hover:bg-gray-100 rounded-full transition">
                                                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"></path></svg>
                                            </button>
                                            <div>
                                                <h2 class="text-2xl font-bold text-gray-900">Listening</h2>
                                                <p class="text-sm text-gray-500" x-text="selectedListeningExam?.title || 'Listening Exam'"></p>
                                            </div>
                                        </div>
                                        <div class="flex items-center gap-3">
                                            <button x-show="!listeningExamSaved" @click="saveListeningExam()" class="bg-purple-600 text-white px-6 py-2 rounded-lg hover:bg-purple-700 transition font-medium">
                                                Save
                                            </button>
                                            <button x-show="listeningExamSaved" @click="listeningExamSaved = false" class="bg-blue-600 text-white px-6 py-2 rounded-lg hover:bg-blue-700 transition font-medium">
                                                Edit
                                            </button>
                                        </div>
                                    </div>
                                    
                                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 p-6">
                                        <!-- Audio & Script Editor (Left - 2 columns) -->
                                        <div x-show="!listeningExamSaved" class="lg:col-span-2">
                                            <div class="border-2 border-dashed border-gray-300 rounded-lg p-6 min-h-[400px] bg-gray-50">
                                                <h3 class="text-lg font-semibold text-gray-700 mb-4">Audio/Script Details</h3>
                                                
                                                <!-- Context/Narration Field -->
                                                <div class="mb-6">
                                                    <label class="block text-sm font-medium text-gray-700 mb-2">Context/Narration</label>
                                                    <textarea x-model="listeningNarration" placeholder="This conversation is between a Customer and a Receptionist..." class="w-full border border-gray-300 rounded-lg p-3 h-32 resize-none focus:ring-2 focus:ring-purple-500 focus:border-purple-500"></textarea>
                                                </div>
                                                
                                                <!-- Speaker Blocks -->
                                                <div class="space-y-4">
                                                    <div class="flex items-center justify-between mb-4">
                                                        <h4 class="text-sm font-semibold text-gray-700">Speaker Script Definition</h4>
                                                        <button @click="addListeningSpeaker()" class="text-sm bg-purple-600 text-white px-3 py-1.5 rounded-lg hover:bg-purple-700 transition">
                                                            Add Next Speaker
                                                        </button>
                                                    </div>
                                                    
                                                    <template x-for="(speaker, index) in listeningSpeakers" :key="index">
                                                        <div class="bg-white border border-gray-200 rounded-lg p-4">
                                                            <div class="flex items-center justify-between mb-3">
                                                                <div class="flex items-center gap-3">
                                                                    <label class="text-sm font-medium text-gray-700" x-text="speaker.role"></label>
                                                                </div>
                                                                <button @click="removeListeningSpeaker(index)" class="text-red-600 hover:text-red-700 text-sm" :disabled="listeningSpeakers.length === 1" :class="listeningSpeakers.length === 1 ? 'opacity-50 cursor-not-allowed' : ''">
                                                                    Remove
                                                                </button>
                                                            </div>
                                                            
                                                            <!-- Accent Dropdown -->
                                                            <div class="mb-3">
                                                                <label class="block text-xs font-medium text-gray-600 mb-1">Accent</label>
                                                                <select x-model="speaker.accent" class="w-full border border-gray-300 rounded-lg p-2 text-sm focus:ring-2 focus:ring-purple-500 focus:border-purple-500">
                                                                    <option value="British">British</option>
                                                                    <option value="American">American</option>
                                                                    <option value="Australian">Australian</option>
                                                                    <option value="Indian">Indian</option>
                                                                    <option value="Scottish">Scottish</option>
                                                                    <option value="Irish">Irish</option>
                                                                </select>
                                                            </div>
                                                            
                                                            <!-- Script Field -->
                                                            <div>
                                                                <label class="block text-xs font-medium text-gray-600 mb-1">Script</label>
                                                                <textarea x-model="speaker.script" placeholder="Enter the dialogue for this speaker..." class="w-full border border-gray-300 rounded-lg p-3 h-32 resize-none focus:ring-2 focus:ring-purple-500 focus:border-purple-500"></textarea>
                                                            </div>
                                                        </div>
                                                    </template>
                                                </div>
                                            </div>
                                        </div>
                                        
                                        <!-- Multiple Choice Questions Editor (Right - 1 column) -->
                                        <div x-show="!listeningExamSaved" class="lg:col-span-1">
                                            <div class="border-2 border-dashed border-gray-300 rounded-lg p-6 bg-gray-50">
                                                <h3 class="text-lg font-semibold text-gray-700 mb-4">Multiple Choice Questions (MCQ)</h3>
                                                
                                                <!-- Question Input Form -->
                                                <div class="space-y-3">
                                                    <div>
                                                        <label class="block text-xs font-medium text-gray-700 mb-1">Question</label>
                                                        <textarea x-model="currentListeningQuestion.question" placeholder="Enter question text..." class="w-full border border-gray-300 rounded-lg p-2 text-sm h-20 resize-none focus:ring-2 focus:ring-purple-500 focus:border-purple-500"></textarea>
                                                    </div>
                                                    
                                                    <div>
                                                        <label class="block text-xs font-medium text-gray-700 mb-1">Option A</label>
                                                        <input type="text" x-model="currentListeningQuestion.optionA" placeholder="Option A" class="w-full border border-gray-300 rounded-lg p-2 text-sm focus:ring-2 focus:ring-purple-500 focus:border-purple-500">
                                                    </div>
                                                    
                                                    <div>
                                                        <label class="block text-xs font-medium text-gray-700 mb-1">Option B</label>
                                                        <input type="text" x-model="currentListeningQuestion.optionB" placeholder="Option B" class="w-full border border-gray-300 rounded-lg p-2 text-sm focus:ring-2 focus:ring-purple-500 focus:border-purple-500">
                                                    </div>
                                                    
                                                    <div>
                                                        <label class="block text-xs font-medium text-gray-700 mb-1">Option C</label>
                                                        <input type="text" x-model="currentListeningQuestion.optionC" placeholder="Option C" class="w-full border border-gray-300 rounded-lg p-2 text-sm focus:ring-2 focus:ring-purple-500 focus:border-purple-500">
                                                    </div>
                                                    
                                                    <div>
                                                        <label class="block text-xs font-medium text-gray-700 mb-1">Option D</label>
                                                        <input type="text" x-model="currentListeningQuestion.optionD" placeholder="Option D" class="w-full border border-gray-300 rounded-lg p-2 text-sm focus:ring-2 focus:ring-purple-500 focus:border-purple-500">
                                                    </div>
                                                    
                                                    <div>
                                                        <label class="block text-xs font-medium text-gray-700 mb-1">Correct Answer</label>
                                                        <select x-model="currentListeningQuestion.correctAnswer" class="w-full border border-gray-300 rounded-lg p-2 text-sm focus:ring-2 focus:ring-purple-500 focus:border-purple-500">
                                                            <option :value="1">A</option>
                                                            <option :value="2">B</option>
                                                            <option :value="3">C</option>
                                                            <option :value="4">D</option>
                                                        </select>
                                                    </div>
                                                    
                                                    <div>
                                                        <label class="block text-xs font-medium text-gray-700 mb-1">Tags</label>
                                                        <input type="text" x-model="currentListeningQuestion.tags" placeholder="e.g., detail_recognition, Numbers" class="w-full border border-gray-300 rounded-lg p-2 text-sm">
                                                    </div>
                                                    
                                                    <button @click="addListeningQuestion()" class="w-full bg-purple-600 text-white px-4 py-2 rounded-lg hover:bg-purple-700 transition text-sm font-medium">
                                                        Add Question
                                                    </button>
                                                </div>
                                                
                                                <!-- List of Added Questions -->
                                                <div class="mt-6 border-t border-gray-300 pt-4">
                                                    <h4 class="text-sm font-semibold text-gray-700 mb-3">Added Questions (<span x-text="listeningQuestions.length"></span>)</h4>
                                                    <div class="space-y-2 max-h-64 overflow-y-auto custom-scroll">
                                                        <template x-for="(q, index) in listeningQuestions" :key="q.id">
                                                            <div class="bg-white border border-gray-200 rounded-lg p-3 flex items-start justify-between group">
                                                                <div class="flex-1 min-w-0">
                                                                    <p class="text-xs font-medium text-gray-900 mb-1">Q<span x-text="index + 1"></span>: <span x-text="q.question"></span></p>
                                                                    <p class="text-xs text-gray-600">Correct: <span x-text="['A', 'B', 'C', 'D'][q.correctAnswer - 1]"></span></p>
                                                                </div>
                                                                <button @click="removeListeningQuestion(q.id)" class="text-red-600 hover:text-red-700 opacity-0 group-hover:opacity-100 transition ml-2">
                                                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg>
                                                                </button>
                                                            </div>
                                                        </template>
                                                        <p x-show="listeningQuestions.length === 0" class="text-xs text-gray-400 text-center py-4">No questions added yet</p>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        
                                        <!-- Saved View (Full width after save) -->
                                        <div x-show="listeningExamSaved" class="lg:col-span-3">
                                            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                                                <!-- Audio/Script Display -->
                                                <div class="lg:col-span-2">
                                                    <div class="bg-white border border-gray-200 rounded-lg p-6 shadow-sm">
                                                        <h3 class="text-lg font-bold text-gray-900 mb-4">Audio/Script Details</h3>
                                                        <div class="mb-6">
                                                            <h4 class="text-sm font-semibold text-gray-700 mb-2">Context/Narration</h4>
                                                            <p class="text-sm text-gray-700 whitespace-pre-wrap" x-text="listeningNarration || 'No narration entered yet.'"></p>
                                                        </div>
                                                        <div class="space-y-4">
                                                            <template x-for="(speaker, index) in listeningSpeakers" :key="index">
                                                                <div class="border border-gray-200 rounded-lg p-4">
                                                                    <div class="flex items-center justify-between mb-2">
                                                                        <h4 class="text-sm font-semibold text-gray-900" x-text="speaker.role"></h4>
                                                                        <span class="text-xs text-gray-500" x-text="speaker.accent + ' accent'"></span>
                                                                    </div>
                                                                    <p class="text-sm text-gray-700 whitespace-pre-wrap" x-text="speaker.script || 'No script entered.'"></p>
                                                                </div>
                                                            </template>
                                                        </div>
                                                    </div>
                                                </div>
                                                
                                                <!-- Questions Display -->
                                                <div class="lg:col-span-1">
                                                    <div class="bg-white border border-gray-200 rounded-lg p-6 shadow-sm">
                                                        <h3 class="text-lg font-bold text-gray-900 mb-4">Questions (<span x-text="listeningQuestions.length"></span>)</h3>
                                                        <div class="space-y-4 max-h-96 overflow-y-auto custom-scroll">
                                                            <template x-for="(q, index) in listeningQuestions" :key="q.id">
                                                                <div class="border border-gray-200 rounded-lg p-4">
                                                                    <p class="text-sm font-semibold text-gray-900 mb-2">Q<span x-text="index + 1"></span>: <span x-text="q.question"></span></p>
                                                                    <div class="space-y-1 text-xs">
                                                                        <p :class="q.correctAnswer === 1 ? 'text-green-600 font-semibold' : 'text-gray-600'">A. <span x-text="q.optionA"></span></p>
                                                                        <p :class="q.correctAnswer === 2 ? 'text-green-600 font-semibold' : 'text-gray-600'">B. <span x-text="q.optionB"></span></p>
                                                                        <p :class="q.correctAnswer === 3 ? 'text-green-600 font-semibold' : 'text-gray-600'">C. <span x-text="q.optionC"></span></p>
                                                                        <p :class="q.correctAnswer === 4 ? 'text-green-600 font-semibold' : 'text-gray-600'">D. <span x-text="q.optionD"></span></p>
                                                                    </div>
                                                                    <p x-show="q.tags" class="text-xs text-gray-500 mt-2">Tags: <span x-text="q.tags"></span></p>
                                                                </div>
                                                            </template>
                                                            <p x-show="listeningQuestions.length === 0" class="text-sm text-gray-400 text-center py-4">No questions added yet</p>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </template>
                            
                            <!-- Speaking Questions List -->
                            <template x-if="mockExamSkill === 'speaking' && speakingExamView === 'list'">
                                <div>
                                    <template x-for="(question, index) in getFilteredMockExamQuestions()" :key="'speaking-' + index + '-' + (question.id || index)">
                                        <div :data-exam-id="question.id" @click.stop="const examId = parseInt($el.getAttribute('data-exam-id')) || parseInt(question.id) || null; if (examId) { openSpeakingExamDetail(question, examId); } else { console.error('No ID found for question:', question); alert('Error: Exam ID not found'); }" class="bg-white rounded-lg border border-gray-200 overflow-hidden group hover:shadow-md transition mb-4 cursor-pointer">
                                            <div class="flex gap-4 p-4">
                                                <!-- Image Placeholder -->
                                                <div class="flex-shrink-0">
                                                    <div class="w-24 h-24 bg-orange-500 rounded-lg flex items-center justify-center overflow-hidden">
                                                        <template x-if="question.image">
                                                            <img :src="question.image" alt="Speaking exam image" class="w-full h-full object-cover">
                                                        </template>
                                                        <template x-if="!question.image">
                                                            <svg class="w-12 h-12 text-white opacity-50" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 10h.01M12 10h.01M16 10h.01M9 16H5a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v8a2 2 0 01-2 2h-5l-5 5v-5z"></path>
                                                            </svg>
                                                        </template>
                                                    </div>
                                                </div>
                                                
                                                <!-- Content -->
                                                <div class="flex-1 flex flex-col justify-between min-w-0">
                                                    <div>
                                                        <h3 class="text-lg font-bold text-gray-900 mb-2" x-text="question.title || 'Speaking exam ' + (index + 1)"></h3>
                                                        <p class="text-sm text-gray-600 leading-relaxed line-clamp-3" x-text="question.prompt || question.description || 'No description available.'"></p>
                                                    </div>
                                                    
                                                    <!-- Actions -->
                                                    <div class="flex items-center gap-2 mt-3 opacity-0 group-hover:opacity-100 transition">
                                                        <button :data-abel="JSON.stringify(question)" @click.stop="showModal = 'editAbel'; editItem = JSON.parse($el.dataset.abel); previewImage = question.image || null" class="text-blue-600 hover:text-blue-700 p-1.5 rounded hover:bg-blue-50 transition" title="Edit">
                                                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" /></svg>
                                                        </button>
                                                        <form action="/admin/delete-abel" method="POST" onsubmit="return confirm('Delete this exam?');" class="inline">
                                                            <input type="hidden" name="id" :value="question.id">
                                                            <button type="submit" class="text-red-600 hover:text-red-700 p-1.5 rounded hover:bg-red-50 transition" title="Delete">
                                                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg>
                                                            </button>
                                                        </form>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </template>
                                </div>
                            </template>
                            
                            <!-- Speaking Detail View -->
                            <template x-if="mockExamSkill === 'speaking' && speakingExamView === 'detail'">
                                <div class="bg-white rounded-lg shadow-sm">
                                    <!-- Header -->
                                    <div class="flex items-center justify-between p-6 border-b border-gray-200">
                                        <div class="flex items-center gap-4">
                                            <button @click="closeSpeakingExamDetail()" class="text-gray-500 hover:text-gray-800 p-2 hover:bg-gray-100 rounded-full transition">
                                                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"></path></svg>
                                            </button>
                                            <div>
                                                <h2 class="text-2xl font-bold text-gray-900">Speaking</h2>
                                                <p class="text-sm text-gray-500" x-text="selectedSpeakingExam?.title || 'Speaking Exam'"></p>
                                            </div>
                                        </div>
                                        <div class="flex items-center gap-3">
                                            <button x-show="!speakingExamSaved" @click="saveSpeakingExam()" class="bg-orange-600 text-white px-6 py-2 rounded-lg hover:bg-orange-700 transition font-medium">
                                                Save
                                            </button>
                                            <button x-show="speakingExamSaved" @click="speakingExamSaved = false" class="bg-blue-600 text-white px-6 py-2 rounded-lg hover:bg-blue-700 transition font-medium">
                                                Edit
                                            </button>
                                        </div>
                                    </div>
                                    
                                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 p-6">
                                        <!-- Left Card: Module Content / Examiner Instructions -->
                                        <div x-show="!speakingExamSaved" class="lg:col-span-1">
                                            <div class="border-2 border-dashed border-gray-300 rounded-lg p-6 min-h-[500px] bg-gray-50">
                                                <h3 class="text-lg font-semibold text-gray-700 mb-4">Module Content / Examiner Instructions</h3>
                                                <p class="text-sm text-gray-500 mb-4">Write the introduction script or general exam guidelines that the examiner will read.</p>
                                                
                                                <!-- Rich Text Editor (Simple textarea for now, can be enhanced with WYSIWYG) -->
                                                <div>
                                                    <label class="block text-sm font-medium text-gray-700 mb-2">Content</label>
                                                    <textarea x-model="speakingModuleContent" placeholder="In this section, I will ask you some general questions about yourself..." class="w-full border border-gray-300 rounded-lg p-3 h-96 resize-none focus:ring-2 focus:ring-orange-500 focus:border-orange-500"></textarea>
                                                </div>
                                                
                                                <!-- Preview Section -->
                                                <div class="mt-4 border-t border-gray-300 pt-4">
                                                    <h4 class="text-sm font-semibold text-gray-700 mb-2">Preview</h4>
                                                    <div class="bg-white border border-gray-200 rounded-lg p-4 min-h-[100px] max-h-48 overflow-y-auto">
                                                        <p class="text-sm text-gray-700 whitespace-pre-wrap" x-text="speakingModuleContent || 'No content entered yet. Preview will appear here.'"></p>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        
                                        <!-- Right Card: Question Bank (Parts 1-3) -->
                                        <div x-show="!speakingExamSaved" class="lg:col-span-1">
                                            <div class="border-2 border-dashed border-gray-300 rounded-lg p-6 bg-gray-50 min-h-[500px]">
                                                <h3 class="text-lg font-semibold text-gray-700 mb-4">Question Bank</h3>
                                                
                                                <!-- Part Selector (Tabs) -->
                                                <div class="mb-4">
                                                    <div class="flex border-b border-gray-300">
                                                        <button @click="speakingCurrentPart = 1" :class="speakingCurrentPart === 1 ? 'border-b-2 border-orange-500 text-orange-600 font-semibold' : 'text-gray-600 hover:text-gray-800'" class="px-4 py-2 text-sm transition">
                                                            Part 1 (Introduction)
                                                        </button>
                                                        <button @click="speakingCurrentPart = 2" :class="speakingCurrentPart === 2 ? 'border-b-2 border-orange-500 text-orange-600 font-semibold' : 'text-gray-600 hover:text-gray-800'" class="px-4 py-2 text-sm transition">
                                                            Part 2 (Cue Card)
                                                        </button>
                                                        <button @click="speakingCurrentPart = 3" :class="speakingCurrentPart === 3 ? 'border-b-2 border-orange-500 text-orange-600 font-semibold' : 'text-gray-600 hover:text-gray-800'" class="px-4 py-2 text-sm transition">
                                                            Part 3 (Discussion)
                                                        </button>
                                                    </div>
                                                </div>
                                                
                                                <!-- Question Input Area -->
                                                <div class="mb-6 space-y-3">
                                                    <div>
                                                        <label class="block text-xs font-medium text-gray-700 mb-1">Question Prompt</label>
                                                        <textarea x-model="currentSpeakingQuestion.question" placeholder="e.g., Tell me about your hometown." class="w-full border border-gray-300 rounded-lg p-2 text-sm h-24 resize-none focus:ring-2 focus:ring-orange-500 focus:border-orange-500"></textarea>
                                                    </div>
                                                    
                                                    <div>
                                                        <label class="block text-xs font-medium text-gray-700 mb-1">Tags</label>
                                                        <input type="text" x-model="currentSpeakingQuestion.tags" placeholder="e.g., #hometown, #intro, #easy" class="w-full border border-gray-300 rounded-lg p-2 text-sm focus:ring-2 focus:ring-orange-500 focus:border-orange-500">
                                                    </div>
                                                    
                                                    <button @click="addSpeakingQuestion()" class="w-full bg-orange-600 text-white px-4 py-2 rounded-lg hover:bg-orange-700 transition text-sm font-medium">
                                                        Add Prompt
                                                    </button>
                                                </div>
                                                
                                                <!-- Active Question List (Grouped by Part) -->
                                                <div class="border-t border-gray-300 pt-4">
                                                    <h4 class="text-sm font-semibold text-gray-700 mb-3">Active Questions</h4>
                                                    <div class="space-y-4 max-h-96 overflow-y-auto custom-scroll">
                                                        <!-- Part 1 Questions -->
                                                        <div x-show="speakingQuestions.part1.length > 0">
                                                            <h5 class="text-xs font-bold text-gray-600 mb-2 uppercase">Part 1 (Introduction)</h5>
                                                            <div class="space-y-2">
                                                                <template x-for="(q, index) in speakingQuestions.part1" :key="q.id">
                                                                    <div class="bg-white border border-gray-200 rounded-lg p-3 flex items-start justify-between group">
                                                                        <div class="flex-1 min-w-0">
                                                                            <p class="text-xs font-medium text-gray-900">Q<span x-text="index + 1"></span>: <span x-text="q.question"></span></p>
                                                                            <p x-show="q.tags" class="text-xs text-gray-500 mt-1">Tags: <span x-text="q.tags"></span></p>
                                                                        </div>
                                                                        <div class="flex items-center gap-2 ml-2">
                                                                            <button @click="editSpeakingQuestion(1, q.id)" class="text-blue-600 hover:text-blue-700 opacity-0 group-hover:opacity-100 transition text-xs">
                                                                                Edit
                                                                            </button>
                                                                            <button @click="removeSpeakingQuestion(1, q.id)" class="text-red-600 hover:text-red-700 opacity-0 group-hover:opacity-100 transition text-xs">
                                                                                Delete
                                                                            </button>
                                                                        </div>
                                                                    </div>
                                                                </template>
                                                            </div>
                                                        </div>
                                                        
                                                        <!-- Part 2 Questions -->
                                                        <div x-show="speakingQuestions.part2.length > 0">
                                                            <h5 class="text-xs font-bold text-gray-600 mb-2 uppercase">Part 2 (Cue Card)</h5>
                                                            <div class="space-y-2">
                                                                <template x-for="(q, index) in speakingQuestions.part2" :key="q.id">
                                                                    <div class="bg-white border border-gray-200 rounded-lg p-3 flex items-start justify-between group">
                                                                        <div class="flex-1 min-w-0">
                                                                            <p class="text-xs font-medium text-gray-900">Q<span x-text="index + 1"></span>: <span x-text="q.question"></span></p>
                                                                            <p x-show="q.tags" class="text-xs text-gray-500 mt-1">Tags: <span x-text="q.tags"></span></p>
                                                                        </div>
                                                                        <div class="flex items-center gap-2 ml-2">
                                                                            <button @click="editSpeakingQuestion(2, q.id)" class="text-blue-600 hover:text-blue-700 opacity-0 group-hover:opacity-100 transition text-xs">
                                                                                Edit
                                                                            </button>
                                                                            <button @click="removeSpeakingQuestion(2, q.id)" class="text-red-600 hover:text-red-700 opacity-0 group-hover:opacity-100 transition text-xs">
                                                                                Delete
                                                                            </button>
                                                                        </div>
                                                                    </div>
                                                                </template>
                                                            </div>
                                                        </div>
                                                        
                                                        <!-- Part 3 Questions -->
                                                        <div x-show="speakingQuestions.part3.length > 0">
                                                            <h5 class="text-xs font-bold text-gray-600 mb-2 uppercase">Part 3 (Discussion)</h5>
                                                            <div class="space-y-2">
                                                                <template x-for="(q, index) in speakingQuestions.part3" :key="q.id">
                                                                    <div class="bg-white border border-gray-200 rounded-lg p-3 flex items-start justify-between group">
                                                                        <div class="flex-1 min-w-0">
                                                                            <p class="text-xs font-medium text-gray-900">Q<span x-text="index + 1"></span>: <span x-text="q.question"></span></p>
                                                                            <p x-show="q.tags" class="text-xs text-gray-500 mt-1">Tags: <span x-text="q.tags"></span></p>
                                                                        </div>
                                                                        <div class="flex items-center gap-2 ml-2">
                                                                            <button @click="editSpeakingQuestion(3, q.id)" class="text-blue-600 hover:text-blue-700 opacity-0 group-hover:opacity-100 transition text-xs">
                                                                                Edit
                                                                            </button>
                                                                            <button @click="removeSpeakingQuestion(3, q.id)" class="text-red-600 hover:text-red-700 opacity-0 group-hover:opacity-100 transition text-xs">
                                                                                Delete
                                                                            </button>
                                                                        </div>
                                                                    </div>
                                                                </template>
                                                            </div>
                                                        </div>
                                                        
                                                        <p x-show="speakingQuestions.part1.length === 0 && speakingQuestions.part2.length === 0 && speakingQuestions.part3.length === 0" class="text-xs text-gray-400 text-center py-4">No questions added yet. Select a part and add your first question.</p>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        
                                        <!-- Saved View (Full width after save) -->
                                        <div x-show="speakingExamSaved" class="lg:col-span-2">
                                            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                                                <!-- Module Content Display -->
                                                <div>
                                                    <div class="bg-white border border-gray-200 rounded-lg p-6 shadow-sm">
                                                        <h3 class="text-lg font-bold text-gray-900 mb-4">Module Content / Examiner Instructions</h3>
                                                        <div class="prose max-w-none text-sm text-gray-700 whitespace-pre-wrap" x-text="speakingModuleContent || 'No content entered yet.'"></div>
                                                    </div>
                                                </div>
                                                
                                                <!-- Questions Display (Grouped by Part) -->
                                                <div>
                                                    <div class="bg-white border border-gray-200 rounded-lg p-6 shadow-sm">
                                                        <h3 class="text-lg font-bold text-gray-900 mb-4">Question Bank</h3>
                                                        <div class="space-y-6 max-h-96 overflow-y-auto custom-scroll">
                                                            <!-- Part 1 -->
                                                            <div x-show="speakingQuestions.part1.length > 0">
                                                                <h4 class="text-sm font-bold text-gray-700 mb-3 uppercase">Part 1 (Introduction)</h4>
                                                                <div class="space-y-2">
                                                                    <template x-for="(q, index) in speakingQuestions.part1" :key="q.id">
                                                                        <div class="border border-gray-200 rounded-lg p-3">
                                                                            <p class="text-sm font-semibold text-gray-900">Q<span x-text="index + 1"></span>: <span x-text="q.question"></span></p>
                                                                            <p x-show="q.tags" class="text-xs text-gray-500 mt-1">Tags: <span x-text="q.tags"></span></p>
                                                                        </div>
                                                                    </template>
                                                                </div>
                                                            </div>
                                                            
                                                            <!-- Part 2 -->
                                                            <div x-show="speakingQuestions.part2.length > 0">
                                                                <h4 class="text-sm font-bold text-gray-700 mb-3 uppercase">Part 2 (Cue Card)</h4>
                                                                <div class="space-y-2">
                                                                    <template x-for="(q, index) in speakingQuestions.part2" :key="q.id">
                                                                        <div class="border border-gray-200 rounded-lg p-3">
                                                                            <p class="text-sm font-semibold text-gray-900">Q<span x-text="index + 1"></span>: <span x-text="q.question"></span></p>
                                                                            <p x-show="q.tags" class="text-xs text-gray-500 mt-1">Tags: <span x-text="q.tags"></span></p>
                                                                        </div>
                                                                    </template>
                                                                </div>
                                                            </div>
                                                            
                                                            <!-- Part 3 -->
                                                            <div x-show="speakingQuestions.part3.length > 0">
                                                                <h4 class="text-sm font-bold text-gray-700 mb-3 uppercase">Part 3 (Discussion)</h4>
                                                                <div class="space-y-2">
                                                                    <template x-for="(q, index) in speakingQuestions.part3" :key="q.id">
                                                                        <div class="border border-gray-200 rounded-lg p-3">
                                                                            <p class="text-sm font-semibold text-gray-900">Q<span x-text="index + 1"></span>: <span x-text="q.question"></span></p>
                                                                            <p x-show="q.tags" class="text-xs text-gray-500 mt-1">Tags: <span x-text="q.tags"></span></p>
                                                                        </div>
                                                                    </template>
                                                                </div>
                                                            </div>
                                                            
                                                            <p x-show="speakingQuestions.part1.length === 0 && speakingQuestions.part2.length === 0 && speakingQuestions.part3.length === 0" class="text-sm text-gray-400 text-center py-4">No questions added yet</p>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </template>
                            
                            <template x-if="mockExamSkill !== 'writing' && mockExamSkill !== 'reading' && mockExamSkill !== 'listening' && mockExamSkill !== 'speaking'">
                                <template x-for="(question, index) in getFilteredMockExamQuestions()" :key="'other-' + question.id">
                                <!-- Reading/Listening Questions (most common) -->
                                <div x-show="question.type === 'Reading' || question.type === 'Listening'" class="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden group hover:shadow-md transition">
                                    <div class="p-6">
                                        <div class="flex justify-between items-start mb-4">
                                            <div class="flex items-center gap-3">
                                                <span class="px-3 py-1 rounded-full text-xs font-bold uppercase tracking-wide" 
                                                      :class="question.type === 'Reading' ? 'bg-yellow-100 text-yellow-700' : 'bg-blue-100 text-blue-700'"
                                                      x-text="question.type"></span>
                                                <h3 class="text-xl font-bold text-gray-900">
                                                    <span class="text-gray-500 font-normal text-lg" x-text="'Question ' + (index + 1)"></span>
                                                </h3>
                                            </div>
                                            <div class="flex items-center gap-2 opacity-80 group-hover:opacity-100 transition">
                                                <button :data-abel="JSON.stringify(question)" @click="showModal = 'editAbel'; editItem = JSON.parse($el.dataset.abel)" class="text-blue-500 hover:text-blue-700 p-2 rounded-full hover:bg-blue-50 transition" title="Edit">
                                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" /></svg>
                                                </button>
                                                <form action="/admin/delete-abel" method="POST" onsubmit="return confirm('Delete this item?');">
                                                    <input type="hidden" name="id" :value="question.id">
                                                    <button type="submit" class="text-red-500 hover:text-red-700 p-2 rounded-full hover:bg-red-50 transition">
                                                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg>
                                                    </button>
                                                </form>
                                            </div>
                                        </div>
                                        
                                        <div class="mb-6">
                                            <div class="bg-purple-50 border-l-4 border-purple-500 p-4 rounded-r-lg">
                                                <p class="text-lg text-gray-800 font-medium leading-relaxed" x-text="question.prompt || question.question || 'No question available.'"></p>
                                            </div>
                                        </div>
                                        
                                        <div class="space-y-3">
                                            <div class="p-4 border-2 rounded-lg transition-all" :class="(question.correctAnswer || 1) === 1 ? 'border-green-500 bg-green-50 shadow-sm' : 'border-gray-200 bg-gray-50 hover:border-gray-300'">
                                                <div class="flex items-start gap-3">
                                                    <span class="flex-shrink-0 w-6 h-6 rounded-full flex items-center justify-center text-xs font-bold" :class="(question.correctAnswer || 1) === 1 ? 'bg-green-500 text-white' : 'bg-gray-300 text-gray-700'">A</span>
                                                    <p class="text-sm text-gray-700 flex-1" x-text="question.optionA || 'A. Option A'"></p>
                                                    <template x-if="(question.correctAnswer || 1) === 1">
                                                        <span class="flex-shrink-0 text-green-600 font-semibold text-xs">✓ Correct</span>
                                                    </template>
                                                </div>
                                            </div>
                                            <div class="p-4 border-2 rounded-lg transition-all" :class="(question.correctAnswer || 1) === 2 ? 'border-green-500 bg-green-50 shadow-sm' : 'border-gray-200 bg-gray-50 hover:border-gray-300'">
                                                <div class="flex items-start gap-3">
                                                    <span class="flex-shrink-0 w-6 h-6 rounded-full flex items-center justify-center text-xs font-bold" :class="(question.correctAnswer || 1) === 2 ? 'bg-green-500 text-white' : 'bg-gray-300 text-gray-700'">B</span>
                                                    <p class="text-sm text-gray-700 flex-1" x-text="question.optionB || 'B. Option B'"></p>
                                                    <template x-if="(question.correctAnswer || 1) === 2">
                                                        <span class="flex-shrink-0 text-green-600 font-semibold text-xs">✓ Correct</span>
                                                    </template>
                                                </div>
                                            </div>
                                            <div class="p-4 border-2 rounded-lg transition-all" :class="(question.correctAnswer || 1) === 3 ? 'border-green-500 bg-green-50 shadow-sm' : 'border-gray-200 bg-gray-50 hover:border-gray-300'">
                                                <div class="flex items-start gap-3">
                                                    <span class="flex-shrink-0 w-6 h-6 rounded-full flex items-center justify-center text-xs font-bold" :class="(question.correctAnswer || 1) === 3 ? 'bg-green-500 text-white' : 'bg-gray-300 text-gray-700'">C</span>
                                                    <p class="text-sm text-gray-700 flex-1" x-text="question.optionC || 'C. Option C'"></p>
                                                    <template x-if="(question.correctAnswer || 1) === 3">
                                                        <span class="flex-shrink-0 text-green-600 font-semibold text-xs">✓ Correct</span>
                                                    </template>
                                                </div>
                                            </div>
                                            <div class="p-4 border-2 rounded-lg transition-all" :class="(question.correctAnswer || 1) === 4 ? 'border-green-500 bg-green-50 shadow-sm' : 'border-gray-200 bg-gray-50 hover:border-gray-300'">
                                                <div class="flex items-start gap-3">
                                                    <span class="flex-shrink-0 w-6 h-6 rounded-full flex items-center justify-center text-xs font-bold" :class="(question.correctAnswer || 1) === 4 ? 'bg-green-500 text-white' : 'bg-gray-300 text-gray-700'">D</span>
                                                    <p class="text-sm text-gray-700 flex-1" x-text="question.optionD || 'D. Option D'"></p>
                                                    <template x-if="(question.correctAnswer || 1) === 4">
                                                        <span class="flex-shrink-0 text-green-600 font-semibold text-xs">✓ Correct</span>
                                                    </template>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Speaking Question Card -->
                                <div x-show="question.type === 'Speaking'">
                                    <div class="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden group hover:shadow-md transition mb-4">
                                        <div class="p-6">
                                            <div class="flex justify-between items-start mb-4">
                                                <div class="flex items-center gap-3">
                                                    <span class="px-3 py-1 rounded-full text-xs font-bold uppercase tracking-wide bg-yellow-100 text-yellow-700">Speaking</span>
                                                    <h3 class="text-xl font-bold text-gray-900">
                                                        <span class="text-gray-500 font-normal text-lg" x-text="'Part ' + (question.part || 1)"></span>
                                                    </h3>
                                                </div>
                                                <div class="flex items-center gap-2 opacity-80 group-hover:opacity-100 transition">
                                                    <button :data-abel="JSON.stringify(question)" @click="showModal = 'editAbel'; editItem = JSON.parse($el.dataset.abel)" class="text-blue-500 hover:text-blue-700 p-2 rounded-full hover:bg-blue-50 transition" title="Edit">
                                                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" /></svg>
                                                    </button>
                                                    <form action="/admin/delete-abel" method="POST" onsubmit="return confirm('Delete this item?');">
                                                        <input type="hidden" name="id" :value="question.id">
                                                        <button type="submit" class="text-red-500 hover:text-red-700 p-2 rounded-full hover:bg-red-50 transition">
                                                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg>
                                                        </button>
                                                    </form>
                                                </div>
                                            </div>
                                            
                                            <!-- Part Title -->
                                            <div class="mb-6">
                                                <h5 class="text-xl font-bold text-gray-900 mb-2" x-text="getSpeakingPartTitleForQuestion(question.part || 1)"></h5>
                                            </div>

                                            <!-- Question Navigation -->
                                            <div class="mb-6 flex gap-2">
                                                <button 
                                                    disabled
                                                    :class="(question.questionNumber || 1) === 1 ? 'bg-blue-600 text-white' : 'bg-gray-100 text-gray-700'"
                                                    class="flex-1 px-4 py-2 rounded-lg transition font-medium text-sm cursor-default"
                                                >
                                                    Question 1
                                                </button>
                                                <button 
                                                    disabled
                                                    :class="(question.questionNumber || 1) === 2 ? 'bg-blue-600 text-white' : 'bg-gray-100 text-gray-700'"
                                                    class="flex-1 px-4 py-2 rounded-lg transition font-medium text-sm cursor-default"
                                                >
                                                    Question 2
                                                </button>
                                            </div>

                                            <!-- Question Display -->
                                            <div class="bg-yellow-50 border-l-4 border-yellow-500 rounded-r-lg p-5">
                                                <p class="text-lg text-gray-800 font-medium leading-relaxed" x-text="(question.questionNumber === 1 ? question.question1 : question.question2) || question.prompt || 'No question available.'"></p>
                                            </div>
                                        </div>
                                    </div>
                                </template>
                            </template>
                            
                            <!-- Empty State -->
                            <div x-show="getFilteredMockExamQuestions().length === 0" class="text-center py-12 border border-dashed border-gray-300 rounded-lg bg-gray-50">
                                <div class="inline-flex items-center justify-center w-16 h-16 rounded-full bg-purple-50 mb-4">
                                    <svg class="w-8 h-8 text-purple-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path></svg>
                                </div>
                                <h3 class="text-lg font-medium text-gray-900" x-text="mockExamSkill === 'writing' ? 'No exams yet' : 'No questions yet'"></h3>
                                <p class="text-gray-500 max-w-sm mx-auto mt-1">
                                    <span x-show="mockExamSkill === 'writing'">Click "Add Exam" to create your first writing exam.</span>
                                    <span x-show="mockExamSkill !== 'writing'">Click "+ Add Question" to create your first <span x-text="mockExamSkill" class="font-semibold"></span> question.</span>
                                </p>
                            </div>
                        </div>
                    </div>
                </template>
            </div>

        </main>
    </div>

    <!-- MODALS -->

    <!-- Module Stats (Clean White) -->
    <div x-show="showModal === 'moduleStats'" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50" x-cloak><div class="bg-white rounded-xl p-8 w-full max-w-lg shadow-2xl transform transition-all" @click.away="showModal = false"><div class="flex justify-between items-start mb-6"><div><h3 class="text-2xl font-bold text-gray-900" x-text="selectedUser?.userName || 'User'"></h3><div class="text-gray-500 text-sm mt-1" x-text="selectedUser?.userEmail"></div><span class="inline-block mt-2 px-3 py-1 rounded-full text-xs font-semibold" :class="getLevelClass(selectedUser?.userRank)" x-text="selectedUser?.userRank"></span></div><button @click="showModal = false" class="text-gray-400 hover:text-gray-600"><svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg></button></div><h4 class="text-lg font-semibold text-gray-800 mb-4 pb-2 border-b border-gray-100">Performance Overview</h4><div class="space-y-5"><div><div class="flex justify-between text-sm mb-1"><span class="text-gray-600 font-medium">Speaking</span><span class="font-bold text-blue-600" x-text="((selectedUser?.modules?.[currentModuleIndex]?.scores?.speaking || 0) / 9 * 100).toFixed(0) + '%'"></span></div><div class="w-full bg-gray-100 rounded-full h-2.5"><div class="bg-blue-600 h-2.5 rounded-full" :style="'width: ' + ((selectedUser?.modules?.[currentModuleIndex]?.scores?.speaking || 0) / 9 * 100) + '%'"></div></div></div><div><div class="flex justify-between text-sm mb-1"><span class="text-gray-600 font-medium">Listening</span><span class="font-bold text-green-500" x-text="((selectedUser?.modules?.[currentModuleIndex]?.scores?.listening || 0) / 9 * 100).toFixed(0) + '%'"></span></div><div class="w-full bg-gray-100 rounded-full h-2.5"><div class="bg-green-500 h-2.5 rounded-full" :style="'width: ' + ((selectedUser?.modules?.[currentModuleIndex]?.scores?.listening || 0) / 9 * 100) + '%'"></div></div></div><div><div class="flex justify-between text-sm mb-1"><span class="text-gray-600 font-medium">Reading</span><span class="font-bold text-yellow-500" x-text="((selectedUser?.modules?.[currentModuleIndex]?.scores?.reading || 0) / 9 * 100).toFixed(0) + '%'"></span></div><div class="w-full bg-gray-100 rounded-full h-2.5"><div class="bg-yellow-500 h-2.5 rounded-full" :style="'width: ' + ((selectedUser?.modules?.[currentModuleIndex]?.scores?.reading || 0) / 9 * 100) + '%'"></div></div></div><div><div class="flex justify-between text-sm mb-1"><span class="text-gray-600 font-medium">Writing</span><span class="font-bold text-purple-500" x-text="((selectedUser?.modules?.[currentModuleIndex]?.scores?.writing || 0) / 9 * 100).toFixed(0) + '%'"></span></div><div class="w-full bg-gray-100 rounded-full h-2.5"><div class="bg-purple-500 h-2.5 rounded-full" :style="'width: ' + ((selectedUser?.modules?.[currentModuleIndex]?.scores?.writing || 0) / 9 * 100) + '%'"></div></div></div></div><div class="mt-8 flex justify-end"><button @click="showModal = false" class="bg-gray-100 hover:bg-gray-200 text-gray-700 px-6 py-2 rounded-lg font-medium transition">Close</button></div></div></div>
    
    <!-- User Stats -->
    <div x-show="showModal === 'viewStats'" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50" x-cloak><div class="bg-white rounded-xl p-8 w-full max-w-lg shadow-2xl transform transition-all" @click.away="showModal = false"><div class="flex justify-between items-start mb-6"><div><h3 class="text-2xl font-bold text-gray-900" x-text="viewUser.name"></h3><div class="text-gray-500 text-sm mt-1" x-text="viewUser.email"></div><span class="inline-block mt-2 px-3 py-1 rounded-full text-xs font-semibold" :class="getLevelClass(viewUser.level)" x-text="viewUser.level"></span></div><button @click="showModal = false" class="text-gray-400 hover:text-gray-600"><svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg></button></div><h4 class="text-lg font-semibold text-gray-800 mb-4 pb-2 border-b border-gray-100">Performance Overview</h4><div class="space-y-5"><div><div class="flex justify-between text-sm mb-1"><span class="text-gray-600 font-medium">Speaking</span><span class="font-bold text-blue-600" x-text="viewUser.stats?.speaking + '%'"></span></div><div class="w-full bg-gray-100 rounded-full h-2.5"><div class="bg-blue-600 h-2.5 rounded-full" :style="'width: ' + (viewUser.stats?.speaking || 0) + '%'"></div></div></div><div><div class="flex justify-between text-sm mb-1"><span class="text-gray-600 font-medium">Listening</span><span class="font-bold text-green-500" x-text="viewUser.stats?.listening + '%'"></span></div><div class="w-full bg-gray-100 rounded-full h-2.5"><div class="bg-green-500 h-2.5 rounded-full" :style="'width: ' + (viewUser.stats?.listening || 0) + '%'"></div></div></div><div><div class="flex justify-between text-sm mb-1"><span class="text-gray-600 font-medium">Reading</span><span class="font-bold text-yellow-500" x-text="viewUser.stats?.reading + '%'"></span></div><div class="w-full bg-gray-100 rounded-full h-2.5"><div class="bg-yellow-500 h-2.5 rounded-full" :style="'width: ' + (viewUser.stats?.reading || 0) + '%'"></div></div></div><div><div class="flex justify-between text-sm mb-1"><span class="text-gray-600 font-medium">Writing</span><span class="font-bold text-purple-500" x-text="viewUser.stats?.writing + '%'"></span></div><div class="w-full bg-gray-100 rounded-full h-2.5"><div class="bg-purple-500 h-2.5 rounded-full" :style="'width: ' + (viewUser.stats?.writing || 0) + '%'"></div></div></div></div><div class="mt-8 flex justify-end"><button @click="showModal = false" class="bg-gray-100 hover:bg-gray-200 text-gray-700 px-6 py-2 rounded-lg font-medium transition">Close</button></div></div></div>
    
    <!-- Edit User Modal -->
    <div x-show="showModal === 'editUser'" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50" x-cloak>
        <div class="bg-white rounded-xl p-6 w-full max-w-md shadow-2xl">
            <h3 class="text-xl font-bold mb-4">Edit User</h3>
            <form action="/admin/edit-user" method="POST" class="space-y-4">
                <input type="hidden" name="id" x-model="editItem.id">
                <div>
                    <label class="text-xs text-gray-500">Name</label>
                    <input type="text" name="name" x-model="editItem.name" required class="w-full border p-2 rounded">
                </div>
                <div>
                    <label class="text-xs text-gray-500">Email</label>
                    <input type="email" name="email" x-model="editItem.email" required class="w-full border p-2 rounded">
                    </div>
                    <div>
                        <label class="text-xs text-gray-500">Level</label>
                        <select name="level" x-model="editItem.level" disabled class="w-full border p-2 rounded bg-gray-50 text-gray-500 cursor-not-allowed">
                            <option value="Beginner">Beginner</option>
                            <option value="Pre-Intermediate">Pre-Intermediate</option>
                            <option value="Intermediate">Intermediate</option>
                            <option value="Advanced">Advanced</option>
                        </select>
                </div>
                <div class="flex justify-end gap-2 mt-4">
                    <button type="button" @click="showModal = false" class="px-4 py-2 border rounded">Cancel</button>
                    <button type="submit" class="px-4 py-2 bg-blue-600 text-white rounded">Update</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Add Regular Writing Exam Modal -->
    <div x-show="showModal === 'addRegularWriting'" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50" x-cloak>
        <div class="bg-white rounded-xl p-6 w-full max-w-md shadow-2xl">
            <h3 class="text-xl font-bold mb-4 text-blue-800">Create New Writing Exam</h3>
            <form @submit.prevent="
                fetch('/admin/add-regular-writing-exam', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ title: editItem.title, description: editItem.description })
                })
                .then(res => res.json())
                .then(data => {
                    if (data.success) {
                        initRegularWritingExams();
                        showModal = false;
                        editItem = {};
                        regularWritingView = 'list';
                        openRegularWritingExamDetail(data.exam);
                    } else {
                        alert('Error: ' + (data.error || 'Unknown error'));
                    }
                })
                .catch(err => alert('Error: ' + err.message));
            " class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Title</label>
                    <input type="text" x-model="editItem.title" placeholder="e.g., General Writing Practice 3" required class="w-full border border-gray-300 rounded-lg p-2 focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Details/Description</label>
                    <textarea x-model="editItem.description" placeholder="e.g., Focuses on formal letter writing and opinion essays." class="w-full border border-gray-300 rounded-lg p-2 h-24 resize-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500"></textarea>
                </div>
                <div class="flex justify-end gap-2 mt-6">
                    <button type="button" @click="showModal = false; editItem = {}" class="px-4 py-2 border border-gray-300 rounded text-gray-600 hover:bg-gray-50 transition">Cancel</button>
                    <button type="submit" class="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700 transition">Create Exam</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Add Regular Reading Exam Modal -->
    <div x-show="showModal === 'addRegularReading'" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50" x-cloak>
        <div class="bg-white rounded-xl p-6 w-full max-w-md shadow-2xl">
            <h3 class="text-xl font-bold mb-4 text-green-800">Create New Reading Exam</h3>
            <form @submit.prevent="
                fetch('/admin/add-regular-reading-exam', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ title: editItem.title, description: editItem.description })
                })
                .then(res => res.json())
                .then(data => {
                    if (data.success) {
                        initRegularReadingExams();
                        showModal = false;
                        editItem = {};
                        regularReadingView = 'list';
                    } else {
                        alert('Error: ' + (data.error || 'Unknown error'));
                    }
                })
                .catch(err => alert('Error: ' + err.message));
            " class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Title</label>
                    <input type="text" x-model="editItem.title" placeholder="e.g., Reading Comprehension: Science & Nature" required class="w-full border border-gray-300 rounded-lg p-2 focus:ring-2 focus:ring-green-500 focus:border-green-500">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Details/Description</label>
                    <textarea x-model="editItem.description" placeholder="e.g., Intermediate level text about climate change." class="w-full border border-gray-300 rounded-lg p-2 h-24 resize-none focus:ring-2 focus:ring-green-500 focus:border-green-500"></textarea>
                </div>
                <div class="flex justify-end gap-2 mt-6">
                    <button type="button" @click="showModal = false; editItem = {}" class="px-4 py-2 border border-gray-300 rounded text-gray-600 hover:bg-gray-50 transition">Cancel</button>
                    <button type="submit" class="px-4 py-2 bg-green-600 text-white rounded hover:bg-green-700 transition">Create Exam</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Add Regular Listening Exam Modal -->
    <div x-show="showModal === 'addRegularListening'" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50" x-cloak>
        <div class="bg-white rounded-xl p-6 w-full max-w-md shadow-2xl">
            <h3 class="text-xl font-bold mb-4 text-purple-800">Create New Listening Exam</h3>
            <form @submit.prevent="
                fetch('/admin/add-regular-listening-exam', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ title: editItem.title, description: editItem.description })
                })
                .then(res => res.json())
                .then(data => {
                    if (data.success) {
                        initRegularListeningExams();
                        showModal = false;
                        editItem = {};
                        regularListeningView = 'list';
                        openRegularListeningExamDetail(data.exam);
                    } else {
                        alert('Error: ' + (data.error || 'Unknown error'));
                    }
                })
                .catch(err => alert('Error: ' + err.message));
            " class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Exam Title</label>
                    <input type="text" x-model="editItem.title" placeholder="e.g., Daily Conversation Practice" required class="w-full border border-gray-300 rounded-lg p-2 focus:ring-2 focus:ring-purple-500 focus:border-purple-500">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Description</label>
                    <textarea x-model="editItem.description" placeholder="e.g., Focus on phone numbers and dates" class="w-full border border-gray-300 rounded-lg p-2 h-24 resize-none focus:ring-2 focus:ring-purple-500 focus:border-purple-500"></textarea>
                </div>
                <div class="flex justify-end gap-2 mt-6">
                    <button type="button" @click="showModal = false; editItem = {}" class="px-4 py-2 border border-gray-300 rounded text-gray-600 hover:bg-gray-50 transition">Cancel</button>
                    <button type="submit" class="px-4 py-2 bg-purple-600 text-white rounded hover:bg-purple-700 transition">Create</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Add Regular Speaking Exam Modal -->
    <div x-show="showModal === 'addRegularSpeaking'" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50" x-cloak>
        <div class="bg-white rounded-xl p-6 w-full max-w-md shadow-2xl">
            <h3 class="text-xl font-bold mb-4 text-yellow-800">Create New Speaking Exam</h3>
            <form @submit.prevent="
                fetch('/admin/add-regular-speaking-exam', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ title: editItem.title, description: editItem.description })
                })
                .then(res => res.json())
                .then(data => {
                    if (data.success) {
                        initRegularSpeakingExams();
                        showModal = false;
                        editItem = {};
                        regularSpeakingView = 'list';
                        openRegularSpeakingExamDetail(data.exam);
                    } else {
                        alert('Error: ' + (data.error || 'Unknown error'));
                    }
                })
                .catch(err => alert('Error: ' + err.message));
            " class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Title</label>
                    <input type="text" x-model="editItem.title" placeholder="e.g., IELTS Speaking Test 12: Family & Hobbies" required class="w-full border border-gray-300 rounded-lg p-2 focus:ring-2 focus:ring-yellow-500 focus:border-yellow-500">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Description</label>
                    <textarea x-model="editItem.description" placeholder="e.g., Focuses on present tense and describing relationships." class="w-full border border-gray-300 rounded-lg p-2 h-24 resize-none focus:ring-2 focus:ring-yellow-500 focus:border-yellow-500"></textarea>
                </div>
                <div class="flex justify-end gap-2 mt-6">
                    <button type="button" @click="showModal = false; editItem = {}" class="px-4 py-2 border border-gray-300 rounded text-gray-600 hover:bg-gray-50 transition">Cancel</button>
                    <button type="submit" class="px-4 py-2 bg-yellow-600 text-white rounded hover:bg-yellow-700 transition">Create Exam</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Add ABEL -->
    <div x-show="showModal === 'addAbel'" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50" x-cloak>
        <div class="bg-white rounded-xl p-6 w-full max-w-2xl shadow-2xl max-h-[90vh] overflow-y-auto">
            <h3 class="text-xl font-bold mb-4 text-purple-800" x-text="(editItem.type === 'Writing' || editItem.type === 'Reading' || editItem.type === 'Listening' || editItem.type === 'Speaking') ? 'Create New Exam' : 'Add Question'"></h3>
            
            <!-- Writing Interface -->
            <template x-if="editItem.type === 'Writing'">
                <form action="/admin/add-abel" method="POST" enctype="multipart/form-data" class="space-y-6">
                    <input type="hidden" name="type" value="Writing">
                    <input type="hidden" name="difficulty" value="Standard">
                    <input type="hidden" name="taskNumber" value="1">
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Title</label>
                        <input type="text" name="title" placeholder="e.g., Writing exam 1" required class="w-full border p-3 rounded" x-model="editItem.title">
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Description</label>
                        <textarea name="prompt" placeholder="Enter the task description..." required class="w-full border p-3 rounded h-32" x-model="editItem.prompt"></textarea>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Upload Image (Optional)</label>
                        <div class="mt-1 flex justify-center px-6 pt-5 pb-6 border-2 border-gray-300 border-dashed rounded-md bg-gray-50">
                            <div class="space-y-1 text-center w-full">
                                <div x-show="!previewImage">
                                    <svg class="mx-auto h-12 w-12 text-gray-400" stroke="currentColor" fill="none" viewBox="0 0 48 48">
                                        <path d="M28 8H12a4 4 0 00-4 4v20m32-12v8m0 0v8a4 4 0 01-4 4H12a4 4 0 01-4-4v-4m32-4l-3.172-3.172a4 4 0 00-5.656 0L28 28M8 32l9.172-9.172a4 4 0 015.656 0L28 28m0 0l4 4m4-24h8m-4-4v8m-12 4h.02" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
                                    </svg>
                                    <div class="flex text-sm text-gray-600 justify-center">
                                        <label class="relative cursor-pointer bg-white rounded-md font-medium text-blue-600 hover:text-blue-500 focus-within:outline-none">
                                            <span>Upload a file</span>
                                            <input type="file" name="image" accept="image/*" class="sr-only" @change="handleFileUpload">
                                        </label>
                                    </div>
                                </div>
                                <div x-show="previewImage" class="relative">
                                    <img :src="previewImage" class="max-h-64 mx-auto rounded-md shadow-sm">
                                    <button type="button" @click="previewImage = null" class="absolute top-0 right-0 bg-red-500 text-white rounded-full p-1 -mt-2 -mr-2 shadow-sm hover:bg-red-600">
                                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="flex justify-end gap-2 pt-4">
                        <button type="button" @click="showModal = false; editItem = {}; previewImage = null" class="px-4 py-2 border rounded">Cancel</button>
                        <button type="submit" class="px-4 py-2 bg-purple-600 text-white rounded">Save</button>
                    </div>
                </form>
            </template>
            
            <!-- Reading Interface (Title and Description only) -->
            <template x-if="editItem.type === 'Reading'">
                <form action="/admin/add-abel" method="POST" enctype="multipart/form-data" class="space-y-6">
                    <input type="hidden" name="type" value="Reading">
                    <input type="hidden" name="difficulty" value="Standard">
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Title</label>
                        <input type="text" name="title" placeholder="e.g., Reading exam 1" required class="w-full border p-3 rounded" x-model="editItem.title">
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Description</label>
                        <textarea name="prompt" placeholder="Enter the reading passage description..." required class="w-full border p-3 rounded h-32" x-model="editItem.prompt"></textarea>
                    </div>
                    
                    <div class="flex justify-end gap-2 pt-4">
                        <button type="button" @click="showModal = false; editItem = {}; previewImage = null" class="px-4 py-2 border rounded">Cancel</button>
                        <button type="submit" class="px-4 py-2 bg-purple-600 text-white rounded">Save</button>
                    </div>
                </form>
            </template>
            
            <!-- Listening Interface (Title and Description only for creating new exam) -->
            <template x-if="editItem.type === 'Listening'">
                <form action="/admin/add-abel" method="POST" enctype="multipart/form-data" class="space-y-6">
                    <input type="hidden" name="type" value="Listening">
                    <input type="hidden" name="difficulty" value="Standard">
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Title</label>
                        <input type="text" name="title" placeholder="e.g., IELTS Practice Test 4" required class="w-full border p-3 rounded" x-model="editItem.title">
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Description</label>
                        <textarea name="prompt" placeholder="Enter a brief summary of the exam difficulty or topic..." required class="w-full border p-3 rounded h-32" x-model="editItem.prompt"></textarea>
                    </div>
                    
                    <div class="flex justify-end gap-2 pt-4">
                        <button type="button" @click="showModal = false; editItem = {}; previewImage = null" class="px-4 py-2 border rounded">Cancel</button>
                        <button type="submit" class="px-4 py-2 bg-purple-600 text-white rounded">Create</button>
                    </div>
                </form>
            </template>
            
            <!-- Speaking Interface (Title and Description only for creating new exam) -->
            <template x-if="editItem.type === 'Speaking'">
                <form action="/admin/add-abel" method="POST" enctype="multipart/form-data" class="space-y-6">
                    <input type="hidden" name="type" value="Speaking">
                    <input type="hidden" name="difficulty" value="Standard">
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Title</label>
                        <input type="text" name="title" placeholder="e.g., Speaking Test 5: Travel & Home" required class="w-full border p-3 rounded" x-model="editItem.title">
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Description</label>
                        <textarea name="prompt" placeholder="e.g., Focuses on tourism vocabulary and past tense." required class="w-full border p-3 rounded h-32" x-model="editItem.prompt"></textarea>
                    </div>
                    
                    <div class="flex justify-end gap-2 pt-4">
                        <button type="button" @click="showModal = false; editItem = {}; previewImage = null" class="px-4 py-2 border rounded">Cancel</button>
                        <button type="submit" class="px-4 py-2 bg-orange-600 text-white rounded">Create</button>
                    </div>
                </form>
            </template>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Question</label>
                        <textarea name="prompt" placeholder="Enter the question..." required class="w-full border p-3 rounded h-32" x-model="editItem.prompt"></textarea>
                    </div>
                    
                    <div class="flex justify-end gap-2 pt-4">
                        <button type="button" @click="showModal = false; editItem = {}" class="px-4 py-2 border rounded">Cancel</button>
                        <button type="submit" class="px-4 py-2 bg-purple-600 text-white rounded">Save</button>
                    </div>
                </form>
            </template>
        </div>
    </div>

    <!-- Edit ABEL Modal -->
    <div x-show="showModal === 'editAbel'" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50" x-cloak>
        <div class="bg-white rounded-xl p-6 w-full max-w-2xl shadow-2xl max-h-[90vh] overflow-y-auto">
            <h3 class="text-xl font-bold mb-4 text-purple-800">Edit Question</h3>
            
            <!-- Writing Interface -->
            <template x-if="editItem.type === 'Writing'">
                <form action="/admin/edit-abel" method="POST" enctype="multipart/form-data" class="space-y-6">
                    <input type="hidden" name="id" x-model="editItem.id">
                    <input type="hidden" name="type" value="Writing">
                    <input type="hidden" name="difficulty" :value="editItem.difficulty || 'Standard'">
                    <input type="hidden" name="taskNumber" value="1">
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Title</label>
                        <input type="text" name="title" placeholder="e.g., Writing exam 1" required class="w-full border p-3 rounded" x-model="editItem.title">
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Description</label>
                        <textarea name="prompt" placeholder="Enter the task description..." required class="w-full border p-3 rounded h-32" x-model="editItem.prompt"></textarea>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Upload Image (Optional)</label>
                        <div class="mt-1 flex justify-center px-6 pt-5 pb-6 border-2 border-gray-300 border-dashed rounded-md bg-gray-50">
                            <div class="space-y-1 text-center w-full">
                                <div x-show="!previewImage && !editItem.image">
                                    <svg class="mx-auto h-12 w-12 text-gray-400" stroke="currentColor" fill="none" viewBox="0 0 48 48">
                                        <path d="M28 8H12a4 4 0 00-4 4v20m32-12v8m0 0v8a4 4 0 01-4 4H12a4 4 0 01-4-4v-4m32-4l-3.172-3.172a4 4 0 00-5.656 0L28 28M8 32l9.172-9.172a4 4 0 015.656 0L28 28m0 0l4 4m4-24h8m-4-4v8m-12 4h.02" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
                                    </svg>
                                    <div class="flex text-sm text-gray-600 justify-center">
                                        <label class="relative cursor-pointer bg-white rounded-md font-medium text-blue-600 hover:text-blue-500 focus-within:outline-none">
                                            <span>Upload a file</span>
                                            <input type="file" name="image" accept="image/*" class="sr-only" @change="handleFileUpload">
                                        </label>
                                    </div>
                                </div>
                                <div x-show="previewImage || editItem.image" class="relative">
                                    <img :src="previewImage || editItem.image" class="max-h-64 mx-auto rounded-md shadow-sm">
                                    <button type="button" @click="previewImage = null; editItem.image = null" class="absolute top-0 right-0 bg-red-500 text-white rounded-full p-1 -mt-2 -mr-2 shadow-sm hover:bg-red-600">
                                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="flex justify-end gap-2 pt-4">
                        <button type="button" @click="showModal = false; editItem = {}; previewImage = null" class="px-4 py-2 border rounded">Cancel</button>
                        <button type="submit" class="px-4 py-2 bg-purple-600 text-white rounded">Update</button>
                    </div>
                </form>
            </template>
            
            <!-- Reading/Listening Interface -->
            <template x-if="editItem.type === 'Reading' || editItem.type === 'Listening'">
                <form action="/admin/edit-abel" method="POST" class="space-y-6">
                    <input type="hidden" name="id" x-model="editItem.id">
                    <input type="hidden" name="type" :value="editItem.type">
                    <input type="hidden" name="difficulty" :value="editItem.difficulty || 'Standard'">
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Question</label>
                        <textarea name="prompt" placeholder="Enter the question..." required class="w-full border p-3 rounded h-24" x-model="editItem.prompt"></textarea>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Option A</label>
                        <input type="text" name="optionA" placeholder="Enter option A" required class="w-full border p-3 rounded" x-model="editItem.optionA">
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Option B</label>
                        <input type="text" name="optionB" placeholder="Enter option B" required class="w-full border p-3 rounded" x-model="editItem.optionB">
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Option C</label>
                        <input type="text" name="optionC" placeholder="Enter option C" required class="w-full border p-3 rounded" x-model="editItem.optionC">
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Option D</label>
                        <input type="text" name="optionD" placeholder="Enter option D" required class="w-full border p-3 rounded" x-model="editItem.optionD">
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Correct Answer</label>
                        <select name="correctAnswer" x-model="editItem.correctAnswer" required class="w-full border p-3 rounded">
                            <option value="">Select correct answer</option>
                            <option value="1">A</option>
                            <option value="2">B</option>
                            <option value="3">C</option>
                            <option value="4">D</option>
                        </select>
                    </div>
                    
                    <div class="flex justify-end gap-2 pt-4">
                        <button type="button" @click="showModal = false; editItem = {}" class="px-4 py-2 border rounded">Cancel</button>
                        <button type="submit" class="px-4 py-2 bg-purple-600 text-white rounded">Update</button>
                    </div>
                </form>
            </template>
            
            <!-- Speaking Interface -->
            <template x-if="editItem.type === 'Speaking'">
                <form action="/admin/edit-abel" method="POST" class="space-y-6">
                    <input type="hidden" name="id" x-model="editItem.id">
                    <input type="hidden" name="type" value="Speaking">
                    <input type="hidden" name="difficulty" :value="editItem.difficulty || 'Standard'">
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Part</label>
                        <select name="part" x-model="editItem.part" required class="w-full border p-3 rounded">
                            <option value="">Select Part</option>
                            <option value="1">Part 1: Introduction and Interview</option>
                            <option value="2">Part 2: Long Turn</option>
                            <option value="3">Part 3: Discussion</option>
                        </select>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Question Number</label>
                        <select name="questionNumber" x-model="editItem.questionNumber" required class="w-full border p-3 rounded">
                            <option value="">Select Question</option>
                            <option value="1">Question 1</option>
                            <option value="2">Question 2</option>
                        </select>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Question</label>
                        <textarea name="prompt" placeholder="Enter the question..." required class="w-full border p-3 rounded h-32" x-model="editItem.prompt"></textarea>
                    </div>
                    
                    <div class="flex justify-end gap-2 pt-4">
                        <button type="button" @click="showModal = false; editItem = {}" class="px-4 py-2 border rounded">Cancel</button>
                        <button type="submit" class="px-4 py-2 bg-purple-600 text-white rounded">Update</button>
                    </div>
                </form>
            </template>
        </div>
    </div>

    <!-- Writing Exam Preview Modal -->
    <div x-show="showModal === 'writingExamPreview'" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50" x-cloak>
        <div class="bg-white rounded-xl p-6 w-full max-w-4xl shadow-2xl max-h-[90vh] overflow-y-auto">
            <h3 class="text-2xl font-bold mb-6 text-gray-900">Preview Writing Exam</h3>
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                <!-- Writing Task 1 Preview -->
                <div class="bg-white border border-gray-200 rounded-lg p-6 shadow-sm">
                    <h4 class="text-lg font-bold text-gray-900 mb-4">Writing Task 1</h4>
                    <div class="bg-gray-200 rounded-lg h-40 flex items-center justify-center mb-4 overflow-hidden">
                        <template x-if="writingTask1.previewImage || writingTask1.image">
                            <img :src="writingTask1.previewImage || writingTask1.image" alt="Writing Task 1" class="w-full h-full object-cover">
                        </template>
                        <template x-if="!writingTask1.previewImage && !writingTask1.image">
                            <span class="text-gray-500 text-lg font-medium">Writing Task 1</span>
                        </template>
                                </div>
                    <p class="text-sm text-gray-700 leading-relaxed mb-3" x-text="writingTask1.description || 'No description entered yet.'"></p>
                    <div class="text-xs text-gray-500" x-show="writingTask1.tags">
                        <span class="font-semibold">TAGS:</span> <span x-text="writingTask1.tags"></span>
                    </div>
                </div>

                <!-- Writing Task 2 Preview -->
                <div class="bg-white border border-gray-200 rounded-lg p-6 shadow-sm">
                    <h4 class="text-lg font-bold text-gray-900 mb-4">Writing Task 2</h4>
                    <div class="bg-gray-200 rounded-lg h-40 flex items-center justify-center mb-4 overflow-hidden">
                        <template x-if="writingTask2.previewImage || writingTask2.image">
                            <img :src="writingTask2.previewImage || writingTask2.image" alt="Writing Task 2" class="w-full h-full object-cover">
                        </template>
                        <template x-if="!writingTask2.previewImage && !writingTask2.image">
                            <span class="text-gray-500 text-lg font-medium">Writing Task 2</span>
                        </template>
                </div>
                    <p class="text-sm text-gray-700 leading-relaxed mb-3" x-text="writingTask2.description || 'No description entered yet.'"></p>
                    <div class="text-xs text-gray-500" x-show="writingTask2.tags">
                        <span class="font-semibold">TAGS:</span> <span x-text="writingTask2.tags"></span>
        </div>
    </div>

            <div class="flex justify-end gap-3 pt-4 border-t border-gray-200">
                <button @click="showModal = false" class="px-6 py-2 border border-gray-300 rounded-lg hover:bg-gray-50 transition">Cancel</button>
                <button @click="confirmWritingExamSave()" class="px-6 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition flex items-center gap-2">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg>
                    Confirm & Save
                                </button>
                            </div>
        </div>
    </div>

</body>
</html>